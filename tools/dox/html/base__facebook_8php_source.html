<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>RFSCMSAPIDocumentation: base_facebook.php Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">RFSCMSAPIDocumentation
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('base__facebook_8php.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">base_facebook.php</div>  </div>
</div><!--header-->
<div class="contents">
<a href="base__facebook_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php<span class="comment"></span>
<a name="l00002"></a>00002 <span class="comment">/**</span>
<a name="l00003"></a>00003 <span class="comment"> * Copyright 2011 Facebook, Inc.</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<a name="l00006"></a>00006 <span class="comment"> * not use this file except in compliance with the License. You may obtain</span>
<a name="l00007"></a>00007 <span class="comment"> * a copy of the License at</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * Unless required by applicable law or agreed to in writing, software</span>
<a name="l00012"></a>00012 <span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<a name="l00013"></a>00013 <span class="comment"> * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<a name="l00014"></a>00014 <span class="comment"> * License for the specific language governing permissions and limitations</span>
<a name="l00015"></a>00015 <span class="comment"> * under the License.</span>
<a name="l00016"></a>00016 <span class="comment"> */</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="keywordflow">if</span> (!function_exists(<span class="stringliteral">&#39;curl_init&#39;</span>)) {
<a name="l00019"></a>00019   <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception(<span class="stringliteral">&#39;Facebook needs the CURL PHP extension.&#39;</span>);
<a name="l00020"></a>00020 }
<a name="l00021"></a>00021 <span class="keywordflow">if</span> (!function_exists(<span class="stringliteral">&#39;json_decode&#39;</span>)) {
<a name="l00022"></a>00022   <span class="keywordflow">throw</span> <span class="keyword">new</span> Exception(<span class="stringliteral">&#39;Facebook needs the JSON PHP extension.&#39;</span>);
<a name="l00023"></a>00023 }
<a name="l00024"></a>00024 <span class="comment"></span>
<a name="l00025"></a>00025 <span class="comment">/**</span>
<a name="l00026"></a>00026 <span class="comment"> * Thrown when an API call returns an exception.</span>
<a name="l00027"></a>00027 <span class="comment"> *</span>
<a name="l00028"></a>00028 <span class="comment"> * @author Naitik Shah &lt;naitik@facebook.com&gt;</span>
<a name="l00029"></a>00029 <span class="comment"> */</span>
<a name="l00030"></a><a class="code" href="classFacebookApiException.html">00030</a> <span class="keyword">class </span><a class="code" href="classFacebookApiException.html" title="Copyright 2011 Facebook, Inc.">FacebookApiException</a> <span class="keyword">extends</span> Exception
<a name="l00031"></a>00031 {<span class="comment"></span>
<a name="l00032"></a>00032 <span class="comment">  /**</span>
<a name="l00033"></a>00033 <span class="comment">   * The result from the API server that represents the exception information.</span>
<a name="l00034"></a>00034 <span class="comment">   */</span>
<a name="l00035"></a><a class="code" href="classFacebookApiException.html#a7fb784ca5b949e79541f48d411cea829">00035</a>   <span class="keyword">protected</span> <a class="code" href="classFacebookApiException.html#a7fb784ca5b949e79541f48d411cea829" title="The result from the API server that represents the exception information.">$result</a>;
<a name="l00036"></a>00036 <span class="comment"></span>
<a name="l00037"></a>00037 <span class="comment">  /**</span>
<a name="l00038"></a>00038 <span class="comment">   * Make a new API Exception with the given result.</span>
<a name="l00039"></a>00039 <span class="comment">   *</span>
<a name="l00040"></a>00040 <span class="comment">   * @param array $result The result from the API server</span>
<a name="l00041"></a>00041 <span class="comment">   */</span>
<a name="l00042"></a><a class="code" href="classFacebookApiException.html#a9e40d3c27096359975b952fe04752d19">00042</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classFacebookApiException.html#a9e40d3c27096359975b952fe04752d19" title="Make a new API Exception with the given result.">__construct</a>(<a class="code" href="classFacebookApiException.html#a7fb784ca5b949e79541f48d411cea829" title="The result from the API server that represents the exception information.">$result</a>) {
<a name="l00043"></a>00043     $this-&gt;result = <a class="code" href="classFacebookApiException.html#a7fb784ca5b949e79541f48d411cea829" title="The result from the API server that represents the exception information.">$result</a>;
<a name="l00044"></a>00044 
<a name="l00045"></a>00045     $code = isset(<a class="code" href="classFacebookApiException.html#a7fb784ca5b949e79541f48d411cea829" title="The result from the API server that represents the exception information.">$result</a>[<span class="stringliteral">&#39;error_code&#39;</span>]) ? <a class="code" href="classFacebookApiException.html#a7fb784ca5b949e79541f48d411cea829" title="The result from the API server that represents the exception information.">$result</a>[<span class="stringliteral">&#39;error_code&#39;</span>] : 0;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047     <span class="keywordflow">if</span> (isset(<a class="code" href="classFacebookApiException.html#a7fb784ca5b949e79541f48d411cea829" title="The result from the API server that represents the exception information.">$result</a>[<span class="stringliteral">&#39;error_description&#39;</span>])) {
<a name="l00048"></a>00048       <span class="comment">// OAuth 2.0 Draft 10 style</span>
<a name="l00049"></a>00049       $msg = <a class="code" href="classFacebookApiException.html#a7fb784ca5b949e79541f48d411cea829" title="The result from the API server that represents the exception information.">$result</a>[<span class="stringliteral">&#39;error_description&#39;</span>];
<a name="l00050"></a>00050     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset(<a class="code" href="classFacebookApiException.html#a7fb784ca5b949e79541f48d411cea829" title="The result from the API server that represents the exception information.">$result</a>[<span class="stringliteral">&#39;error&#39;</span>]) &amp;&amp; is_array(<a class="code" href="classFacebookApiException.html#a7fb784ca5b949e79541f48d411cea829" title="The result from the API server that represents the exception information.">$result</a>[<span class="stringliteral">&#39;error&#39;</span>])) {
<a name="l00051"></a>00051       <span class="comment">// OAuth 2.0 Draft 00 style</span>
<a name="l00052"></a>00052       $msg = <a class="code" href="classFacebookApiException.html#a7fb784ca5b949e79541f48d411cea829" title="The result from the API server that represents the exception information.">$result</a>[<span class="stringliteral">&#39;error&#39;</span>][<span class="stringliteral">&#39;message&#39;</span>];
<a name="l00053"></a>00053     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset(<a class="code" href="classFacebookApiException.html#a7fb784ca5b949e79541f48d411cea829" title="The result from the API server that represents the exception information.">$result</a>[<span class="stringliteral">&#39;error_msg&#39;</span>])) {
<a name="l00054"></a>00054       <span class="comment">// Rest server style</span>
<a name="l00055"></a>00055       $msg = <a class="code" href="classFacebookApiException.html#a7fb784ca5b949e79541f48d411cea829" title="The result from the API server that represents the exception information.">$result</a>[<span class="stringliteral">&#39;error_msg&#39;</span>];
<a name="l00056"></a>00056     } <span class="keywordflow">else</span> {
<a name="l00057"></a>00057       $msg = <span class="stringliteral">&#39;Unknown Error. Check getResult()&#39;</span>;
<a name="l00058"></a>00058     }
<a name="l00059"></a>00059 
<a name="l00060"></a>00060     <a class="code" href="classFacebookApiException.html#a9e40d3c27096359975b952fe04752d19" title="Make a new API Exception with the given result.">parent::__construct</a>($msg, $code);
<a name="l00061"></a>00061   }
<a name="l00062"></a>00062 <span class="comment"></span>
<a name="l00063"></a>00063 <span class="comment">  /**</span>
<a name="l00064"></a>00064 <span class="comment">   * Return the associated result object returned by the API server.</span>
<a name="l00065"></a>00065 <span class="comment">   *</span>
<a name="l00066"></a>00066 <span class="comment">   * @return array The result from the API server</span>
<a name="l00067"></a>00067 <span class="comment">   */</span>
<a name="l00068"></a><a class="code" href="classFacebookApiException.html#ac6376ad18e5695a4ff443d4b6832f5f1">00068</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classFacebookApiException.html#ac6376ad18e5695a4ff443d4b6832f5f1" title="Return the associated result object returned by the API server.">getResult</a>() {
<a name="l00069"></a>00069     <span class="keywordflow">return</span> $this-&gt;result;
<a name="l00070"></a>00070   }
<a name="l00071"></a>00071 <span class="comment"></span>
<a name="l00072"></a>00072 <span class="comment">  /**</span>
<a name="l00073"></a>00073 <span class="comment">   * Returns the associated type for the error. This will default to</span>
<a name="l00074"></a>00074 <span class="comment">   * &#39;Exception&#39; when a type is not available.</span>
<a name="l00075"></a>00075 <span class="comment">   *</span>
<a name="l00076"></a>00076 <span class="comment">   * @return string</span>
<a name="l00077"></a>00077 <span class="comment">   */</span>
<a name="l00078"></a><a class="code" href="classFacebookApiException.html#a6b119e3ab23ac69f3f51ee90aee6e688">00078</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classFacebookApiException.html#a6b119e3ab23ac69f3f51ee90aee6e688" title="Returns the associated type for the error.">getType</a>() {
<a name="l00079"></a>00079     <span class="keywordflow">if</span> (isset($this-&gt;result[<span class="stringliteral">&#39;error&#39;</span>])) {
<a name="l00080"></a>00080       $error = $this-&gt;result[<span class="stringliteral">&#39;error&#39;</span>];
<a name="l00081"></a>00081       <span class="keywordflow">if</span> (is_string($error)) {
<a name="l00082"></a>00082         <span class="comment">// OAuth 2.0 Draft 10 style</span>
<a name="l00083"></a>00083         <span class="keywordflow">return</span> $error;
<a name="l00084"></a>00084       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_array($error)) {
<a name="l00085"></a>00085         <span class="comment">// OAuth 2.0 Draft 00 style</span>
<a name="l00086"></a>00086         <span class="keywordflow">if</span> (isset($error[<span class="stringliteral">&#39;type&#39;</span>])) {
<a name="l00087"></a>00087           <span class="keywordflow">return</span> $error[<span class="stringliteral">&#39;type&#39;</span>];
<a name="l00088"></a>00088         }
<a name="l00089"></a>00089       }
<a name="l00090"></a>00090     }
<a name="l00091"></a>00091 
<a name="l00092"></a>00092     <span class="keywordflow">return</span> <span class="stringliteral">&#39;Exception&#39;</span>;
<a name="l00093"></a>00093   }
<a name="l00094"></a>00094 <span class="comment"></span>
<a name="l00095"></a>00095 <span class="comment">  /**</span>
<a name="l00096"></a>00096 <span class="comment">   * To make debugging easier.</span>
<a name="l00097"></a>00097 <span class="comment">   *</span>
<a name="l00098"></a>00098 <span class="comment">   * @return string The string representation of the error</span>
<a name="l00099"></a>00099 <span class="comment">   */</span>
<a name="l00100"></a><a class="code" href="classFacebookApiException.html#a9c262b52fe807aad1c2770a0ad2ee919">00100</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classFacebookApiException.html#a9c262b52fe807aad1c2770a0ad2ee919" title="To make debugging easier.">__toString</a>() {
<a name="l00101"></a>00101     $str = $this-&gt;<a class="code" href="classFacebookApiException.html#a6b119e3ab23ac69f3f51ee90aee6e688" title="Returns the associated type for the error.">getType</a>() . <span class="stringliteral">&#39;: &#39;</span>;
<a name="l00102"></a>00102     <span class="keywordflow">if</span> ($this-&gt;code != 0) {
<a name="l00103"></a>00103       $str .= $this-&gt;code . <span class="stringliteral">&#39;: &#39;</span>;
<a name="l00104"></a>00104     }
<a name="l00105"></a>00105     <span class="keywordflow">return</span> $str . $this-&gt;message;
<a name="l00106"></a>00106   }
<a name="l00107"></a>00107 }
<a name="l00108"></a>00108 <span class="comment"></span>
<a name="l00109"></a>00109 <span class="comment">/**</span>
<a name="l00110"></a>00110 <span class="comment"> * Provides access to the Facebook Platform.  This class provides</span>
<a name="l00111"></a>00111 <span class="comment"> * a majority of the functionality needed, but the class is abstract</span>
<a name="l00112"></a>00112 <span class="comment"> * because it is designed to be sub-classed.  The subclass must</span>
<a name="l00113"></a>00113 <span class="comment"> * implement the four abstract methods listed at the bottom of</span>
<a name="l00114"></a>00114 <span class="comment"> * the file.</span>
<a name="l00115"></a>00115 <span class="comment"> *</span>
<a name="l00116"></a>00116 <span class="comment"> * @author Naitik Shah &lt;naitik@facebook.com&gt;</span>
<a name="l00117"></a>00117 <span class="comment"> */</span>
<a name="l00118"></a><a class="code" href="classBaseFacebook.html">00118</a> <span class="keyword">abstract</span> <span class="keyword">class </span><a class="code" href="classBaseFacebook.html" title="Provides access to the Facebook Platform.">BaseFacebook</a>
<a name="l00119"></a>00119 {<span class="comment"></span>
<a name="l00120"></a>00120 <span class="comment">  /**</span>
<a name="l00121"></a>00121 <span class="comment">   * Version.</span>
<a name="l00122"></a>00122 <span class="comment">   */</span>
<a name="l00123"></a><a class="code" href="classBaseFacebook.html#ae0ee825ecd33e197a890c9b47ee14bd8">00123</a>   <span class="keyword">const</span> <a class="code" href="classBaseFacebook.html#ae0ee825ecd33e197a890c9b47ee14bd8" title="Version.">VERSION</a> = <span class="stringliteral">&#39;3.2.1&#39;</span>;
<a name="l00124"></a>00124 <span class="comment"></span>
<a name="l00125"></a>00125 <span class="comment">  /**</span>
<a name="l00126"></a>00126 <span class="comment">   * Signed Request Algorithm.</span>
<a name="l00127"></a>00127 <span class="comment">   */</span>
<a name="l00128"></a><a class="code" href="classBaseFacebook.html#a91b50b70a2d503d402d67ac8398d34b0">00128</a>   <span class="keyword">const</span> <a class="code" href="classBaseFacebook.html#a91b50b70a2d503d402d67ac8398d34b0" title="Signed Request Algorithm.">SIGNED_REQUEST_ALGORITHM</a> = <span class="stringliteral">&#39;HMAC-SHA256&#39;</span>;
<a name="l00129"></a>00129 <span class="comment"></span>
<a name="l00130"></a>00130 <span class="comment">  /**</span>
<a name="l00131"></a>00131 <span class="comment">   * Default options for curl.</span>
<a name="l00132"></a>00132 <span class="comment">   */</span>
<a name="l00133"></a><a class="code" href="classBaseFacebook.html#ad48ad58bc8120acf03f199bb100be6dd">00133</a>   <span class="keyword">public</span> <span class="keyword">static</span> <a class="code" href="classBaseFacebook.html#ad48ad58bc8120acf03f199bb100be6dd" title="Default options for curl.">$CURL_OPTS</a> = array(
<a name="l00134"></a>00134     CURLOPT_CONNECTTIMEOUT =&gt; 10,
<a name="l00135"></a>00135     CURLOPT_RETURNTRANSFER =&gt; <span class="keyword">true</span>,
<a name="l00136"></a>00136     CURLOPT_TIMEOUT        =&gt; 60,
<a name="l00137"></a>00137     CURLOPT_USERAGENT      =&gt; <span class="stringliteral">&#39;facebook-php-3.2&#39;</span>,
<a name="l00138"></a>00138   );
<a name="l00139"></a>00139 <span class="comment"></span>
<a name="l00140"></a>00140 <span class="comment">  /**</span>
<a name="l00141"></a>00141 <span class="comment">   * List of query parameters that get automatically dropped when rebuilding</span>
<a name="l00142"></a>00142 <span class="comment">   * the current URL.</span>
<a name="l00143"></a>00143 <span class="comment">   */</span>
<a name="l00144"></a><a class="code" href="classBaseFacebook.html#a463779b23fc993650d18af395979501d">00144</a>   <span class="keyword">protected</span> <span class="keyword">static</span> <a class="code" href="classBaseFacebook.html#a463779b23fc993650d18af395979501d" title="List of query parameters that get automatically dropped when rebuilding the current URL...">$DROP_QUERY_PARAMS</a> = array(
<a name="l00145"></a>00145     <span class="stringliteral">&#39;code&#39;</span>,
<a name="l00146"></a>00146     <span class="stringliteral">&#39;state&#39;</span>,
<a name="l00147"></a>00147     <span class="stringliteral">&#39;signed_request&#39;</span>,
<a name="l00148"></a>00148   );
<a name="l00149"></a>00149 <span class="comment"></span>
<a name="l00150"></a>00150 <span class="comment">  /**</span>
<a name="l00151"></a>00151 <span class="comment">   * Maps aliases to Facebook domains.</span>
<a name="l00152"></a>00152 <span class="comment">   */</span>
<a name="l00153"></a><a class="code" href="classBaseFacebook.html#a154dee18518e85547854c5d51f77e314">00153</a>   <span class="keyword">public</span> <span class="keyword">static</span> <a class="code" href="classBaseFacebook.html#a154dee18518e85547854c5d51f77e314" title="Maps aliases to Facebook domains.">$DOMAIN_MAP</a> = array(
<a name="l00154"></a>00154     <span class="stringliteral">&#39;api&#39;</span>         =&gt; <span class="stringliteral">&#39;https://api.facebook.com/&#39;</span>,
<a name="l00155"></a>00155     <span class="stringliteral">&#39;api_video&#39;</span>   =&gt; <span class="stringliteral">&#39;https://api-video.facebook.com/&#39;</span>,
<a name="l00156"></a>00156     <span class="stringliteral">&#39;api_read&#39;</span>    =&gt; <span class="stringliteral">&#39;https://api-read.facebook.com/&#39;</span>,
<a name="l00157"></a>00157     <span class="stringliteral">&#39;graph&#39;</span>       =&gt; <span class="stringliteral">&#39;https://graph.facebook.com/&#39;</span>,
<a name="l00158"></a>00158     <span class="stringliteral">&#39;graph_video&#39;</span> =&gt; <span class="stringliteral">&#39;https://graph-video.facebook.com/&#39;</span>,
<a name="l00159"></a>00159     <span class="stringliteral">&#39;www&#39;</span>         =&gt; <span class="stringliteral">&#39;https://www.facebook.com/&#39;</span>,
<a name="l00160"></a>00160   );
<a name="l00161"></a>00161 <span class="comment"></span>
<a name="l00162"></a>00162 <span class="comment">  /**</span>
<a name="l00163"></a>00163 <span class="comment">   * The Application ID.</span>
<a name="l00164"></a>00164 <span class="comment">   *</span>
<a name="l00165"></a>00165 <span class="comment">   * @var string</span>
<a name="l00166"></a>00166 <span class="comment">   */</span>
<a name="l00167"></a><a class="code" href="classBaseFacebook.html#aa74008ce774d3376823e590fe369adf4">00167</a>   <span class="keyword">protected</span> <a class="code" href="classBaseFacebook.html#aa74008ce774d3376823e590fe369adf4">$appId</a>;
<a name="l00168"></a>00168 <span class="comment"></span>
<a name="l00169"></a>00169 <span class="comment">  /**</span>
<a name="l00170"></a>00170 <span class="comment">   * The Application App Secret.</span>
<a name="l00171"></a>00171 <span class="comment">   *</span>
<a name="l00172"></a>00172 <span class="comment">   * @var string</span>
<a name="l00173"></a>00173 <span class="comment">   */</span>
<a name="l00174"></a><a class="code" href="classBaseFacebook.html#af30d8846ad63ea8ca4c793f739dc70d3">00174</a>   <span class="keyword">protected</span> <a class="code" href="classBaseFacebook.html#af30d8846ad63ea8ca4c793f739dc70d3">$appSecret</a>;
<a name="l00175"></a>00175 <span class="comment"></span>
<a name="l00176"></a>00176 <span class="comment">  /**</span>
<a name="l00177"></a>00177 <span class="comment">   * The ID of the Facebook user, or 0 if the user is logged out.</span>
<a name="l00178"></a>00178 <span class="comment">   *</span>
<a name="l00179"></a>00179 <span class="comment">   * @var integer</span>
<a name="l00180"></a>00180 <span class="comment">   */</span>
<a name="l00181"></a><a class="code" href="classBaseFacebook.html#a3db38309d6b663c38ec162c5f407e96a">00181</a>   <span class="keyword">protected</span> <a class="code" href="classBaseFacebook.html#a3db38309d6b663c38ec162c5f407e96a">$user</a>;
<a name="l00182"></a>00182 <span class="comment"></span>
<a name="l00183"></a>00183 <span class="comment">  /**</span>
<a name="l00184"></a>00184 <span class="comment">   * The data from the signed_request token.</span>
<a name="l00185"></a>00185 <span class="comment">   */</span>
<a name="l00186"></a><a class="code" href="classBaseFacebook.html#a90c6ec44757d540ffe1539f512af7469">00186</a>   <span class="keyword">protected</span> <a class="code" href="classBaseFacebook.html#a90c6ec44757d540ffe1539f512af7469" title="The data from the signed_request token.">$signedRequest</a>;
<a name="l00187"></a>00187 <span class="comment"></span>
<a name="l00188"></a>00188 <span class="comment">  /**</span>
<a name="l00189"></a>00189 <span class="comment">   * A CSRF state variable to assist in the defense against CSRF attacks.</span>
<a name="l00190"></a>00190 <span class="comment">   */</span>
<a name="l00191"></a><a class="code" href="classBaseFacebook.html#a8c3903cc0e9a12c87dfae721648491a2">00191</a>   <span class="keyword">protected</span> <a class="code" href="classBaseFacebook.html#a8c3903cc0e9a12c87dfae721648491a2" title="A CSRF state variable to assist in the defense against CSRF attacks.">$state</a>;
<a name="l00192"></a>00192 <span class="comment"></span>
<a name="l00193"></a>00193 <span class="comment">  /**</span>
<a name="l00194"></a>00194 <span class="comment">   * The OAuth access token received in exchange for a valid authorization</span>
<a name="l00195"></a>00195 <span class="comment">   * code.  null means the access token has yet to be determined.</span>
<a name="l00196"></a>00196 <span class="comment">   *</span>
<a name="l00197"></a>00197 <span class="comment">   * @var string</span>
<a name="l00198"></a>00198 <span class="comment">   */</span>
<a name="l00199"></a><a class="code" href="classBaseFacebook.html#ac2d8605e06b743693a58baccdcdfc300">00199</a>   <span class="keyword">protected</span> <a class="code" href="classBaseFacebook.html#ac2d8605e06b743693a58baccdcdfc300">$accessToken</a> = null;
<a name="l00200"></a>00200 <span class="comment"></span>
<a name="l00201"></a>00201 <span class="comment">  /**</span>
<a name="l00202"></a>00202 <span class="comment">   * Indicates if the CURL based @ syntax for file uploads is enabled.</span>
<a name="l00203"></a>00203 <span class="comment">   *</span>
<a name="l00204"></a>00204 <span class="comment">   * @var boolean</span>
<a name="l00205"></a>00205 <span class="comment">   */</span>
<a name="l00206"></a><a class="code" href="classBaseFacebook.html#a9ea5d52eb0f9a31676155bf5b22517ad">00206</a>   <span class="keyword">protected</span> <a class="code" href="classBaseFacebook.html#a9ea5d52eb0f9a31676155bf5b22517ad">$fileUploadSupport</a> = <span class="keyword">false</span>;
<a name="l00207"></a>00207 <span class="comment"></span>
<a name="l00208"></a>00208 <span class="comment">  /**</span>
<a name="l00209"></a>00209 <span class="comment">   * Indicates if we trust HTTP_X_FORWARDED_* headers.</span>
<a name="l00210"></a>00210 <span class="comment">   *</span>
<a name="l00211"></a>00211 <span class="comment">   * @var boolean</span>
<a name="l00212"></a>00212 <span class="comment">   */</span>
<a name="l00213"></a><a class="code" href="classBaseFacebook.html#afd1c201d6088d9175379ad78b88444e0">00213</a>   <span class="keyword">protected</span> <a class="code" href="classBaseFacebook.html#afd1c201d6088d9175379ad78b88444e0">$trustForwarded</a> = <span class="keyword">false</span>;
<a name="l00214"></a>00214 <span class="comment"></span>
<a name="l00215"></a>00215 <span class="comment">  /**</span>
<a name="l00216"></a>00216 <span class="comment">   * Initialize a Facebook Application.</span>
<a name="l00217"></a>00217 <span class="comment">   *</span>
<a name="l00218"></a>00218 <span class="comment">   * The configuration:</span>
<a name="l00219"></a>00219 <span class="comment">   * - appId: the application ID</span>
<a name="l00220"></a>00220 <span class="comment">   * - secret: the application secret</span>
<a name="l00221"></a>00221 <span class="comment">   * - fileUpload: (optional) boolean indicating if file uploads are enabled</span>
<a name="l00222"></a>00222 <span class="comment">   *</span>
<a name="l00223"></a>00223 <span class="comment">   * @param array $config The application configuration</span>
<a name="l00224"></a>00224 <span class="comment">   */</span>
<a name="l00225"></a><a class="code" href="classBaseFacebook.html#af8ca4863484827e521f5052f5dfed642">00225</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#af8ca4863484827e521f5052f5dfed642" title="Initialize a Facebook Application.">__construct</a>($config) {
<a name="l00226"></a>00226     $this-&gt;<a class="code" href="classBaseFacebook.html#a4691675e86f0fdba08118a0a50d16999" title="Set the Application ID.">setAppId</a>($config[<span class="stringliteral">&#39;appId&#39;</span>]);
<a name="l00227"></a>00227     $this-&gt;<a class="code" href="classBaseFacebook.html#ac25a51d73a78e3d3308523fc03c93a05" title="Set the App Secret.">setAppSecret</a>($config[<span class="stringliteral">&#39;secret&#39;</span>]);
<a name="l00228"></a>00228     <span class="keywordflow">if</span> (isset($config[<span class="stringliteral">&#39;fileUpload&#39;</span>])) {
<a name="l00229"></a>00229       $this-&gt;<a class="code" href="classBaseFacebook.html#a9cd44296e92bd602f54c26d613decefc" title="Set the file upload support status.">setFileUploadSupport</a>($config[<span class="stringliteral">&#39;fileUpload&#39;</span>]);
<a name="l00230"></a>00230     }
<a name="l00231"></a>00231     <span class="keywordflow">if</span> (isset($config[<span class="stringliteral">&#39;trustForwarded&#39;</span>]) &amp;&amp; $config[<span class="stringliteral">&#39;trustForwarded&#39;</span>]) {
<a name="l00232"></a>00232       $this-&gt;trustForwarded = <span class="keyword">true</span>;
<a name="l00233"></a>00233     }
<a name="l00234"></a>00234     <a class="code" href="classBaseFacebook.html#a8c3903cc0e9a12c87dfae721648491a2" title="A CSRF state variable to assist in the defense against CSRF attacks.">$state</a> = $this-&gt;<a class="code" href="classBaseFacebook.html#ad383ccec6f7433c2ab9bb50550df2ce6" title="Get the data for $key, persisted by BaseFacebook::setPersistentData()">getPersistentData</a>(<span class="stringliteral">&#39;state&#39;</span>);
<a name="l00235"></a>00235     <span class="keywordflow">if</span> (!empty(<a class="code" href="classBaseFacebook.html#a8c3903cc0e9a12c87dfae721648491a2" title="A CSRF state variable to assist in the defense against CSRF attacks.">$state</a>)) {
<a name="l00236"></a>00236       $this-&gt;state = <a class="code" href="classBaseFacebook.html#a8c3903cc0e9a12c87dfae721648491a2" title="A CSRF state variable to assist in the defense against CSRF attacks.">$state</a>;
<a name="l00237"></a>00237     }
<a name="l00238"></a>00238   }
<a name="l00239"></a>00239 <span class="comment"></span>
<a name="l00240"></a>00240 <span class="comment">  /**</span>
<a name="l00241"></a>00241 <span class="comment">   * Set the Application ID.</span>
<a name="l00242"></a>00242 <span class="comment">   *</span>
<a name="l00243"></a>00243 <span class="comment">   * @param string $appId The Application ID</span>
<a name="l00244"></a>00244 <span class="comment">   * @return BaseFacebook</span>
<a name="l00245"></a>00245 <span class="comment">   */</span>
<a name="l00246"></a><a class="code" href="classBaseFacebook.html#a4691675e86f0fdba08118a0a50d16999">00246</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a4691675e86f0fdba08118a0a50d16999" title="Set the Application ID.">setAppId</a>(<a class="code" href="classBaseFacebook.html#aa74008ce774d3376823e590fe369adf4">$appId</a>) {
<a name="l00247"></a>00247     $this-&gt;appId = <a class="code" href="classBaseFacebook.html#aa74008ce774d3376823e590fe369adf4">$appId</a>;
<a name="l00248"></a>00248     <span class="keywordflow">return</span> $this;
<a name="l00249"></a>00249   }
<a name="l00250"></a>00250 <span class="comment"></span>
<a name="l00251"></a>00251 <span class="comment">  /**</span>
<a name="l00252"></a>00252 <span class="comment">   * Get the Application ID.</span>
<a name="l00253"></a>00253 <span class="comment">   *</span>
<a name="l00254"></a>00254 <span class="comment">   * @return string the Application ID</span>
<a name="l00255"></a>00255 <span class="comment">   */</span>
<a name="l00256"></a><a class="code" href="classBaseFacebook.html#a1a3ad028a497dede716cb101f779a15c">00256</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a1a3ad028a497dede716cb101f779a15c" title="Get the Application ID.">getAppId</a>() {
<a name="l00257"></a>00257     <span class="keywordflow">return</span> $this-&gt;appId;
<a name="l00258"></a>00258   }
<a name="l00259"></a>00259 <span class="comment"></span>
<a name="l00260"></a>00260 <span class="comment">  /**</span>
<a name="l00261"></a>00261 <span class="comment">   * Set the App Secret.</span>
<a name="l00262"></a>00262 <span class="comment">   *</span>
<a name="l00263"></a>00263 <span class="comment">   * @param string $apiSecret The App Secret</span>
<a name="l00264"></a>00264 <span class="comment">   * @return BaseFacebook</span>
<a name="l00265"></a>00265 <span class="comment">   * @deprecated</span>
<a name="l00266"></a>00266 <span class="comment">   */</span>
<a name="l00267"></a><a class="code" href="classBaseFacebook.html#afafa43cb0a481b084ae523a04e816016">00267</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#afafa43cb0a481b084ae523a04e816016" title="Set the App Secret.">setApiSecret</a>($apiSecret) {
<a name="l00268"></a>00268     $this-&gt;<a class="code" href="classBaseFacebook.html#ac25a51d73a78e3d3308523fc03c93a05" title="Set the App Secret.">setAppSecret</a>($apiSecret);
<a name="l00269"></a>00269     <span class="keywordflow">return</span> $this;
<a name="l00270"></a>00270   }
<a name="l00271"></a>00271 <span class="comment"></span>
<a name="l00272"></a>00272 <span class="comment">  /**</span>
<a name="l00273"></a>00273 <span class="comment">   * Set the App Secret.</span>
<a name="l00274"></a>00274 <span class="comment">   *</span>
<a name="l00275"></a>00275 <span class="comment">   * @param string $appSecret The App Secret</span>
<a name="l00276"></a>00276 <span class="comment">   * @return BaseFacebook</span>
<a name="l00277"></a>00277 <span class="comment">   */</span>
<a name="l00278"></a><a class="code" href="classBaseFacebook.html#ac25a51d73a78e3d3308523fc03c93a05">00278</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#ac25a51d73a78e3d3308523fc03c93a05" title="Set the App Secret.">setAppSecret</a>(<a class="code" href="classBaseFacebook.html#af30d8846ad63ea8ca4c793f739dc70d3">$appSecret</a>) {
<a name="l00279"></a>00279     $this-&gt;appSecret = <a class="code" href="classBaseFacebook.html#af30d8846ad63ea8ca4c793f739dc70d3">$appSecret</a>;
<a name="l00280"></a>00280     <span class="keywordflow">return</span> $this;
<a name="l00281"></a>00281   }
<a name="l00282"></a>00282 <span class="comment"></span>
<a name="l00283"></a>00283 <span class="comment">  /**</span>
<a name="l00284"></a>00284 <span class="comment">   * Get the App Secret.</span>
<a name="l00285"></a>00285 <span class="comment">   *</span>
<a name="l00286"></a>00286 <span class="comment">   * @return string the App Secret</span>
<a name="l00287"></a>00287 <span class="comment">   * @deprecated</span>
<a name="l00288"></a>00288 <span class="comment">   */</span>
<a name="l00289"></a><a class="code" href="classBaseFacebook.html#ab97bde45113f0c14d1c42c154e39ecf5">00289</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#ab97bde45113f0c14d1c42c154e39ecf5" title="Get the App Secret.">getApiSecret</a>() {
<a name="l00290"></a>00290     <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classBaseFacebook.html#ae53e6a3cfd3b6ca1dba5c1f5568720ec" title="Get the App Secret.">getAppSecret</a>();
<a name="l00291"></a>00291   }
<a name="l00292"></a>00292 <span class="comment"></span>
<a name="l00293"></a>00293 <span class="comment">  /**</span>
<a name="l00294"></a>00294 <span class="comment">   * Get the App Secret.</span>
<a name="l00295"></a>00295 <span class="comment">   *</span>
<a name="l00296"></a>00296 <span class="comment">   * @return string the App Secret</span>
<a name="l00297"></a>00297 <span class="comment">   */</span>
<a name="l00298"></a><a class="code" href="classBaseFacebook.html#ae53e6a3cfd3b6ca1dba5c1f5568720ec">00298</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#ae53e6a3cfd3b6ca1dba5c1f5568720ec" title="Get the App Secret.">getAppSecret</a>() {
<a name="l00299"></a>00299     <span class="keywordflow">return</span> $this-&gt;appSecret;
<a name="l00300"></a>00300   }
<a name="l00301"></a>00301 <span class="comment"></span>
<a name="l00302"></a>00302 <span class="comment">  /**</span>
<a name="l00303"></a>00303 <span class="comment">   * Set the file upload support status.</span>
<a name="l00304"></a>00304 <span class="comment">   *</span>
<a name="l00305"></a>00305 <span class="comment">   * @param boolean $fileUploadSupport The file upload support status.</span>
<a name="l00306"></a>00306 <span class="comment">   * @return BaseFacebook</span>
<a name="l00307"></a>00307 <span class="comment">   */</span>
<a name="l00308"></a><a class="code" href="classBaseFacebook.html#a9cd44296e92bd602f54c26d613decefc">00308</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a9cd44296e92bd602f54c26d613decefc" title="Set the file upload support status.">setFileUploadSupport</a>(<a class="code" href="classBaseFacebook.html#a9ea5d52eb0f9a31676155bf5b22517ad">$fileUploadSupport</a>) {
<a name="l00309"></a>00309     $this-&gt;fileUploadSupport = <a class="code" href="classBaseFacebook.html#a9ea5d52eb0f9a31676155bf5b22517ad">$fileUploadSupport</a>;
<a name="l00310"></a>00310     <span class="keywordflow">return</span> $this;
<a name="l00311"></a>00311   }
<a name="l00312"></a>00312 <span class="comment"></span>
<a name="l00313"></a>00313 <span class="comment">  /**</span>
<a name="l00314"></a>00314 <span class="comment">   * Get the file upload support status.</span>
<a name="l00315"></a>00315 <span class="comment">   *</span>
<a name="l00316"></a>00316 <span class="comment">   * @return boolean true if and only if the server supports file upload.</span>
<a name="l00317"></a>00317 <span class="comment">   */</span>
<a name="l00318"></a><a class="code" href="classBaseFacebook.html#a339321887bccd3b1ebc79c433ed97409">00318</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a339321887bccd3b1ebc79c433ed97409" title="Get the file upload support status.">getFileUploadSupport</a>() {
<a name="l00319"></a>00319     <span class="keywordflow">return</span> $this-&gt;fileUploadSupport;
<a name="l00320"></a>00320   }
<a name="l00321"></a>00321 <span class="comment"></span>
<a name="l00322"></a>00322 <span class="comment">  /**</span>
<a name="l00323"></a>00323 <span class="comment">   * DEPRECATED! Please use getFileUploadSupport instead.</span>
<a name="l00324"></a>00324 <span class="comment">   *</span>
<a name="l00325"></a>00325 <span class="comment">   * Get the file upload support status.</span>
<a name="l00326"></a>00326 <span class="comment">   *</span>
<a name="l00327"></a>00327 <span class="comment">   * @return boolean true if and only if the server supports file upload.</span>
<a name="l00328"></a>00328 <span class="comment">   */</span>
<a name="l00329"></a><a class="code" href="classBaseFacebook.html#a21f5271bcb490f3c415923ce956d61ad">00329</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a21f5271bcb490f3c415923ce956d61ad" title="DEPRECATED! Please use getFileUploadSupport instead.">useFileUploadSupport</a>() {
<a name="l00330"></a>00330     <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classBaseFacebook.html#a339321887bccd3b1ebc79c433ed97409" title="Get the file upload support status.">getFileUploadSupport</a>();
<a name="l00331"></a>00331   }
<a name="l00332"></a>00332 <span class="comment"></span>
<a name="l00333"></a>00333 <span class="comment">  /**</span>
<a name="l00334"></a>00334 <span class="comment">   * Sets the access token for api calls.  Use this if you get</span>
<a name="l00335"></a>00335 <span class="comment">   * your access token by other means and just want the SDK</span>
<a name="l00336"></a>00336 <span class="comment">   * to use it.</span>
<a name="l00337"></a>00337 <span class="comment">   *</span>
<a name="l00338"></a>00338 <span class="comment">   * @param string $access_token an access token.</span>
<a name="l00339"></a>00339 <span class="comment">   * @return BaseFacebook</span>
<a name="l00340"></a>00340 <span class="comment">   */</span>
<a name="l00341"></a><a class="code" href="classBaseFacebook.html#a3844fd3db938af8c4d37ed1edeea3ed5">00341</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a3844fd3db938af8c4d37ed1edeea3ed5" title="Sets the access token for api calls.">setAccessToken</a>($access_token) {
<a name="l00342"></a>00342     $this-&gt;accessToken = $access_token;
<a name="l00343"></a>00343     <span class="keywordflow">return</span> $this;
<a name="l00344"></a>00344   }
<a name="l00345"></a>00345 <span class="comment"></span>
<a name="l00346"></a>00346 <span class="comment">  /**</span>
<a name="l00347"></a>00347 <span class="comment">   * Extend an access token, while removing the short-lived token that might</span>
<a name="l00348"></a>00348 <span class="comment">   * have been generated via client-side flow. Thanks to http://bit.ly/b0Pt0H</span>
<a name="l00349"></a>00349 <span class="comment">   * for the workaround.</span>
<a name="l00350"></a>00350 <span class="comment">   */</span>
<a name="l00351"></a><a class="code" href="classBaseFacebook.html#ae3043ae251526169b4780a569d8f6e2f">00351</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#ae3043ae251526169b4780a569d8f6e2f" title="Extend an access token, while removing the short-lived token that might have been generated via clien...">setExtendedAccessToken</a>() {
<a name="l00352"></a>00352     <span class="keywordflow">try</span> {
<a name="l00353"></a>00353       <span class="comment">// need to circumvent json_decode by calling _oauthRequest</span>
<a name="l00354"></a>00354       <span class="comment">// directly, since response isn&#39;t JSON format.</span>
<a name="l00355"></a>00355       $access_token_response = $this-&gt;<a class="code" href="classBaseFacebook.html#a87925b6d625110ec3aab4bad3100d4d3" title="Make a OAuth Request.">_oauthRequest</a>(
<a name="l00356"></a>00356         $this-&gt;<a class="code" href="classBaseFacebook.html#a40ca413355e37b68c3649839769bda2b" title="Build the URL for given domain alias, path and parameters.">getUrl</a>(<span class="stringliteral">&#39;graph&#39;</span>, <span class="stringliteral">&#39;/oauth/access_token&#39;</span>),
<a name="l00357"></a>00357         $params = array(
<a name="l00358"></a>00358           <span class="stringliteral">&#39;client_id&#39;</span> =&gt; $this-&gt;<a class="code" href="classBaseFacebook.html#a1a3ad028a497dede716cb101f779a15c" title="Get the Application ID.">getAppId</a>(),
<a name="l00359"></a>00359           <span class="stringliteral">&#39;client_secret&#39;</span> =&gt; $this-&gt;<a class="code" href="classBaseFacebook.html#ae53e6a3cfd3b6ca1dba5c1f5568720ec" title="Get the App Secret.">getAppSecret</a>(),
<a name="l00360"></a>00360           <span class="stringliteral">&#39;grant_type&#39;</span> =&gt; <span class="stringliteral">&#39;fb_exchange_token&#39;</span>,
<a name="l00361"></a>00361           <span class="stringliteral">&#39;fb_exchange_token&#39;</span> =&gt; $this-&gt;<a class="code" href="classBaseFacebook.html#a1cdac89b20b87c2c2a20137e5e7a8f17" title="Determines the access token that should be used for API calls.">getAccessToken</a>(),
<a name="l00362"></a>00362         )
<a name="l00363"></a>00363       );
<a name="l00364"></a>00364     }
<a name="l00365"></a>00365     <span class="keywordflow">catch</span> (<a class="code" href="classFacebookApiException.html" title="Copyright 2011 Facebook, Inc.">FacebookApiException</a> $e) {
<a name="l00366"></a>00366       <span class="comment">// most likely that user very recently revoked authorization.</span>
<a name="l00367"></a>00367       <span class="comment">// In any event, we don&#39;t have an access token, so say so.</span>
<a name="l00368"></a>00368       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00369"></a>00369     }
<a name="l00370"></a>00370   
<a name="l00371"></a>00371     <span class="keywordflow">if</span> (empty($access_token_response)) {
<a name="l00372"></a>00372       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00373"></a>00373     }
<a name="l00374"></a>00374       
<a name="l00375"></a>00375     $response_params = array();
<a name="l00376"></a>00376     parse_str($access_token_response, $response_params);
<a name="l00377"></a>00377     
<a name="l00378"></a>00378     <span class="keywordflow">if</span> (!isset($response_params[<span class="stringliteral">&#39;access_token&#39;</span>])) {
<a name="l00379"></a>00379       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00380"></a>00380     }
<a name="l00381"></a>00381     
<a name="l00382"></a>00382     $this-&gt;<a class="code" href="classBaseFacebook.html#a4235356d20fcc14a74c1073b59948b65" title="Destroy the current session.">destroySession</a>();
<a name="l00383"></a>00383     
<a name="l00384"></a>00384     $this-&gt;<a class="code" href="classBaseFacebook.html#a26198ff065bea23f358854facbafa7db" title="Each of the following four methods should be overridden in a concrete subclass, as they are in the pr...">setPersistentData</a>(
<a name="l00385"></a>00385       <span class="stringliteral">&#39;access_token&#39;</span>, $response_params[<span class="stringliteral">&#39;access_token&#39;</span>]
<a name="l00386"></a>00386     );
<a name="l00387"></a>00387   }
<a name="l00388"></a>00388 <span class="comment"></span>
<a name="l00389"></a>00389 <span class="comment">  /**</span>
<a name="l00390"></a>00390 <span class="comment">   * Determines the access token that should be used for API calls.</span>
<a name="l00391"></a>00391 <span class="comment">   * The first time this is called, $this-&gt;accessToken is set equal</span>
<a name="l00392"></a>00392 <span class="comment">   * to either a valid user access token, or it&#39;s set to the application</span>
<a name="l00393"></a>00393 <span class="comment">   * access token if a valid user access token wasn&#39;t available.  Subsequent</span>
<a name="l00394"></a>00394 <span class="comment">   * calls return whatever the first call returned.</span>
<a name="l00395"></a>00395 <span class="comment">   *</span>
<a name="l00396"></a>00396 <span class="comment">   * @return string The access token</span>
<a name="l00397"></a>00397 <span class="comment">   */</span>
<a name="l00398"></a><a class="code" href="classBaseFacebook.html#a1cdac89b20b87c2c2a20137e5e7a8f17">00398</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a1cdac89b20b87c2c2a20137e5e7a8f17" title="Determines the access token that should be used for API calls.">getAccessToken</a>() {
<a name="l00399"></a>00399     <span class="keywordflow">if</span> ($this-&gt;accessToken !== null) {
<a name="l00400"></a>00400       <span class="comment">// we&#39;ve done this already and cached it.  Just return.</span>
<a name="l00401"></a>00401       <span class="keywordflow">return</span> $this-&gt;accessToken;
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="comment">// first establish access token to be the application</span>
<a name="l00405"></a>00405     <span class="comment">// access token, in case we navigate to the /oauth/access_token</span>
<a name="l00406"></a>00406     <span class="comment">// endpoint, where SOME access token is required.</span>
<a name="l00407"></a>00407     $this-&gt;<a class="code" href="classBaseFacebook.html#a3844fd3db938af8c4d37ed1edeea3ed5" title="Sets the access token for api calls.">setAccessToken</a>($this-&gt;<a class="code" href="classBaseFacebook.html#a18b991618948872f3f350ee088fea74d" title="Returns the access token that should be used for logged out users when no authorization code is avail...">getApplicationAccessToken</a>());
<a name="l00408"></a>00408     $user_access_token = $this-&gt;<a class="code" href="classBaseFacebook.html#afe9aab209768e4d4cc4c959f4dff4310" title="Determines and returns the user access token, first using the signed request if present, and then falling back on the authorization code if present.">getUserAccessToken</a>();
<a name="l00409"></a>00409     <span class="keywordflow">if</span> ($user_access_token) {
<a name="l00410"></a>00410       $this-&gt;<a class="code" href="classBaseFacebook.html#a3844fd3db938af8c4d37ed1edeea3ed5" title="Sets the access token for api calls.">setAccessToken</a>($user_access_token);
<a name="l00411"></a>00411     }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     <span class="keywordflow">return</span> $this-&gt;accessToken;
<a name="l00414"></a>00414   }
<a name="l00415"></a>00415 <span class="comment"></span>
<a name="l00416"></a>00416 <span class="comment">  /**</span>
<a name="l00417"></a>00417 <span class="comment">   * Determines and returns the user access token, first using</span>
<a name="l00418"></a>00418 <span class="comment">   * the signed request if present, and then falling back on</span>
<a name="l00419"></a>00419 <span class="comment">   * the authorization code if present.  The intent is to</span>
<a name="l00420"></a>00420 <span class="comment">   * return a valid user access token, or false if one is determined</span>
<a name="l00421"></a>00421 <span class="comment">   * to not be available.</span>
<a name="l00422"></a>00422 <span class="comment">   *</span>
<a name="l00423"></a>00423 <span class="comment">   * @return string A valid user access token, or false if one</span>
<a name="l00424"></a>00424 <span class="comment">   *                could not be determined.</span>
<a name="l00425"></a>00425 <span class="comment">   */</span>
<a name="l00426"></a><a class="code" href="classBaseFacebook.html#afe9aab209768e4d4cc4c959f4dff4310">00426</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#afe9aab209768e4d4cc4c959f4dff4310" title="Determines and returns the user access token, first using the signed request if present, and then falling back on the authorization code if present.">getUserAccessToken</a>() {
<a name="l00427"></a>00427     <span class="comment">// first, consider a signed request if it&#39;s supplied.</span>
<a name="l00428"></a>00428     <span class="comment">// if there is a signed request, then it alone determines</span>
<a name="l00429"></a>00429     <span class="comment">// the access token.</span>
<a name="l00430"></a>00430     $signed_request = $this-&gt;<a class="code" href="classBaseFacebook.html#adf3c753e09842db169309daf8713d17a" title="Retrieve the signed request, either from a request parameter or, if not present, from a cookie...">getSignedRequest</a>();
<a name="l00431"></a>00431     <span class="keywordflow">if</span> ($signed_request) {
<a name="l00432"></a>00432       <span class="comment">// apps.facebook.com hands the access_token in the signed_request</span>
<a name="l00433"></a>00433       <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&#39;oauth_token&#39;</span>, $signed_request)) {
<a name="l00434"></a>00434         $access_token = $signed_request[<span class="stringliteral">&#39;oauth_token&#39;</span>];
<a name="l00435"></a>00435         $this-&gt;<a class="code" href="classBaseFacebook.html#a26198ff065bea23f358854facbafa7db" title="Each of the following four methods should be overridden in a concrete subclass, as they are in the pr...">setPersistentData</a>(<span class="stringliteral">&#39;access_token&#39;</span>, $access_token);
<a name="l00436"></a>00436         <span class="keywordflow">return</span> $access_token;
<a name="l00437"></a>00437       }
<a name="l00438"></a>00438 
<a name="l00439"></a>00439       <span class="comment">// the JS SDK puts a code in with the redirect_uri of &#39;&#39;</span>
<a name="l00440"></a>00440       <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&#39;code&#39;</span>, $signed_request)) {
<a name="l00441"></a>00441         $code = $signed_request[<span class="stringliteral">&#39;code&#39;</span>];
<a name="l00442"></a>00442         $access_token = $this-&gt;<a class="code" href="classBaseFacebook.html#a5cf64ed0104ccf5267e9cee1e73ed783" title="Retrieves an access token for the given authorization code (previously generated from www...">getAccessTokenFromCode</a>($code, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00443"></a>00443         <span class="keywordflow">if</span> ($access_token) {
<a name="l00444"></a>00444           $this-&gt;<a class="code" href="classBaseFacebook.html#a26198ff065bea23f358854facbafa7db" title="Each of the following four methods should be overridden in a concrete subclass, as they are in the pr...">setPersistentData</a>(<span class="stringliteral">&#39;code&#39;</span>, $code);
<a name="l00445"></a>00445           $this-&gt;<a class="code" href="classBaseFacebook.html#a26198ff065bea23f358854facbafa7db" title="Each of the following four methods should be overridden in a concrete subclass, as they are in the pr...">setPersistentData</a>(<span class="stringliteral">&#39;access_token&#39;</span>, $access_token);
<a name="l00446"></a>00446           <span class="keywordflow">return</span> $access_token;
<a name="l00447"></a>00447         }
<a name="l00448"></a>00448       }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450       <span class="comment">// signed request states there&#39;s no access token, so anything</span>
<a name="l00451"></a>00451       <span class="comment">// stored should be cleared.</span>
<a name="l00452"></a>00452       $this-&gt;<a class="code" href="classBaseFacebook.html#a2f98dbe9b9b63d3e76ba7f1971d80c91" title="Clear all data from the persistent storage.">clearAllPersistentData</a>();
<a name="l00453"></a>00453       <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// respect the signed request&#39;s data, even</span>
<a name="l00454"></a>00454                     <span class="comment">// if there&#39;s an authorization code or something else</span>
<a name="l00455"></a>00455     }
<a name="l00456"></a>00456 
<a name="l00457"></a>00457     $code = $this-&gt;<a class="code" href="classBaseFacebook.html#a63452f26d5a4fc7fbcb1732920c1758e" title="Get the authorization code from the query parameters, if it exists, and otherwise return false to sig...">getCode</a>();
<a name="l00458"></a>00458     <span class="keywordflow">if</span> ($code &amp;&amp; $code != $this-&gt;<a class="code" href="classBaseFacebook.html#ad383ccec6f7433c2ab9bb50550df2ce6" title="Get the data for $key, persisted by BaseFacebook::setPersistentData()">getPersistentData</a>(<span class="stringliteral">&#39;code&#39;</span>)) {
<a name="l00459"></a>00459       $access_token = $this-&gt;<a class="code" href="classBaseFacebook.html#a5cf64ed0104ccf5267e9cee1e73ed783" title="Retrieves an access token for the given authorization code (previously generated from www...">getAccessTokenFromCode</a>($code);
<a name="l00460"></a>00460       <span class="keywordflow">if</span> ($access_token) {
<a name="l00461"></a>00461         $this-&gt;<a class="code" href="classBaseFacebook.html#a26198ff065bea23f358854facbafa7db" title="Each of the following four methods should be overridden in a concrete subclass, as they are in the pr...">setPersistentData</a>(<span class="stringliteral">&#39;code&#39;</span>, $code);
<a name="l00462"></a>00462         $this-&gt;<a class="code" href="classBaseFacebook.html#a26198ff065bea23f358854facbafa7db" title="Each of the following four methods should be overridden in a concrete subclass, as they are in the pr...">setPersistentData</a>(<span class="stringliteral">&#39;access_token&#39;</span>, $access_token);
<a name="l00463"></a>00463         <span class="keywordflow">return</span> $access_token;
<a name="l00464"></a>00464       }
<a name="l00465"></a>00465 
<a name="l00466"></a>00466       <span class="comment">// code was bogus, so everything based on it should be invalidated.</span>
<a name="l00467"></a>00467       $this-&gt;<a class="code" href="classBaseFacebook.html#a2f98dbe9b9b63d3e76ba7f1971d80c91" title="Clear all data from the persistent storage.">clearAllPersistentData</a>();
<a name="l00468"></a>00468       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     <span class="comment">// as a fallback, just return whatever is in the persistent</span>
<a name="l00472"></a>00472     <span class="comment">// store, knowing nothing explicit (signed request, authorization</span>
<a name="l00473"></a>00473     <span class="comment">// code, etc.) was present to shadow it (or we saw a code in $_REQUEST,</span>
<a name="l00474"></a>00474     <span class="comment">// but it&#39;s the same as what&#39;s in the persistent store)</span>
<a name="l00475"></a>00475     <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classBaseFacebook.html#ad383ccec6f7433c2ab9bb50550df2ce6" title="Get the data for $key, persisted by BaseFacebook::setPersistentData()">getPersistentData</a>(<span class="stringliteral">&#39;access_token&#39;</span>);
<a name="l00476"></a>00476   }
<a name="l00477"></a>00477 <span class="comment"></span>
<a name="l00478"></a>00478 <span class="comment">  /**</span>
<a name="l00479"></a>00479 <span class="comment">   * Retrieve the signed request, either from a request parameter or,</span>
<a name="l00480"></a>00480 <span class="comment">   * if not present, from a cookie.</span>
<a name="l00481"></a>00481 <span class="comment">   *</span>
<a name="l00482"></a>00482 <span class="comment">   * @return string the signed request, if available, or null otherwise.</span>
<a name="l00483"></a>00483 <span class="comment">   */</span>
<a name="l00484"></a><a class="code" href="classBaseFacebook.html#adf3c753e09842db169309daf8713d17a">00484</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#adf3c753e09842db169309daf8713d17a" title="Retrieve the signed request, either from a request parameter or, if not present, from a cookie...">getSignedRequest</a>() {
<a name="l00485"></a>00485     <span class="keywordflow">if</span> (!$this-&gt;signedRequest) {
<a name="l00486"></a>00486       <span class="keywordflow">if</span> (isset($_REQUEST[<span class="stringliteral">&#39;signed_request&#39;</span>])) {
<a name="l00487"></a>00487         $this-&gt;signedRequest = $this-&gt;<a class="code" href="classBaseFacebook.html#a0f155bb002187e66febf73bef11aeb4d" title="Parses a signed_request and validates the signature.">parseSignedRequest</a>(
<a name="l00488"></a>00488           $_REQUEST[<span class="stringliteral">&#39;signed_request&#39;</span>]);
<a name="l00489"></a>00489       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isset($_COOKIE[$this-&gt;<a class="code" href="classBaseFacebook.html#a67b1b4b1b2337a342ed03aa0a8f91ec5" title="Constructs and returns the name of the cookie that potentially houses the signed request for the app ...">getSignedRequestCookieName</a>()])) {
<a name="l00490"></a>00490         $this-&gt;signedRequest = $this-&gt;<a class="code" href="classBaseFacebook.html#a0f155bb002187e66febf73bef11aeb4d" title="Parses a signed_request and validates the signature.">parseSignedRequest</a>(
<a name="l00491"></a>00491           $_COOKIE[$this-&gt;<a class="code" href="classBaseFacebook.html#a67b1b4b1b2337a342ed03aa0a8f91ec5" title="Constructs and returns the name of the cookie that potentially houses the signed request for the app ...">getSignedRequestCookieName</a>()]);
<a name="l00492"></a>00492       }
<a name="l00493"></a>00493     }
<a name="l00494"></a>00494     <span class="keywordflow">return</span> $this-&gt;signedRequest;
<a name="l00495"></a>00495   }
<a name="l00496"></a>00496 <span class="comment"></span>
<a name="l00497"></a>00497 <span class="comment">  /**</span>
<a name="l00498"></a>00498 <span class="comment">   * Get the UID of the connected user, or 0</span>
<a name="l00499"></a>00499 <span class="comment">   * if the Facebook user is not connected.</span>
<a name="l00500"></a>00500 <span class="comment">   *</span>
<a name="l00501"></a>00501 <span class="comment">   * @return string the UID if available.</span>
<a name="l00502"></a>00502 <span class="comment">   */</span>
<a name="l00503"></a><a class="code" href="classBaseFacebook.html#a8a3ed9483d09400ec486232401189cba">00503</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a8a3ed9483d09400ec486232401189cba" title="Get the UID of the connected user, or 0 if the Facebook user is not connected.">getUser</a>() {
<a name="l00504"></a>00504     <span class="keywordflow">if</span> ($this-&gt;user !== null) {
<a name="l00505"></a>00505       <span class="comment">// we&#39;ve already determined this and cached the value.</span>
<a name="l00506"></a>00506       <span class="keywordflow">return</span> $this-&gt;user;
<a name="l00507"></a>00507     }
<a name="l00508"></a>00508 
<a name="l00509"></a>00509     <span class="keywordflow">return</span> $this-&gt;user = $this-&gt;<a class="code" href="classBaseFacebook.html#ad3dbf5723aa966c9618d1d109526dc4b" title="Determines the connected user by first examining any signed requests, then considering an authorizati...">getUserFromAvailableData</a>();
<a name="l00510"></a>00510   }
<a name="l00511"></a>00511 <span class="comment"></span>
<a name="l00512"></a>00512 <span class="comment">  /**</span>
<a name="l00513"></a>00513 <span class="comment">   * Determines the connected user by first examining any signed</span>
<a name="l00514"></a>00514 <span class="comment">   * requests, then considering an authorization code, and then</span>
<a name="l00515"></a>00515 <span class="comment">   * falling back to any persistent store storing the user.</span>
<a name="l00516"></a>00516 <span class="comment">   *</span>
<a name="l00517"></a>00517 <span class="comment">   * @return integer The id of the connected Facebook user,</span>
<a name="l00518"></a>00518 <span class="comment">   *                 or 0 if no such user exists.</span>
<a name="l00519"></a>00519 <span class="comment">   */</span>
<a name="l00520"></a><a class="code" href="classBaseFacebook.html#ad3dbf5723aa966c9618d1d109526dc4b">00520</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#ad3dbf5723aa966c9618d1d109526dc4b" title="Determines the connected user by first examining any signed requests, then considering an authorizati...">getUserFromAvailableData</a>() {
<a name="l00521"></a>00521     <span class="comment">// if a signed request is supplied, then it solely determines</span>
<a name="l00522"></a>00522     <span class="comment">// who the user is.</span>
<a name="l00523"></a>00523     $signed_request = $this-&gt;<a class="code" href="classBaseFacebook.html#adf3c753e09842db169309daf8713d17a" title="Retrieve the signed request, either from a request parameter or, if not present, from a cookie...">getSignedRequest</a>();
<a name="l00524"></a>00524     <span class="keywordflow">if</span> ($signed_request) {
<a name="l00525"></a>00525       <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&#39;user_id&#39;</span>, $signed_request)) {
<a name="l00526"></a>00526         <a class="code" href="classBaseFacebook.html#a3db38309d6b663c38ec162c5f407e96a">$user</a> = $signed_request[<span class="stringliteral">&#39;user_id&#39;</span>];
<a name="l00527"></a>00527         $this-&gt;<a class="code" href="classBaseFacebook.html#a26198ff065bea23f358854facbafa7db" title="Each of the following four methods should be overridden in a concrete subclass, as they are in the pr...">setPersistentData</a>(<span class="stringliteral">&#39;user_id&#39;</span>, $signed_request[<span class="stringliteral">&#39;user_id&#39;</span>]);
<a name="l00528"></a>00528         <span class="keywordflow">return</span> <a class="code" href="classBaseFacebook.html#a3db38309d6b663c38ec162c5f407e96a">$user</a>;
<a name="l00529"></a>00529       }
<a name="l00530"></a>00530 
<a name="l00531"></a>00531       <span class="comment">// if the signed request didn&#39;t present a user id, then invalidate</span>
<a name="l00532"></a>00532       <span class="comment">// all entries in any persistent store.</span>
<a name="l00533"></a>00533       $this-&gt;<a class="code" href="classBaseFacebook.html#a2f98dbe9b9b63d3e76ba7f1971d80c91" title="Clear all data from the persistent storage.">clearAllPersistentData</a>();
<a name="l00534"></a>00534       <span class="keywordflow">return</span> 0;
<a name="l00535"></a>00535     }
<a name="l00536"></a>00536 
<a name="l00537"></a>00537     <a class="code" href="classBaseFacebook.html#a3db38309d6b663c38ec162c5f407e96a">$user</a> = $this-&gt;<a class="code" href="classBaseFacebook.html#ad383ccec6f7433c2ab9bb50550df2ce6" title="Get the data for $key, persisted by BaseFacebook::setPersistentData()">getPersistentData</a>(<span class="stringliteral">&#39;user_id&#39;</span>, $default = 0);
<a name="l00538"></a>00538     $persisted_access_token = $this-&gt;<a class="code" href="classBaseFacebook.html#ad383ccec6f7433c2ab9bb50550df2ce6" title="Get the data for $key, persisted by BaseFacebook::setPersistentData()">getPersistentData</a>(<span class="stringliteral">&#39;access_token&#39;</span>);
<a name="l00539"></a>00539 
<a name="l00540"></a>00540     <span class="comment">// use access_token to fetch user id if we have a user access_token, or if</span>
<a name="l00541"></a>00541     <span class="comment">// the cached access token has changed.</span>
<a name="l00542"></a>00542     $access_token = $this-&gt;<a class="code" href="classBaseFacebook.html#a1cdac89b20b87c2c2a20137e5e7a8f17" title="Determines the access token that should be used for API calls.">getAccessToken</a>();
<a name="l00543"></a>00543     <span class="keywordflow">if</span> ($access_token &amp;&amp;
<a name="l00544"></a>00544         $access_token != $this-&gt;<a class="code" href="classBaseFacebook.html#a18b991618948872f3f350ee088fea74d" title="Returns the access token that should be used for logged out users when no authorization code is avail...">getApplicationAccessToken</a>() &amp;&amp;
<a name="l00545"></a>00545         !(<a class="code" href="classBaseFacebook.html#a3db38309d6b663c38ec162c5f407e96a">$user</a> &amp;&amp; $persisted_access_token == $access_token)) {
<a name="l00546"></a>00546       <a class="code" href="classBaseFacebook.html#a3db38309d6b663c38ec162c5f407e96a">$user</a> = $this-&gt;<a class="code" href="classBaseFacebook.html#ac67c523b16b29ab94354fd518b4daf06" title="Retrieves the UID with the understanding that $this-&gt;accessToken has already been set and is seemingl...">getUserFromAccessToken</a>();
<a name="l00547"></a>00547       <span class="keywordflow">if</span> (<a class="code" href="classBaseFacebook.html#a3db38309d6b663c38ec162c5f407e96a">$user</a>) {
<a name="l00548"></a>00548         $this-&gt;<a class="code" href="classBaseFacebook.html#a26198ff065bea23f358854facbafa7db" title="Each of the following four methods should be overridden in a concrete subclass, as they are in the pr...">setPersistentData</a>(<span class="stringliteral">&#39;user_id&#39;</span>, <a class="code" href="classBaseFacebook.html#a3db38309d6b663c38ec162c5f407e96a">$user</a>);
<a name="l00549"></a>00549       } <span class="keywordflow">else</span> {
<a name="l00550"></a>00550         $this-&gt;<a class="code" href="classBaseFacebook.html#a2f98dbe9b9b63d3e76ba7f1971d80c91" title="Clear all data from the persistent storage.">clearAllPersistentData</a>();
<a name="l00551"></a>00551       }
<a name="l00552"></a>00552     }
<a name="l00553"></a>00553 
<a name="l00554"></a>00554     <span class="keywordflow">return</span> <a class="code" href="classBaseFacebook.html#a3db38309d6b663c38ec162c5f407e96a">$user</a>;
<a name="l00555"></a>00555   }
<a name="l00556"></a>00556 <span class="comment"></span>
<a name="l00557"></a>00557 <span class="comment">  /**</span>
<a name="l00558"></a>00558 <span class="comment">   * Get a Login URL for use with redirects. By default, full page redirect is</span>
<a name="l00559"></a>00559 <span class="comment">   * assumed. If you are using the generated URL with a window.open() call in</span>
<a name="l00560"></a>00560 <span class="comment">   * JavaScript, you can pass in display=popup as part of the $params.</span>
<a name="l00561"></a>00561 <span class="comment">   *</span>
<a name="l00562"></a>00562 <span class="comment">   * The parameters:</span>
<a name="l00563"></a>00563 <span class="comment">   * - redirect_uri: the url to go to after a successful login</span>
<a name="l00564"></a>00564 <span class="comment">   * - scope: comma separated list of requested extended perms</span>
<a name="l00565"></a>00565 <span class="comment">   *</span>
<a name="l00566"></a>00566 <span class="comment">   * @param array $params Provide custom parameters</span>
<a name="l00567"></a>00567 <span class="comment">   * @return string The URL for the login flow</span>
<a name="l00568"></a>00568 <span class="comment">   */</span>
<a name="l00569"></a><a class="code" href="classBaseFacebook.html#ad8f74c26c7a9bcb82dfe3a411419b553">00569</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#ad8f74c26c7a9bcb82dfe3a411419b553" title="Get a Login URL for use with redirects.">getLoginUrl</a>($params=array()) {
<a name="l00570"></a>00570     $this-&gt;<a class="code" href="classBaseFacebook.html#a461a0bb17c1aec841d401983e069f06a" title="Lays down a CSRF state token for this process.">establishCSRFTokenState</a>();
<a name="l00571"></a>00571     $currentUrl = $this-&gt;<a class="code" href="classBaseFacebook.html#a5746a277eddefc701ad5308285252465" title="/** Returns the Current URL, stripping it of known FB parameters that should not persist.">getCurrentUrl</a>();
<a name="l00572"></a>00572 
<a name="l00573"></a>00573     <span class="comment">// if &#39;scope&#39; is passed as an array, convert to comma separated list</span>
<a name="l00574"></a>00574     $scopeParams = isset($params[<span class="stringliteral">&#39;scope&#39;</span>]) ? $params[<span class="stringliteral">&#39;scope&#39;</span>] : null;
<a name="l00575"></a>00575     <span class="keywordflow">if</span> ($scopeParams &amp;&amp; is_array($scopeParams)) {
<a name="l00576"></a>00576       $params[<span class="stringliteral">&#39;scope&#39;</span>] = implode(<span class="charliteral">&#39;,&#39;</span>, $scopeParams);
<a name="l00577"></a>00577     }
<a name="l00578"></a>00578 
<a name="l00579"></a>00579     <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classBaseFacebook.html#a40ca413355e37b68c3649839769bda2b" title="Build the URL for given domain alias, path and parameters.">getUrl</a>(
<a name="l00580"></a>00580       <span class="stringliteral">&#39;www&#39;</span>,
<a name="l00581"></a>00581       <span class="stringliteral">&#39;dialog/oauth&#39;</span>,
<a name="l00582"></a>00582       array_merge(array(
<a name="l00583"></a>00583                     <span class="stringliteral">&#39;client_id&#39;</span> =&gt; $this-&gt;<a class="code" href="classBaseFacebook.html#a1a3ad028a497dede716cb101f779a15c" title="Get the Application ID.">getAppId</a>(),
<a name="l00584"></a>00584                     <span class="stringliteral">&#39;redirect_uri&#39;</span> =&gt; $currentUrl, <span class="comment">// possibly overwritten</span>
<a name="l00585"></a>00585                     <span class="stringliteral">&#39;state&#39;</span> =&gt; $this-&gt;state),
<a name="l00586"></a>00586                   $params));
<a name="l00587"></a>00587   }
<a name="l00588"></a>00588 <span class="comment"></span>
<a name="l00589"></a>00589 <span class="comment">  /**</span>
<a name="l00590"></a>00590 <span class="comment">   * Get a Logout URL suitable for use with redirects.</span>
<a name="l00591"></a>00591 <span class="comment">   *</span>
<a name="l00592"></a>00592 <span class="comment">   * The parameters:</span>
<a name="l00593"></a>00593 <span class="comment">   * - next: the url to go to after a successful logout</span>
<a name="l00594"></a>00594 <span class="comment">   *</span>
<a name="l00595"></a>00595 <span class="comment">   * @param array $params Provide custom parameters</span>
<a name="l00596"></a>00596 <span class="comment">   * @return string The URL for the logout flow</span>
<a name="l00597"></a>00597 <span class="comment">   */</span>
<a name="l00598"></a><a class="code" href="classBaseFacebook.html#a8083255cc3de8af470925baebccffae2">00598</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a8083255cc3de8af470925baebccffae2" title="Get a Logout URL suitable for use with redirects.">getLogoutUrl</a>($params=array()) {
<a name="l00599"></a>00599     <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classBaseFacebook.html#a40ca413355e37b68c3649839769bda2b" title="Build the URL for given domain alias, path and parameters.">getUrl</a>(
<a name="l00600"></a>00600       <span class="stringliteral">&#39;www&#39;</span>,
<a name="l00601"></a>00601       <span class="stringliteral">&#39;logout.php&#39;</span>,
<a name="l00602"></a>00602       array_merge(array(
<a name="l00603"></a>00603         <span class="stringliteral">&#39;next&#39;</span> =&gt; $this-&gt;<a class="code" href="classBaseFacebook.html#a5746a277eddefc701ad5308285252465" title="/** Returns the Current URL, stripping it of known FB parameters that should not persist.">getCurrentUrl</a>(),
<a name="l00604"></a>00604         <span class="stringliteral">&#39;access_token&#39;</span> =&gt; $this-&gt;<a class="code" href="classBaseFacebook.html#afe9aab209768e4d4cc4c959f4dff4310" title="Determines and returns the user access token, first using the signed request if present, and then falling back on the authorization code if present.">getUserAccessToken</a>(),
<a name="l00605"></a>00605       ), $params)
<a name="l00606"></a>00606     );
<a name="l00607"></a>00607   }
<a name="l00608"></a>00608 <span class="comment"></span>
<a name="l00609"></a>00609 <span class="comment">  /**</span>
<a name="l00610"></a>00610 <span class="comment">   * Get a login status URL to fetch the status from Facebook.</span>
<a name="l00611"></a>00611 <span class="comment">   *</span>
<a name="l00612"></a>00612 <span class="comment">   * The parameters:</span>
<a name="l00613"></a>00613 <span class="comment">   * - ok_session: the URL to go to if a session is found</span>
<a name="l00614"></a>00614 <span class="comment">   * - no_session: the URL to go to if the user is not connected</span>
<a name="l00615"></a>00615 <span class="comment">   * - no_user: the URL to go to if the user is not signed into facebook</span>
<a name="l00616"></a>00616 <span class="comment">   *</span>
<a name="l00617"></a>00617 <span class="comment">   * @param array $params Provide custom parameters</span>
<a name="l00618"></a>00618 <span class="comment">   * @return string The URL for the logout flow</span>
<a name="l00619"></a>00619 <span class="comment">   */</span>
<a name="l00620"></a><a class="code" href="classBaseFacebook.html#a3ac3ec2796290a2e3e4d511bbe76abee">00620</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a3ac3ec2796290a2e3e4d511bbe76abee" title="Get a login status URL to fetch the status from Facebook.">getLoginStatusUrl</a>($params=array()) {
<a name="l00621"></a>00621     <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classBaseFacebook.html#a40ca413355e37b68c3649839769bda2b" title="Build the URL for given domain alias, path and parameters.">getUrl</a>(
<a name="l00622"></a>00622       <span class="stringliteral">&#39;www&#39;</span>,
<a name="l00623"></a>00623       <span class="stringliteral">&#39;extern/login_status.php&#39;</span>,
<a name="l00624"></a>00624       array_merge(array(
<a name="l00625"></a>00625         <span class="stringliteral">&#39;api_key&#39;</span> =&gt; $this-&gt;<a class="code" href="classBaseFacebook.html#a1a3ad028a497dede716cb101f779a15c" title="Get the Application ID.">getAppId</a>(),
<a name="l00626"></a>00626         <span class="stringliteral">&#39;no_session&#39;</span> =&gt; $this-&gt;<a class="code" href="classBaseFacebook.html#a5746a277eddefc701ad5308285252465" title="/** Returns the Current URL, stripping it of known FB parameters that should not persist.">getCurrentUrl</a>(),
<a name="l00627"></a>00627         <span class="stringliteral">&#39;no_user&#39;</span> =&gt; $this-&gt;<a class="code" href="classBaseFacebook.html#a5746a277eddefc701ad5308285252465" title="/** Returns the Current URL, stripping it of known FB parameters that should not persist.">getCurrentUrl</a>(),
<a name="l00628"></a>00628         <span class="stringliteral">&#39;ok_session&#39;</span> =&gt; $this-&gt;<a class="code" href="classBaseFacebook.html#a5746a277eddefc701ad5308285252465" title="/** Returns the Current URL, stripping it of known FB parameters that should not persist.">getCurrentUrl</a>(),
<a name="l00629"></a>00629         <span class="stringliteral">&#39;session_version&#39;</span> =&gt; 3,
<a name="l00630"></a>00630       ), $params)
<a name="l00631"></a>00631     );
<a name="l00632"></a>00632   }
<a name="l00633"></a>00633 <span class="comment"></span>
<a name="l00634"></a>00634 <span class="comment">  /**</span>
<a name="l00635"></a>00635 <span class="comment">   * Make an API call.</span>
<a name="l00636"></a>00636 <span class="comment">   *</span>
<a name="l00637"></a>00637 <span class="comment">   * @return mixed The decoded response</span>
<a name="l00638"></a>00638 <span class="comment">   */</span>
<a name="l00639"></a><a class="code" href="classBaseFacebook.html#a22d6a4c1b6dec331c3bc3f7af02849f5">00639</a>   <span class="keyword">public</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a22d6a4c1b6dec331c3bc3f7af02849f5" title="Make an API call.">api</a>(<span class="comment">/* polymorphic */</span>) {
<a name="l00640"></a>00640     $args = func_get_args();
<a name="l00641"></a>00641     <span class="keywordflow">if</span> (is_array($args[0])) {
<a name="l00642"></a>00642       <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classBaseFacebook.html#a3235e3e5d0c4129e919ab2be464fab4e" title="Invoke the old restserver.php endpoint.">_restserver</a>($args[0]);
<a name="l00643"></a>00643     } <span class="keywordflow">else</span> {
<a name="l00644"></a>00644       <span class="keywordflow">return</span> call_user_func_array(array($this, <span class="stringliteral">&#39;_graph&#39;</span>), $args);
<a name="l00645"></a>00645     }
<a name="l00646"></a>00646   }
<a name="l00647"></a>00647 <span class="comment"></span>
<a name="l00648"></a>00648 <span class="comment">  /**</span>
<a name="l00649"></a>00649 <span class="comment">   * Constructs and returns the name of the cookie that</span>
<a name="l00650"></a>00650 <span class="comment">   * potentially houses the signed request for the app user.</span>
<a name="l00651"></a>00651 <span class="comment">   * The cookie is not set by the BaseFacebook class, but</span>
<a name="l00652"></a>00652 <span class="comment">   * it may be set by the JavaScript SDK.</span>
<a name="l00653"></a>00653 <span class="comment">   *</span>
<a name="l00654"></a>00654 <span class="comment">   * @return string the name of the cookie that would house</span>
<a name="l00655"></a>00655 <span class="comment">   *         the signed request value.</span>
<a name="l00656"></a>00656 <span class="comment">   */</span>
<a name="l00657"></a><a class="code" href="classBaseFacebook.html#a67b1b4b1b2337a342ed03aa0a8f91ec5">00657</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a67b1b4b1b2337a342ed03aa0a8f91ec5" title="Constructs and returns the name of the cookie that potentially houses the signed request for the app ...">getSignedRequestCookieName</a>() {
<a name="l00658"></a>00658     <span class="keywordflow">return</span> <span class="stringliteral">&#39;fbsr_&#39;</span>.$this-&gt;getAppId();
<a name="l00659"></a>00659   }
<a name="l00660"></a>00660 <span class="comment"></span>
<a name="l00661"></a>00661 <span class="comment">  /**</span>
<a name="l00662"></a>00662 <span class="comment">   * Constructs and returns the name of the coookie that potentially contain</span>
<a name="l00663"></a>00663 <span class="comment">   * metadata. The cookie is not set by the BaseFacebook class, but it may be</span>
<a name="l00664"></a>00664 <span class="comment">   * set by the JavaScript SDK.</span>
<a name="l00665"></a>00665 <span class="comment">   *</span>
<a name="l00666"></a>00666 <span class="comment">   * @return string the name of the cookie that would house metadata.</span>
<a name="l00667"></a>00667 <span class="comment">   */</span>
<a name="l00668"></a><a class="code" href="classBaseFacebook.html#ac73bdb41c831a2176eaea8902fdb7d71">00668</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#ac73bdb41c831a2176eaea8902fdb7d71" title="Constructs and returns the name of the coookie that potentially contain metadata.">getMetadataCookieName</a>() {
<a name="l00669"></a>00669     <span class="keywordflow">return</span> <span class="stringliteral">&#39;fbm_&#39;</span>.$this-&gt;getAppId();
<a name="l00670"></a>00670   }
<a name="l00671"></a>00671 <span class="comment"></span>
<a name="l00672"></a>00672 <span class="comment">  /**</span>
<a name="l00673"></a>00673 <span class="comment">   * Get the authorization code from the query parameters, if it exists,</span>
<a name="l00674"></a>00674 <span class="comment">   * and otherwise return false to signal no authorization code was</span>
<a name="l00675"></a>00675 <span class="comment">   * discoverable.</span>
<a name="l00676"></a>00676 <span class="comment">   *</span>
<a name="l00677"></a>00677 <span class="comment">   * @return mixed The authorization code, or false if the authorization</span>
<a name="l00678"></a>00678 <span class="comment">   *               code could not be determined.</span>
<a name="l00679"></a>00679 <span class="comment">   */</span>
<a name="l00680"></a><a class="code" href="classBaseFacebook.html#a63452f26d5a4fc7fbcb1732920c1758e">00680</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a63452f26d5a4fc7fbcb1732920c1758e" title="Get the authorization code from the query parameters, if it exists, and otherwise return false to sig...">getCode</a>() {
<a name="l00681"></a>00681     <span class="keywordflow">if</span> (isset($_REQUEST[<span class="stringliteral">&#39;code&#39;</span>])) {
<a name="l00682"></a>00682       <span class="keywordflow">if</span> ($this-&gt;state !== null &amp;&amp;
<a name="l00683"></a>00683           isset($_REQUEST[<span class="stringliteral">&#39;state&#39;</span>]) &amp;&amp;
<a name="l00684"></a>00684           $this-&gt;state === $_REQUEST[<span class="stringliteral">&#39;state&#39;</span>]) {
<a name="l00685"></a>00685 
<a name="l00686"></a>00686         <span class="comment">// CSRF state has done its job, so clear it</span>
<a name="l00687"></a>00687         $this-&gt;state = null;
<a name="l00688"></a>00688         $this-&gt;<a class="code" href="classBaseFacebook.html#a3bfb6ef7b1abbd3ec0545be109d32bef" title="Clear the data with $key from the persistent storage.">clearPersistentData</a>(<span class="stringliteral">&#39;state&#39;</span>);
<a name="l00689"></a>00689         <span class="keywordflow">return</span> $_REQUEST[<span class="stringliteral">&#39;code&#39;</span>];
<a name="l00690"></a>00690       } <span class="keywordflow">else</span> {
<a name="l00691"></a>00691         <a class="code" href="classBaseFacebook.html#a8f2b4289828f4f1e758c05f483eca682" title="Prints to the error log if you aren&#39;t in command line mode.">self::errorLog</a>(<span class="stringliteral">&#39;CSRF state token does not match one provided.&#39;</span>);
<a name="l00692"></a>00692         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00693"></a>00693       }
<a name="l00694"></a>00694     }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00697"></a>00697   }
<a name="l00698"></a>00698 <span class="comment"></span>
<a name="l00699"></a>00699 <span class="comment">  /**</span>
<a name="l00700"></a>00700 <span class="comment">   * Retrieves the UID with the understanding that</span>
<a name="l00701"></a>00701 <span class="comment">   * $this-&gt;accessToken has already been set and is</span>
<a name="l00702"></a>00702 <span class="comment">   * seemingly legitimate.  It relies on Facebook&#39;s Graph API</span>
<a name="l00703"></a>00703 <span class="comment">   * to retrieve user information and then extract</span>
<a name="l00704"></a>00704 <span class="comment">   * the user ID.</span>
<a name="l00705"></a>00705 <span class="comment">   *</span>
<a name="l00706"></a>00706 <span class="comment">   * @return integer Returns the UID of the Facebook user, or 0</span>
<a name="l00707"></a>00707 <span class="comment">   *                 if the Facebook user could not be determined.</span>
<a name="l00708"></a>00708 <span class="comment">   */</span>
<a name="l00709"></a><a class="code" href="classBaseFacebook.html#ac67c523b16b29ab94354fd518b4daf06">00709</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#ac67c523b16b29ab94354fd518b4daf06" title="Retrieves the UID with the understanding that $this-&gt;accessToken has already been set and is seemingl...">getUserFromAccessToken</a>() {
<a name="l00710"></a>00710     <span class="keywordflow">try</span> {
<a name="l00711"></a>00711       $user_info = $this-&gt;<a class="code" href="classBaseFacebook.html#a22d6a4c1b6dec331c3bc3f7af02849f5" title="Make an API call.">api</a>(<span class="stringliteral">&#39;/me&#39;</span>);
<a name="l00712"></a>00712       <span class="keywordflow">return</span> $user_info[<span class="stringliteral">&#39;id&#39;</span>];
<a name="l00713"></a>00713     } <span class="keywordflow">catch</span> (<a class="code" href="classFacebookApiException.html" title="Copyright 2011 Facebook, Inc.">FacebookApiException</a> $e) {
<a name="l00714"></a>00714       <span class="keywordflow">return</span> 0;
<a name="l00715"></a>00715     }
<a name="l00716"></a>00716   }
<a name="l00717"></a>00717 <span class="comment"></span>
<a name="l00718"></a>00718 <span class="comment">  /**</span>
<a name="l00719"></a>00719 <span class="comment">   * Returns the access token that should be used for logged out</span>
<a name="l00720"></a>00720 <span class="comment">   * users when no authorization code is available.</span>
<a name="l00721"></a>00721 <span class="comment">   *</span>
<a name="l00722"></a>00722 <span class="comment">   * @return string The application access token, useful for gathering</span>
<a name="l00723"></a>00723 <span class="comment">   *                public information about users and applications.</span>
<a name="l00724"></a>00724 <span class="comment">   */</span>
<a name="l00725"></a><a class="code" href="classBaseFacebook.html#a18b991618948872f3f350ee088fea74d">00725</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a18b991618948872f3f350ee088fea74d" title="Returns the access token that should be used for logged out users when no authorization code is avail...">getApplicationAccessToken</a>() {
<a name="l00726"></a>00726     <span class="keywordflow">return</span> $this-&gt;appId.<span class="charliteral">&#39;|&#39;</span>.$this-&gt;appSecret;
<a name="l00727"></a>00727   }
<a name="l00728"></a>00728 <span class="comment"></span>
<a name="l00729"></a>00729 <span class="comment">  /**</span>
<a name="l00730"></a>00730 <span class="comment">   * Lays down a CSRF state token for this process.</span>
<a name="l00731"></a>00731 <span class="comment">   *</span>
<a name="l00732"></a>00732 <span class="comment">   * @return void</span>
<a name="l00733"></a>00733 <span class="comment">   */</span>
<a name="l00734"></a><a class="code" href="classBaseFacebook.html#a461a0bb17c1aec841d401983e069f06a">00734</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a461a0bb17c1aec841d401983e069f06a" title="Lays down a CSRF state token for this process.">establishCSRFTokenState</a>() {
<a name="l00735"></a>00735     <span class="keywordflow">if</span> ($this-&gt;state === null) {
<a name="l00736"></a>00736       $this-&gt;state = md5(uniqid(mt_rand(), <span class="keyword">true</span>));
<a name="l00737"></a>00737       $this-&gt;<a class="code" href="classBaseFacebook.html#a26198ff065bea23f358854facbafa7db" title="Each of the following four methods should be overridden in a concrete subclass, as they are in the pr...">setPersistentData</a>(<span class="stringliteral">&#39;state&#39;</span>, $this-&gt;state);
<a name="l00738"></a>00738     }
<a name="l00739"></a>00739   }
<a name="l00740"></a>00740 <span class="comment"></span>
<a name="l00741"></a>00741 <span class="comment">  /**</span>
<a name="l00742"></a>00742 <span class="comment">   * Retrieves an access token for the given authorization code</span>
<a name="l00743"></a>00743 <span class="comment">   * (previously generated from www.facebook.com on behalf of</span>
<a name="l00744"></a>00744 <span class="comment">   * a specific user).  The authorization code is sent to graph.facebook.com</span>
<a name="l00745"></a>00745 <span class="comment">   * and a legitimate access token is generated provided the access token</span>
<a name="l00746"></a>00746 <span class="comment">   * and the user for which it was generated all match, and the user is</span>
<a name="l00747"></a>00747 <span class="comment">   * either logged in to Facebook or has granted an offline access permission.</span>
<a name="l00748"></a>00748 <span class="comment">   *</span>
<a name="l00749"></a>00749 <span class="comment">   * @param string $code An authorization code.</span>
<a name="l00750"></a>00750 <span class="comment">   * @return mixed An access token exchanged for the authorization code, or</span>
<a name="l00751"></a>00751 <span class="comment">   *               false if an access token could not be generated.</span>
<a name="l00752"></a>00752 <span class="comment">   */</span>
<a name="l00753"></a><a class="code" href="classBaseFacebook.html#a5cf64ed0104ccf5267e9cee1e73ed783">00753</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a5cf64ed0104ccf5267e9cee1e73ed783" title="Retrieves an access token for the given authorization code (previously generated from www...">getAccessTokenFromCode</a>($code, $redirect_uri = null) {
<a name="l00754"></a>00754     <span class="keywordflow">if</span> (empty($code)) {
<a name="l00755"></a>00755       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00756"></a>00756     }
<a name="l00757"></a>00757 
<a name="l00758"></a>00758     <span class="keywordflow">if</span> ($redirect_uri === null) {
<a name="l00759"></a>00759       $redirect_uri = $this-&gt;<a class="code" href="classBaseFacebook.html#a5746a277eddefc701ad5308285252465" title="/** Returns the Current URL, stripping it of known FB parameters that should not persist.">getCurrentUrl</a>();
<a name="l00760"></a>00760     }
<a name="l00761"></a>00761 
<a name="l00762"></a>00762     <span class="keywordflow">try</span> {
<a name="l00763"></a>00763       <span class="comment">// need to circumvent json_decode by calling _oauthRequest</span>
<a name="l00764"></a>00764       <span class="comment">// directly, since response isn&#39;t JSON format.</span>
<a name="l00765"></a>00765       $access_token_response =
<a name="l00766"></a>00766         $this-&gt;<a class="code" href="classBaseFacebook.html#a87925b6d625110ec3aab4bad3100d4d3" title="Make a OAuth Request.">_oauthRequest</a>(
<a name="l00767"></a>00767           $this-&gt;<a class="code" href="classBaseFacebook.html#a40ca413355e37b68c3649839769bda2b" title="Build the URL for given domain alias, path and parameters.">getUrl</a>(<span class="stringliteral">&#39;graph&#39;</span>, <span class="stringliteral">&#39;/oauth/access_token&#39;</span>),
<a name="l00768"></a>00768           $params = array(<span class="stringliteral">&#39;client_id&#39;</span> =&gt; $this-&gt;<a class="code" href="classBaseFacebook.html#a1a3ad028a497dede716cb101f779a15c" title="Get the Application ID.">getAppId</a>(),
<a name="l00769"></a>00769                           <span class="stringliteral">&#39;client_secret&#39;</span> =&gt; $this-&gt;<a class="code" href="classBaseFacebook.html#ae53e6a3cfd3b6ca1dba5c1f5568720ec" title="Get the App Secret.">getAppSecret</a>(),
<a name="l00770"></a>00770                           <span class="stringliteral">&#39;redirect_uri&#39;</span> =&gt; $redirect_uri,
<a name="l00771"></a>00771                           <span class="stringliteral">&#39;code&#39;</span> =&gt; $code));
<a name="l00772"></a>00772     } <span class="keywordflow">catch</span> (<a class="code" href="classFacebookApiException.html" title="Copyright 2011 Facebook, Inc.">FacebookApiException</a> $e) {
<a name="l00773"></a>00773       <span class="comment">// most likely that user very recently revoked authorization.</span>
<a name="l00774"></a>00774       <span class="comment">// In any event, we don&#39;t have an access token, so say so.</span>
<a name="l00775"></a>00775       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00776"></a>00776     }
<a name="l00777"></a>00777 
<a name="l00778"></a>00778     <span class="keywordflow">if</span> (empty($access_token_response)) {
<a name="l00779"></a>00779       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00780"></a>00780     }
<a name="l00781"></a>00781 
<a name="l00782"></a>00782     $response_params = array();
<a name="l00783"></a>00783     parse_str($access_token_response, $response_params);
<a name="l00784"></a>00784     <span class="keywordflow">if</span> (!isset($response_params[<span class="stringliteral">&#39;access_token&#39;</span>])) {
<a name="l00785"></a>00785       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00786"></a>00786     }
<a name="l00787"></a>00787 
<a name="l00788"></a>00788     <span class="keywordflow">return</span> $response_params[<span class="stringliteral">&#39;access_token&#39;</span>];
<a name="l00789"></a>00789   }
<a name="l00790"></a>00790 <span class="comment"></span>
<a name="l00791"></a>00791 <span class="comment">  /**</span>
<a name="l00792"></a>00792 <span class="comment">   * Invoke the old restserver.php endpoint.</span>
<a name="l00793"></a>00793 <span class="comment">   *</span>
<a name="l00794"></a>00794 <span class="comment">   * @param array $params Method call object</span>
<a name="l00795"></a>00795 <span class="comment">   *</span>
<a name="l00796"></a>00796 <span class="comment">   * @return mixed The decoded response object</span>
<a name="l00797"></a>00797 <span class="comment">   * @throws FacebookApiException</span>
<a name="l00798"></a>00798 <span class="comment">   */</span>
<a name="l00799"></a><a class="code" href="classBaseFacebook.html#a3235e3e5d0c4129e919ab2be464fab4e">00799</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a3235e3e5d0c4129e919ab2be464fab4e" title="Invoke the old restserver.php endpoint.">_restserver</a>($params) {
<a name="l00800"></a>00800     <span class="comment">// generic application level parameters</span>
<a name="l00801"></a>00801     $params[<span class="stringliteral">&#39;api_key&#39;</span>] = $this-&gt;<a class="code" href="classBaseFacebook.html#a1a3ad028a497dede716cb101f779a15c" title="Get the Application ID.">getAppId</a>();
<a name="l00802"></a>00802     $params[<span class="stringliteral">&#39;format&#39;</span>] = <span class="stringliteral">&#39;json-strings&#39;</span>;
<a name="l00803"></a>00803 
<a name="l00804"></a>00804     <a class="code" href="link__out_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a> = json_decode($this-&gt;<a class="code" href="classBaseFacebook.html#a87925b6d625110ec3aab4bad3100d4d3" title="Make a OAuth Request.">_oauthRequest</a>(
<a name="l00805"></a>00805       $this-&gt;<a class="code" href="classBaseFacebook.html#a3a844e7cce1bad59e59b7ebdb93baa8a" title="Build the URL for api given parameters.">getApiUrl</a>($params[<span class="stringliteral">&#39;method&#39;</span>]),
<a name="l00806"></a>00806       $params
<a name="l00807"></a>00807     ), <span class="keyword">true</span>);
<a name="l00808"></a>00808 
<a name="l00809"></a>00809     <span class="comment">// results are returned, errors are thrown</span>
<a name="l00810"></a>00810     <span class="keywordflow">if</span> (is_array(<a class="code" href="link__out_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a>) &amp;&amp; isset(<a class="code" href="link__out_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a>[<span class="stringliteral">&#39;error_code&#39;</span>])) {
<a name="l00811"></a>00811       $this-&gt;<a class="code" href="classBaseFacebook.html#a83875df5a95a05bbbb4857460e743404" title="Analyzes the supplied result to see if it was thrown because the access token is no longer valid...">throwAPIException</a>(<a class="code" href="link__out_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a>);
<a name="l00812"></a>00812       <span class="comment">// @codeCoverageIgnoreStart</span>
<a name="l00813"></a>00813     }
<a name="l00814"></a>00814     <span class="comment">// @codeCoverageIgnoreEnd</span>
<a name="l00815"></a>00815 
<a name="l00816"></a>00816     $method = strtolower($params[<span class="stringliteral">&#39;method&#39;</span>]);
<a name="l00817"></a>00817     <span class="keywordflow">if</span> ($method === <span class="stringliteral">&#39;auth.expiresession&#39;</span> ||
<a name="l00818"></a>00818         $method === <span class="stringliteral">&#39;auth.revokeauthorization&#39;</span>) {
<a name="l00819"></a>00819       $this-&gt;<a class="code" href="classBaseFacebook.html#a4235356d20fcc14a74c1073b59948b65" title="Destroy the current session.">destroySession</a>();
<a name="l00820"></a>00820     }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822     <span class="keywordflow">return</span> <a class="code" href="link__out_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a>;
<a name="l00823"></a>00823   }
<a name="l00824"></a>00824 <span class="comment"></span>
<a name="l00825"></a>00825 <span class="comment">  /**</span>
<a name="l00826"></a>00826 <span class="comment">   * Return true if this is video post.</span>
<a name="l00827"></a>00827 <span class="comment">   *</span>
<a name="l00828"></a>00828 <span class="comment">   * @param string $path The path</span>
<a name="l00829"></a>00829 <span class="comment">   * @param string $method The http method (default &#39;GET&#39;)</span>
<a name="l00830"></a>00830 <span class="comment">   *</span>
<a name="l00831"></a>00831 <span class="comment">   * @return boolean true if this is video post</span>
<a name="l00832"></a>00832 <span class="comment">   */</span>
<a name="l00833"></a><a class="code" href="classBaseFacebook.html#a59ec8025b618af99293ac5efc9d88a59">00833</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a59ec8025b618af99293ac5efc9d88a59" title="Return true if this is video post.">isVideoPost</a>($path, $method = <span class="stringliteral">&#39;GET&#39;</span>) {
<a name="l00834"></a>00834     <span class="keywordflow">if</span> ($method == <span class="stringliteral">&#39;POST&#39;</span> &amp;&amp; preg_match(<span class="stringliteral">&quot;/^(\/)(.+)(\/)(videos)$/&quot;</span>, $path)) {
<a name="l00835"></a>00835       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00836"></a>00836     }
<a name="l00837"></a>00837     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00838"></a>00838   }
<a name="l00839"></a>00839 <span class="comment"></span>
<a name="l00840"></a>00840 <span class="comment">  /**</span>
<a name="l00841"></a>00841 <span class="comment">   * Invoke the Graph API.</span>
<a name="l00842"></a>00842 <span class="comment">   *</span>
<a name="l00843"></a>00843 <span class="comment">   * @param string $path The path (required)</span>
<a name="l00844"></a>00844 <span class="comment">   * @param string $method The http method (default &#39;GET&#39;)</span>
<a name="l00845"></a>00845 <span class="comment">   * @param array $params The query/post data</span>
<a name="l00846"></a>00846 <span class="comment">   *</span>
<a name="l00847"></a>00847 <span class="comment">   * @return mixed The decoded response object</span>
<a name="l00848"></a>00848 <span class="comment">   * @throws FacebookApiException</span>
<a name="l00849"></a>00849 <span class="comment">   */</span>
<a name="l00850"></a><a class="code" href="classBaseFacebook.html#af0966973d145fbb9c2add330a46c7587">00850</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#af0966973d145fbb9c2add330a46c7587" title="Invoke the Graph API.">_graph</a>($path, $method = <span class="stringliteral">&#39;GET&#39;</span>, $params = array()) {
<a name="l00851"></a>00851     <span class="keywordflow">if</span> (is_array($method) &amp;&amp; empty($params)) {
<a name="l00852"></a>00852       $params = $method;
<a name="l00853"></a>00853       $method = <span class="stringliteral">&#39;GET&#39;</span>;
<a name="l00854"></a>00854     }
<a name="l00855"></a>00855     $params[<span class="stringliteral">&#39;method&#39;</span>] = $method; <span class="comment">// method override as we always do a POST</span>
<a name="l00856"></a>00856 
<a name="l00857"></a>00857     <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classBaseFacebook.html#a59ec8025b618af99293ac5efc9d88a59" title="Return true if this is video post.">isVideoPost</a>($path, $method)) {
<a name="l00858"></a>00858       $domainKey = <span class="stringliteral">&#39;graph_video&#39;</span>;
<a name="l00859"></a>00859     } <span class="keywordflow">else</span> {
<a name="l00860"></a>00860       $domainKey = <span class="stringliteral">&#39;graph&#39;</span>;
<a name="l00861"></a>00861     }
<a name="l00862"></a>00862 
<a name="l00863"></a>00863     <a class="code" href="link__out_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a> = json_decode($this-&gt;<a class="code" href="classBaseFacebook.html#a87925b6d625110ec3aab4bad3100d4d3" title="Make a OAuth Request.">_oauthRequest</a>(
<a name="l00864"></a>00864       $this-&gt;<a class="code" href="classBaseFacebook.html#a40ca413355e37b68c3649839769bda2b" title="Build the URL for given domain alias, path and parameters.">getUrl</a>($domainKey, $path),
<a name="l00865"></a>00865       $params
<a name="l00866"></a>00866     ), <span class="keyword">true</span>);
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     <span class="comment">// results are returned, errors are thrown</span>
<a name="l00869"></a>00869     <span class="keywordflow">if</span> (is_array(<a class="code" href="link__out_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a>) &amp;&amp; isset(<a class="code" href="link__out_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a>[<span class="stringliteral">&#39;error&#39;</span>])) {
<a name="l00870"></a>00870       $this-&gt;<a class="code" href="classBaseFacebook.html#a83875df5a95a05bbbb4857460e743404" title="Analyzes the supplied result to see if it was thrown because the access token is no longer valid...">throwAPIException</a>(<a class="code" href="link__out_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a>);
<a name="l00871"></a>00871       <span class="comment">// @codeCoverageIgnoreStart</span>
<a name="l00872"></a>00872     }
<a name="l00873"></a>00873     <span class="comment">// @codeCoverageIgnoreEnd</span>
<a name="l00874"></a>00874 
<a name="l00875"></a>00875     <span class="keywordflow">return</span> <a class="code" href="link__out_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a>;
<a name="l00876"></a>00876   }
<a name="l00877"></a>00877 <span class="comment"></span>
<a name="l00878"></a>00878 <span class="comment">  /**</span>
<a name="l00879"></a>00879 <span class="comment">   * Make a OAuth Request.</span>
<a name="l00880"></a>00880 <span class="comment">   *</span>
<a name="l00881"></a>00881 <span class="comment">   * @param string $url The path (required)</span>
<a name="l00882"></a>00882 <span class="comment">   * @param array $params The query/post data</span>
<a name="l00883"></a>00883 <span class="comment">   *</span>
<a name="l00884"></a>00884 <span class="comment">   * @return string The decoded response object</span>
<a name="l00885"></a>00885 <span class="comment">   * @throws FacebookApiException</span>
<a name="l00886"></a>00886 <span class="comment">   */</span>
<a name="l00887"></a><a class="code" href="classBaseFacebook.html#a87925b6d625110ec3aab4bad3100d4d3">00887</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a87925b6d625110ec3aab4bad3100d4d3" title="Make a OAuth Request.">_oauthRequest</a>($url, $params) {
<a name="l00888"></a>00888     <span class="keywordflow">if</span> (!isset($params[<span class="stringliteral">&#39;access_token&#39;</span>])) {
<a name="l00889"></a>00889       $params[<span class="stringliteral">&#39;access_token&#39;</span>] = $this-&gt;<a class="code" href="classBaseFacebook.html#a1cdac89b20b87c2c2a20137e5e7a8f17" title="Determines the access token that should be used for API calls.">getAccessToken</a>();
<a name="l00890"></a>00890     }
<a name="l00891"></a>00891 
<a name="l00892"></a>00892     <span class="comment">// json_encode all params values that are not strings</span>
<a name="l00893"></a>00893     <span class="keywordflow">foreach</span> ($params as $key =&gt; $value) {
<a name="l00894"></a>00894       <span class="keywordflow">if</span> (!is_string($value)) {
<a name="l00895"></a>00895         $params[$key] = json_encode($value);
<a name="l00896"></a>00896       }
<a name="l00897"></a>00897     }
<a name="l00898"></a>00898 
<a name="l00899"></a>00899     <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classBaseFacebook.html#acded7c1ecb37c2745c734f4736b3c8ac" title="Makes an HTTP request.">makeRequest</a>($url, $params);
<a name="l00900"></a>00900   }
<a name="l00901"></a>00901 <span class="comment"></span>
<a name="l00902"></a>00902 <span class="comment">  /**</span>
<a name="l00903"></a>00903 <span class="comment">   * Makes an HTTP request. This method can be overridden by subclasses if</span>
<a name="l00904"></a>00904 <span class="comment">   * developers want to do fancier things or use something other than curl to</span>
<a name="l00905"></a>00905 <span class="comment">   * make the request.</span>
<a name="l00906"></a>00906 <span class="comment">   *</span>
<a name="l00907"></a>00907 <span class="comment">   * @param string $url The URL to make the request to</span>
<a name="l00908"></a>00908 <span class="comment">   * @param array $params The parameters to use for the POST body</span>
<a name="l00909"></a>00909 <span class="comment">   * @param CurlHandler $ch Initialized curl handle</span>
<a name="l00910"></a>00910 <span class="comment">   *</span>
<a name="l00911"></a>00911 <span class="comment">   * @return string The response text</span>
<a name="l00912"></a>00912 <span class="comment">   */</span>
<a name="l00913"></a><a class="code" href="classBaseFacebook.html#acded7c1ecb37c2745c734f4736b3c8ac">00913</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#acded7c1ecb37c2745c734f4736b3c8ac" title="Makes an HTTP request.">makeRequest</a>($url, $params, <a class="code" href="sp_8php.html#a696b903bbc5c02914bdd402e91826eca">$ch</a>=null) {
<a name="l00914"></a>00914     <span class="keywordflow">if</span> (!<a class="code" href="sp_8php.html#a696b903bbc5c02914bdd402e91826eca">$ch</a>) {
<a name="l00915"></a>00915       <a class="code" href="sp_8php.html#a696b903bbc5c02914bdd402e91826eca">$ch</a> = curl_init();
<a name="l00916"></a>00916     }
<a name="l00917"></a>00917 
<a name="l00918"></a>00918     $opts = <a class="code" href="classBaseFacebook.html#ad48ad58bc8120acf03f199bb100be6dd" title="Default options for curl.">self::$CURL_OPTS</a>;
<a name="l00919"></a>00919     <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classBaseFacebook.html#a339321887bccd3b1ebc79c433ed97409" title="Get the file upload support status.">getFileUploadSupport</a>()) {
<a name="l00920"></a>00920       $opts[CURLOPT_POSTFIELDS] = $params;
<a name="l00921"></a>00921     } <span class="keywordflow">else</span> {
<a name="l00922"></a>00922       $opts[CURLOPT_POSTFIELDS] = http_build_query($params, null, <span class="charliteral">&#39;&amp;&#39;</span>);
<a name="l00923"></a>00923     }
<a name="l00924"></a>00924     $opts[CURLOPT_URL] = $url;
<a name="l00925"></a>00925 
<a name="l00926"></a>00926     <span class="comment">// disable the &#39;Expect: 100-continue&#39; behaviour. This causes CURL to wait</span>
<a name="l00927"></a>00927     <span class="comment">// for 2 seconds if the server does not support this header.</span>
<a name="l00928"></a>00928     <span class="keywordflow">if</span> (isset($opts[CURLOPT_HTTPHEADER])) {
<a name="l00929"></a>00929       $existing_headers = $opts[CURLOPT_HTTPHEADER];
<a name="l00930"></a>00930       $existing_headers[] = <span class="stringliteral">&#39;Expect:&#39;</span>;
<a name="l00931"></a>00931       $opts[CURLOPT_HTTPHEADER] = $existing_headers;
<a name="l00932"></a>00932     } <span class="keywordflow">else</span> {
<a name="l00933"></a>00933       $opts[CURLOPT_HTTPHEADER] = array(<span class="stringliteral">&#39;Expect:&#39;</span>);
<a name="l00934"></a>00934     }
<a name="l00935"></a>00935 
<a name="l00936"></a>00936     curl_setopt_array(<a class="code" href="sp_8php.html#a696b903bbc5c02914bdd402e91826eca">$ch</a>, $opts);
<a name="l00937"></a>00937     <a class="code" href="link__out_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a> = curl_exec(<a class="code" href="sp_8php.html#a696b903bbc5c02914bdd402e91826eca">$ch</a>);
<a name="l00938"></a>00938 
<a name="l00939"></a>00939     <span class="keywordflow">if</span> (curl_errno(<a class="code" href="sp_8php.html#a696b903bbc5c02914bdd402e91826eca">$ch</a>) == 60) { <span class="comment">// CURLE_SSL_CACERT</span>
<a name="l00940"></a>00940       <a class="code" href="classBaseFacebook.html#a8f2b4289828f4f1e758c05f483eca682" title="Prints to the error log if you aren&#39;t in command line mode.">self::errorLog</a>(<span class="stringliteral">&#39;Invalid or no certificate authority found, &#39;</span>.
<a name="l00941"></a>00941                      <span class="stringliteral">&#39;using bundled information&#39;</span>);
<a name="l00942"></a>00942       curl_setopt(<a class="code" href="sp_8php.html#a696b903bbc5c02914bdd402e91826eca">$ch</a>, CURLOPT_CAINFO,
<a name="l00943"></a>00943                   dirname(__FILE__) . <span class="stringliteral">&#39;/fb_ca_chain_bundle.crt&#39;</span>);
<a name="l00944"></a>00944       <a class="code" href="link__out_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a> = curl_exec(<a class="code" href="sp_8php.html#a696b903bbc5c02914bdd402e91826eca">$ch</a>);
<a name="l00945"></a>00945     }
<a name="l00946"></a>00946 
<a name="l00947"></a>00947     <span class="comment">// With dual stacked DNS responses, it&#39;s possible for a server to</span>
<a name="l00948"></a>00948     <span class="comment">// have IPv6 enabled but not have IPv6 connectivity.  If this is</span>
<a name="l00949"></a>00949     <span class="comment">// the case, curl will try IPv4 first and if that fails, then it will</span>
<a name="l00950"></a>00950     <span class="comment">// fall back to IPv6 and the error EHOSTUNREACH is returned by the</span>
<a name="l00951"></a>00951     <span class="comment">// operating system.</span>
<a name="l00952"></a>00952     <span class="keywordflow">if</span> (<a class="code" href="link__out_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a> === <span class="keyword">false</span> &amp;&amp; empty($opts[CURLOPT_IPRESOLVE])) {
<a name="l00953"></a>00953         $matches = array();
<a name="l00954"></a>00954         $regex = <span class="stringliteral">&#39;/Failed to connect to ([^:].*): Network is unreachable/&#39;</span>;
<a name="l00955"></a>00955         <span class="keywordflow">if</span> (preg_match($regex, curl_error(<a class="code" href="sp_8php.html#a696b903bbc5c02914bdd402e91826eca">$ch</a>), $matches)) {
<a name="l00956"></a>00956           <span class="keywordflow">if</span> (strlen(@inet_pton($matches[1])) === 16) {
<a name="l00957"></a>00957             <a class="code" href="classBaseFacebook.html#a8f2b4289828f4f1e758c05f483eca682" title="Prints to the error log if you aren&#39;t in command line mode.">self::errorLog</a>(<span class="stringliteral">&#39;Invalid IPv6 configuration on server, &#39;</span>.
<a name="l00958"></a>00958                            <span class="stringliteral">&#39;Please disable or get native IPv6 on your server.&#39;</span>);
<a name="l00959"></a>00959             self::$CURL_OPTS[CURLOPT_IPRESOLVE] = CURL_IPRESOLVE_V4;
<a name="l00960"></a>00960             curl_setopt(<a class="code" href="sp_8php.html#a696b903bbc5c02914bdd402e91826eca">$ch</a>, CURLOPT_IPRESOLVE, CURL_IPRESOLVE_V4);
<a name="l00961"></a>00961             <a class="code" href="link__out_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a> = curl_exec(<a class="code" href="sp_8php.html#a696b903bbc5c02914bdd402e91826eca">$ch</a>);
<a name="l00962"></a>00962           }
<a name="l00963"></a>00963         }
<a name="l00964"></a>00964     }
<a name="l00965"></a>00965 
<a name="l00966"></a>00966     <span class="keywordflow">if</span> (<a class="code" href="link__out_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a> === <span class="keyword">false</span>) {
<a name="l00967"></a>00967       $e = <span class="keyword">new</span> <a class="code" href="classFacebookApiException.html" title="Copyright 2011 Facebook, Inc.">FacebookApiException</a>(array(
<a name="l00968"></a>00968         <span class="stringliteral">&#39;error_code&#39;</span> =&gt; curl_errno(<a class="code" href="sp_8php.html#a696b903bbc5c02914bdd402e91826eca">$ch</a>),
<a name="l00969"></a>00969         <span class="stringliteral">&#39;error&#39;</span> =&gt; array(
<a name="l00970"></a>00970         <span class="stringliteral">&#39;message&#39;</span> =&gt; curl_error(<a class="code" href="sp_8php.html#a696b903bbc5c02914bdd402e91826eca">$ch</a>),
<a name="l00971"></a>00971         <span class="stringliteral">&#39;type&#39;</span> =&gt; <span class="stringliteral">&#39;CurlException&#39;</span>,
<a name="l00972"></a>00972         ),
<a name="l00973"></a>00973       ));
<a name="l00974"></a>00974       curl_close(<a class="code" href="sp_8php.html#a696b903bbc5c02914bdd402e91826eca">$ch</a>);
<a name="l00975"></a>00975       <span class="keywordflow">throw</span> $e;
<a name="l00976"></a>00976     }
<a name="l00977"></a>00977     curl_close(<a class="code" href="sp_8php.html#a696b903bbc5c02914bdd402e91826eca">$ch</a>);
<a name="l00978"></a>00978     <span class="keywordflow">return</span> <a class="code" href="link__out_8php.html#a112ef069ddc0454086e3d1e6d8d55d07">$result</a>;
<a name="l00979"></a>00979   }
<a name="l00980"></a>00980 <span class="comment"></span>
<a name="l00981"></a>00981 <span class="comment">  /**</span>
<a name="l00982"></a>00982 <span class="comment">   * Parses a signed_request and validates the signature.</span>
<a name="l00983"></a>00983 <span class="comment">   *</span>
<a name="l00984"></a>00984 <span class="comment">   * @param string $signed_request A signed token</span>
<a name="l00985"></a>00985 <span class="comment">   * @return array The payload inside it or null if the sig is wrong</span>
<a name="l00986"></a>00986 <span class="comment">   */</span>
<a name="l00987"></a><a class="code" href="classBaseFacebook.html#a0f155bb002187e66febf73bef11aeb4d">00987</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a0f155bb002187e66febf73bef11aeb4d" title="Parses a signed_request and validates the signature.">parseSignedRequest</a>($signed_request) {
<a name="l00988"></a>00988     list($encoded_sig, $payload) = explode(<span class="charliteral">&#39;.&#39;</span>, $signed_request, 2);
<a name="l00989"></a>00989 
<a name="l00990"></a>00990     <span class="comment">// decode the data</span>
<a name="l00991"></a>00991     $sig = <a class="code" href="classBaseFacebook.html#a8cb499f186fbbd10b7d30c37094d9b97" title="Base64 encoding that doesn&#39;t need to be urlencode()ed.">self::base64UrlDecode</a>($encoded_sig);
<a name="l00992"></a>00992     <a class="code" href="adm_8php.html#a6efc15b5a2314dd4b5aaa556a375c6d6">$data</a> = json_decode(self::base64UrlDecode($payload), <span class="keyword">true</span>);
<a name="l00993"></a>00993 
<a name="l00994"></a>00994     <span class="keywordflow">if</span> (strtoupper(<a class="code" href="adm_8php.html#a6efc15b5a2314dd4b5aaa556a375c6d6">$data</a>[<span class="stringliteral">&#39;algorithm&#39;</span>]) !== self::SIGNED_REQUEST_ALGORITHM) {
<a name="l00995"></a>00995       <a class="code" href="classBaseFacebook.html#a8f2b4289828f4f1e758c05f483eca682" title="Prints to the error log if you aren&#39;t in command line mode.">self::errorLog</a>(
<a name="l00996"></a>00996         <span class="stringliteral">&#39;Unknown algorithm. Expected &#39;</span> . self::SIGNED_REQUEST_ALGORITHM);
<a name="l00997"></a>00997       <span class="keywordflow">return</span> null;
<a name="l00998"></a>00998     }
<a name="l00999"></a>00999 
<a name="l01000"></a>01000     <span class="comment">// check sig</span>
<a name="l01001"></a>01001     $expected_sig = hash_hmac(<span class="stringliteral">&#39;sha256&#39;</span>, $payload,
<a name="l01002"></a>01002                               $this-&gt;<a class="code" href="classBaseFacebook.html#ae53e6a3cfd3b6ca1dba5c1f5568720ec" title="Get the App Secret.">getAppSecret</a>(), $raw = <span class="keyword">true</span>);
<a name="l01003"></a>01003     <span class="keywordflow">if</span> ($sig !== $expected_sig) {
<a name="l01004"></a>01004       <a class="code" href="classBaseFacebook.html#a8f2b4289828f4f1e758c05f483eca682" title="Prints to the error log if you aren&#39;t in command line mode.">self::errorLog</a>(<span class="stringliteral">&#39;Bad Signed JSON signature!&#39;</span>);
<a name="l01005"></a>01005       <span class="keywordflow">return</span> null;
<a name="l01006"></a>01006     }
<a name="l01007"></a>01007 
<a name="l01008"></a>01008     <span class="keywordflow">return</span> <a class="code" href="adm_8php.html#a6efc15b5a2314dd4b5aaa556a375c6d6">$data</a>;
<a name="l01009"></a>01009   }
<a name="l01010"></a>01010 <span class="comment"></span>
<a name="l01011"></a>01011 <span class="comment">  /**</span>
<a name="l01012"></a>01012 <span class="comment">   * Makes a signed_request blob using the given data.</span>
<a name="l01013"></a>01013 <span class="comment">   *</span>
<a name="l01014"></a>01014 <span class="comment">   * @param array The data array.</span>
<a name="l01015"></a>01015 <span class="comment">   * @return string The signed request.</span>
<a name="l01016"></a>01016 <span class="comment">   */</span>
<a name="l01017"></a><a class="code" href="classBaseFacebook.html#a1b9a10f4e44581553ee4cdc5a28455e1">01017</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a1b9a10f4e44581553ee4cdc5a28455e1" title="Makes a signed_request blob using the given data.">makeSignedRequest</a>(<a class="code" href="adm_8php.html#a6efc15b5a2314dd4b5aaa556a375c6d6">$data</a>) {
<a name="l01018"></a>01018     <span class="keywordflow">if</span> (!is_array(<a class="code" href="adm_8php.html#a6efc15b5a2314dd4b5aaa556a375c6d6">$data</a>)) {
<a name="l01019"></a>01019       <span class="keywordflow">throw</span> <span class="keyword">new</span> InvalidArgumentException(
<a name="l01020"></a>01020         <span class="stringliteral">&#39;makeSignedRequest expects an array. Got: &#39;</span> . print_r(<a class="code" href="adm_8php.html#a6efc15b5a2314dd4b5aaa556a375c6d6">$data</a>, <span class="keyword">true</span>));
<a name="l01021"></a>01021     }
<a name="l01022"></a>01022     <a class="code" href="adm_8php.html#a6efc15b5a2314dd4b5aaa556a375c6d6">$data</a>[<span class="stringliteral">&#39;algorithm&#39;</span>] = <a class="code" href="classBaseFacebook.html#a91b50b70a2d503d402d67ac8398d34b0" title="Signed Request Algorithm.">self::SIGNED_REQUEST_ALGORITHM</a>;
<a name="l01023"></a>01023     <a class="code" href="adm_8php.html#a6efc15b5a2314dd4b5aaa556a375c6d6">$data</a>[<span class="stringliteral">&#39;issued_at&#39;</span>] = time();
<a name="l01024"></a>01024     $json = json_encode(<a class="code" href="adm_8php.html#a6efc15b5a2314dd4b5aaa556a375c6d6">$data</a>);
<a name="l01025"></a>01025     $b64 = <a class="code" href="classBaseFacebook.html#aa9a23342190c5b2dedfbab5354de6d8b" title="Base64 encoding that doesn&#39;t need to be urlencode()ed.">self::base64UrlEncode</a>($json);
<a name="l01026"></a>01026     $raw_sig = hash_hmac(<span class="stringliteral">&#39;sha256&#39;</span>, $b64, $this-&gt;<a class="code" href="classBaseFacebook.html#ae53e6a3cfd3b6ca1dba5c1f5568720ec" title="Get the App Secret.">getAppSecret</a>(), $raw = <span class="keyword">true</span>);
<a name="l01027"></a>01027     $sig = <a class="code" href="classBaseFacebook.html#aa9a23342190c5b2dedfbab5354de6d8b" title="Base64 encoding that doesn&#39;t need to be urlencode()ed.">self::base64UrlEncode</a>($raw_sig);
<a name="l01028"></a>01028     <span class="keywordflow">return</span> $sig.<span class="charliteral">&#39;.&#39;</span>.$b64;
<a name="l01029"></a>01029   }
<a name="l01030"></a>01030 <span class="comment"></span>
<a name="l01031"></a>01031 <span class="comment">  /**</span>
<a name="l01032"></a>01032 <span class="comment">   * Build the URL for api given parameters.</span>
<a name="l01033"></a>01033 <span class="comment">   *</span>
<a name="l01034"></a>01034 <span class="comment">   * @param $method String the method name.</span>
<a name="l01035"></a>01035 <span class="comment">   * @return string The URL for the given parameters</span>
<a name="l01036"></a>01036 <span class="comment">   */</span>
<a name="l01037"></a><a class="code" href="classBaseFacebook.html#a3a844e7cce1bad59e59b7ebdb93baa8a">01037</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a3a844e7cce1bad59e59b7ebdb93baa8a" title="Build the URL for api given parameters.">getApiUrl</a>($method) {
<a name="l01038"></a>01038     <span class="keyword">static</span> $READ_ONLY_CALLS =
<a name="l01039"></a>01039       array(<span class="stringliteral">&#39;admin.getallocation&#39;</span> =&gt; 1,
<a name="l01040"></a>01040             <span class="stringliteral">&#39;admin.getappproperties&#39;</span> =&gt; 1,
<a name="l01041"></a>01041             <span class="stringliteral">&#39;admin.getbannedusers&#39;</span> =&gt; 1,
<a name="l01042"></a>01042             <span class="stringliteral">&#39;admin.getlivestreamvialink&#39;</span> =&gt; 1,
<a name="l01043"></a>01043             <span class="stringliteral">&#39;admin.getmetrics&#39;</span> =&gt; 1,
<a name="l01044"></a>01044             <span class="stringliteral">&#39;admin.getrestrictioninfo&#39;</span> =&gt; 1,
<a name="l01045"></a>01045             <span class="stringliteral">&#39;application.getpublicinfo&#39;</span> =&gt; 1,
<a name="l01046"></a>01046             <span class="stringliteral">&#39;auth.getapppublickey&#39;</span> =&gt; 1,
<a name="l01047"></a>01047             <span class="stringliteral">&#39;auth.getsession&#39;</span> =&gt; 1,
<a name="l01048"></a>01048             <span class="stringliteral">&#39;auth.getsignedpublicsessiondata&#39;</span> =&gt; 1,
<a name="l01049"></a>01049             <span class="stringliteral">&#39;comments.get&#39;</span> =&gt; 1,
<a name="l01050"></a>01050             <span class="stringliteral">&#39;connect.getunconnectedfriendscount&#39;</span> =&gt; 1,
<a name="l01051"></a>01051             <span class="stringliteral">&#39;dashboard.getactivity&#39;</span> =&gt; 1,
<a name="l01052"></a>01052             <span class="stringliteral">&#39;dashboard.getcount&#39;</span> =&gt; 1,
<a name="l01053"></a>01053             <span class="stringliteral">&#39;dashboard.getglobalnews&#39;</span> =&gt; 1,
<a name="l01054"></a>01054             <span class="stringliteral">&#39;dashboard.getnews&#39;</span> =&gt; 1,
<a name="l01055"></a>01055             <span class="stringliteral">&#39;dashboard.multigetcount&#39;</span> =&gt; 1,
<a name="l01056"></a>01056             <span class="stringliteral">&#39;dashboard.multigetnews&#39;</span> =&gt; 1,
<a name="l01057"></a>01057             <span class="stringliteral">&#39;data.getcookies&#39;</span> =&gt; 1,
<a name="l01058"></a>01058             <span class="stringliteral">&#39;events.get&#39;</span> =&gt; 1,
<a name="l01059"></a>01059             <span class="stringliteral">&#39;events.getmembers&#39;</span> =&gt; 1,
<a name="l01060"></a>01060             <span class="stringliteral">&#39;fbml.getcustomtags&#39;</span> =&gt; 1,
<a name="l01061"></a>01061             <span class="stringliteral">&#39;feed.getappfriendstories&#39;</span> =&gt; 1,
<a name="l01062"></a>01062             <span class="stringliteral">&#39;feed.getregisteredtemplatebundlebyid&#39;</span> =&gt; 1,
<a name="l01063"></a>01063             <span class="stringliteral">&#39;feed.getregisteredtemplatebundles&#39;</span> =&gt; 1,
<a name="l01064"></a>01064             <span class="stringliteral">&#39;fql.multiquery&#39;</span> =&gt; 1,
<a name="l01065"></a>01065             <span class="stringliteral">&#39;fql.query&#39;</span> =&gt; 1,
<a name="l01066"></a>01066             <span class="stringliteral">&#39;friends.arefriends&#39;</span> =&gt; 1,
<a name="l01067"></a>01067             <span class="stringliteral">&#39;friends.get&#39;</span> =&gt; 1,
<a name="l01068"></a>01068             <span class="stringliteral">&#39;friends.getappusers&#39;</span> =&gt; 1,
<a name="l01069"></a>01069             <span class="stringliteral">&#39;friends.getlists&#39;</span> =&gt; 1,
<a name="l01070"></a>01070             <span class="stringliteral">&#39;friends.getmutualfriends&#39;</span> =&gt; 1,
<a name="l01071"></a>01071             <span class="stringliteral">&#39;gifts.get&#39;</span> =&gt; 1,
<a name="l01072"></a>01072             <span class="stringliteral">&#39;groups.get&#39;</span> =&gt; 1,
<a name="l01073"></a>01073             <span class="stringliteral">&#39;groups.getmembers&#39;</span> =&gt; 1,
<a name="l01074"></a>01074             <span class="stringliteral">&#39;intl.gettranslations&#39;</span> =&gt; 1,
<a name="l01075"></a>01075             <span class="stringliteral">&#39;links.get&#39;</span> =&gt; 1,
<a name="l01076"></a>01076             <span class="stringliteral">&#39;notes.get&#39;</span> =&gt; 1,
<a name="l01077"></a>01077             <span class="stringliteral">&#39;notifications.get&#39;</span> =&gt; 1,
<a name="l01078"></a>01078             <span class="stringliteral">&#39;pages.getinfo&#39;</span> =&gt; 1,
<a name="l01079"></a>01079             <span class="stringliteral">&#39;pages.isadmin&#39;</span> =&gt; 1,
<a name="l01080"></a>01080             <span class="stringliteral">&#39;pages.isappadded&#39;</span> =&gt; 1,
<a name="l01081"></a>01081             <span class="stringliteral">&#39;pages.isfan&#39;</span> =&gt; 1,
<a name="l01082"></a>01082             <span class="stringliteral">&#39;permissions.checkavailableapiaccess&#39;</span> =&gt; 1,
<a name="l01083"></a>01083             <span class="stringliteral">&#39;permissions.checkgrantedapiaccess&#39;</span> =&gt; 1,
<a name="l01084"></a>01084             <span class="stringliteral">&#39;photos.get&#39;</span> =&gt; 1,
<a name="l01085"></a>01085             <span class="stringliteral">&#39;photos.getalbums&#39;</span> =&gt; 1,
<a name="l01086"></a>01086             <span class="stringliteral">&#39;photos.gettags&#39;</span> =&gt; 1,
<a name="l01087"></a>01087             <span class="stringliteral">&#39;profile.getinfo&#39;</span> =&gt; 1,
<a name="l01088"></a>01088             <span class="stringliteral">&#39;profile.getinfooptions&#39;</span> =&gt; 1,
<a name="l01089"></a>01089             <span class="stringliteral">&#39;stream.get&#39;</span> =&gt; 1,
<a name="l01090"></a>01090             <span class="stringliteral">&#39;stream.getcomments&#39;</span> =&gt; 1,
<a name="l01091"></a>01091             <span class="stringliteral">&#39;stream.getfilters&#39;</span> =&gt; 1,
<a name="l01092"></a>01092             <span class="stringliteral">&#39;users.getinfo&#39;</span> =&gt; 1,
<a name="l01093"></a>01093             <span class="stringliteral">&#39;users.getloggedinuser&#39;</span> =&gt; 1,
<a name="l01094"></a>01094             <span class="stringliteral">&#39;users.getstandardinfo&#39;</span> =&gt; 1,
<a name="l01095"></a>01095             <span class="stringliteral">&#39;users.hasapppermission&#39;</span> =&gt; 1,
<a name="l01096"></a>01096             <span class="stringliteral">&#39;users.isappuser&#39;</span> =&gt; 1,
<a name="l01097"></a>01097             <span class="stringliteral">&#39;users.isverified&#39;</span> =&gt; 1,
<a name="l01098"></a>01098             <span class="stringliteral">&#39;video.getuploadlimits&#39;</span> =&gt; 1);
<a name="l01099"></a>01099     <a class="code" href="wab_8php.html#ab2fc40d43824ea3e1ce5d86dee0d763b">$name</a> = <span class="stringliteral">&#39;api&#39;</span>;
<a name="l01100"></a>01100     <span class="keywordflow">if</span> (isset($READ_ONLY_CALLS[strtolower($method)])) {
<a name="l01101"></a>01101       <a class="code" href="wab_8php.html#ab2fc40d43824ea3e1ce5d86dee0d763b">$name</a> = <span class="stringliteral">&#39;api_read&#39;</span>;
<a name="l01102"></a>01102     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strtolower($method) == <span class="stringliteral">&#39;video.upload&#39;</span>) {
<a name="l01103"></a>01103       <a class="code" href="wab_8php.html#ab2fc40d43824ea3e1ce5d86dee0d763b">$name</a> = <span class="stringliteral">&#39;api_video&#39;</span>;
<a name="l01104"></a>01104     }
<a name="l01105"></a>01105     <span class="keywordflow">return</span> <a class="code" href="classBaseFacebook.html#a40ca413355e37b68c3649839769bda2b" title="Build the URL for given domain alias, path and parameters.">self::getUrl</a>(<a class="code" href="wab_8php.html#ab2fc40d43824ea3e1ce5d86dee0d763b">$name</a>, <span class="stringliteral">&#39;restserver.php&#39;</span>);
<a name="l01106"></a>01106   }
<a name="l01107"></a>01107 <span class="comment"></span>
<a name="l01108"></a>01108 <span class="comment">  /**</span>
<a name="l01109"></a>01109 <span class="comment">   * Build the URL for given domain alias, path and parameters.</span>
<a name="l01110"></a>01110 <span class="comment">   *</span>
<a name="l01111"></a>01111 <span class="comment">   * @param $name string The name of the domain</span>
<a name="l01112"></a>01112 <span class="comment">   * @param $path string Optional path (without a leading slash)</span>
<a name="l01113"></a>01113 <span class="comment">   * @param $params array Optional query parameters</span>
<a name="l01114"></a>01114 <span class="comment">   *</span>
<a name="l01115"></a>01115 <span class="comment">   * @return string The URL for the given parameters</span>
<a name="l01116"></a>01116 <span class="comment">   */</span>
<a name="l01117"></a><a class="code" href="classBaseFacebook.html#a40ca413355e37b68c3649839769bda2b">01117</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a40ca413355e37b68c3649839769bda2b" title="Build the URL for given domain alias, path and parameters.">getUrl</a>(<a class="code" href="wab_8php.html#ab2fc40d43824ea3e1ce5d86dee0d763b">$name</a>, $path=<span class="stringliteral">&#39;&#39;</span>, $params=array()) {
<a name="l01118"></a>01118     $url = self::$DOMAIN_MAP[<a class="code" href="wab_8php.html#ab2fc40d43824ea3e1ce5d86dee0d763b">$name</a>];
<a name="l01119"></a>01119     <span class="keywordflow">if</span> ($path) {
<a name="l01120"></a>01120       <span class="keywordflow">if</span> ($path[0] === <span class="charliteral">&#39;/&#39;</span>) {
<a name="l01121"></a>01121         $path = substr($path, 1);
<a name="l01122"></a>01122       }
<a name="l01123"></a>01123       $url .= $path;
<a name="l01124"></a>01124     }
<a name="l01125"></a>01125     <span class="keywordflow">if</span> ($params) {
<a name="l01126"></a>01126       $url .= <span class="charliteral">&#39;?&#39;</span> . http_build_query($params, null, <span class="charliteral">&#39;&amp;&#39;</span>);
<a name="l01127"></a>01127     }
<a name="l01128"></a>01128 
<a name="l01129"></a>01129     <span class="keywordflow">return</span> $url;
<a name="l01130"></a>01130   }
<a name="l01131"></a>01131 
<a name="l01132"></a><a class="code" href="classBaseFacebook.html#a5fcf8434f74ce2f5624412f6c076003a">01132</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a5fcf8434f74ce2f5624412f6c076003a">getHttpHost</a>() {
<a name="l01133"></a>01133     <span class="keywordflow">if</span> ($this-&gt;trustForwarded &amp;&amp; isset($_SERVER[<span class="stringliteral">&#39;HTTP_X_FORWARDED_HOST&#39;</span>])) {
<a name="l01134"></a>01134       <span class="keywordflow">return</span> $_SERVER[<span class="stringliteral">&#39;HTTP_X_FORWARDED_HOST&#39;</span>];
<a name="l01135"></a>01135     }
<a name="l01136"></a>01136     <span class="keywordflow">return</span> $_SERVER[<span class="stringliteral">&#39;HTTP_HOST&#39;</span>];
<a name="l01137"></a>01137   }
<a name="l01138"></a>01138 
<a name="l01139"></a><a class="code" href="classBaseFacebook.html#af9abc533c861a43f273e78060460a277">01139</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#af9abc533c861a43f273e78060460a277">getHttpProtocol</a>() {
<a name="l01140"></a>01140     <span class="keywordflow">if</span> ($this-&gt;trustForwarded &amp;&amp; isset($_SERVER[<span class="stringliteral">&#39;HTTP_X_FORWARDED_PROTO&#39;</span>])) {
<a name="l01141"></a>01141       <span class="keywordflow">if</span> ($_SERVER[<span class="stringliteral">&#39;HTTP_X_FORWARDED_PROTO&#39;</span>] === <span class="stringliteral">&#39;https&#39;</span>) {
<a name="l01142"></a>01142         <span class="keywordflow">return</span> <span class="stringliteral">&#39;https&#39;</span>;
<a name="l01143"></a>01143       }
<a name="l01144"></a>01144       <span class="keywordflow">return</span> <span class="stringliteral">&#39;http&#39;</span>;
<a name="l01145"></a>01145     }
<a name="l01146"></a>01146     <span class="keywordflow">if</span> (isset($_SERVER[<span class="stringliteral">&#39;HTTPS&#39;</span>]) &amp;&amp;
<a name="l01147"></a>01147         ($_SERVER[<span class="stringliteral">&#39;HTTPS&#39;</span>] === <span class="stringliteral">&#39;on&#39;</span> || $_SERVER[<span class="stringliteral">&#39;HTTPS&#39;</span>] == 1)) {
<a name="l01148"></a>01148       <span class="keywordflow">return</span> <span class="stringliteral">&#39;https&#39;</span>;
<a name="l01149"></a>01149     }
<a name="l01150"></a>01150     <span class="keywordflow">return</span> <span class="stringliteral">&#39;http&#39;</span>;
<a name="l01151"></a>01151   }
<a name="l01152"></a>01152 <span class="comment"></span>
<a name="l01153"></a>01153 <span class="comment">  /**</span>
<a name="l01154"></a>01154 <span class="comment">   * Get the base domain used for the cookie.</span>
<a name="l01155"></a>01155 <span class="comment">   */</span>
<a name="l01156"></a><a class="code" href="classBaseFacebook.html#a63cedad2b05bd6b120c1f6e58b87952a">01156</a>   <span class="keyword">protected</span> <span class="keyword">function</span> <a class="code" href="classBaseFacebook.html#a63cedad2b05bd6b120c1f6e58b87952a" title="Get the base domain used for the cookie.">getBaseDomain</a>() {
<a name="l01157"></a>01157     <span class="comment">// The base domain is stored in the metadata cookie if not we fallback</span>
<a name="l01158"></a>01158     <span class="comment">// to the current hostname</span>
<a name="l01159"></a>01159     $metadata = $this-&gt;<a class="code" href="classBaseFacebook.html#a934183edea46236610bc661c92747c71" title="Parses the metadata cookie that our Javascript API set.">getMetadataCookie</a>();
<a name="l01160"></a>01160     <span class="keywordflow">if</span> (array_key_exists(<span class="stringliteral">&#39;base_domain&#39;</span>, $metadata) &amp;&amp;
<a name="l01161"></a>01161         !empty($metadata[<span class="stringliteral">&#39;base_domain&#39;</span>])) {
<a name="l01162"></a>01162       <span class="keywordflow">return</span> trim($metadata[<span class="stringliteral">&#39;base_domain&#39;</span>], <span class="charliteral">&#39;.&#39;</span>);
<a name="l01163"></a>01163     }
<a name="l01164"></a>01164     <span class="keywordflow">return</span> $this-&gt;<a class="code" href="classBaseFacebook.html#a5fcf8434f74ce2f5624412f6c076003a">getHttpHost</a>();
<a name="l01165"></a>01165   }
<a name="l01166"></a>01166 <span class="comment"></span>
<a name="l01167"></a>01167 <span class="comment">  /**</span>
<a name="l01168"></a>01168 <span class="comment"></span><span class="comment"></span>
<a name="l01169"></a>01169 <span class="comment">  /**</span>
<a name="l01170"></a>01170 <span class="comment">   * Returns the Current URL, stripping it of known FB parameters that should</span>
<a name="l01171"></a>01171 <span class="comment">   * not persist.</span>
<a name="l01172"></a>01172 <span class="comment">   *</span>
<a name="l01173"></a>01173 <span class="comment">   * @return string The current URL</span>
<a name="l01174"></a>01174 <span class="comment">   */</span>
<a name="l01175"></a><a class="code" href="classBaseFacebook.html#a5746a277eddefc701ad5308285252465">01175</a>   protected function getCurrentUrl() {
<a name="l01176"></a>01176     $protocol = $this-&gt;getHttpProtocol() . &#39;://&#39;;
<a name="l01177"></a>01177     $host = $this-&gt;getHttpHost();
<a name="l01178"></a>01178     $currentUrl = $protocol.$host.$_SERVER[&#39;REQUEST_URI&#39;];
<a name="l01179"></a>01179     $parts = parse_url($currentUrl);
<a name="l01180"></a>01180 
<a name="l01181"></a>01181     $query = &#39;&#39;;
<a name="l01182"></a>01182     if (!empty($parts[&#39;query&#39;])) {
<a name="l01183"></a>01183       // drop known fb params
<a name="l01184"></a>01184       $params = explode(&#39;&amp;&#39;, $parts[&#39;query&#39;]);
<a name="l01185"></a>01185       $retained_params = array();
<a name="l01186"></a>01186       foreach ($params as $param) {
<a name="l01187"></a>01187         if ($this-&gt;shouldRetainParam($param)) {
<a name="l01188"></a>01188           $retained_params[] = $param;
<a name="l01189"></a>01189         }
<a name="l01190"></a>01190       }
<a name="l01191"></a>01191 
<a name="l01192"></a>01192       if (!empty($retained_params)) {
<a name="l01193"></a>01193         $query = &#39;?&#39;.implode($retained_params, &#39;&amp;&#39;);
<a name="l01194"></a>01194       }
<a name="l01195"></a>01195     }
<a name="l01196"></a>01196 
<a name="l01197"></a>01197     // use port if non default
<a name="l01198"></a>01198     $port =
<a name="l01199"></a>01199       isset($parts[&#39;port&#39;]) &amp;&amp;
<a name="l01200"></a>01200       (($protocol === &#39;http://&#39; &amp;&amp; $parts[&#39;port&#39;] !== 80) ||
<a name="l01201"></a>01201        ($protocol === &#39;https://&#39; &amp;&amp; $parts[&#39;port&#39;] !== 443))
<a name="l01202"></a>01202       ? &#39;:&#39; . $parts[&#39;port&#39;] : &#39;&#39;;
<a name="l01203"></a>01203 
<a name="l01204"></a>01204     // rebuild
<a name="l01205"></a>01205     return $protocol . $parts[&#39;host&#39;] . $port . $parts[&#39;path&#39;] . $query;
<a name="l01206"></a>01206   }
<a name="l01207"></a>01207 <span class="comment"></span>
<a name="l01208"></a>01208 <span class="comment">  /**</span>
<a name="l01209"></a>01209 <span class="comment">   * Returns true if and only if the key or key/value pair should</span>
<a name="l01210"></a>01210 <span class="comment">   * be retained as part of the query string.  This amounts to</span>
<a name="l01211"></a>01211 <span class="comment">   * a brute-force search of the very small list of Facebook-specific</span>
<a name="l01212"></a>01212 <span class="comment">   * params that should be stripped out.</span>
<a name="l01213"></a>01213 <span class="comment">   *</span>
<a name="l01214"></a>01214 <span class="comment">   * @param string $param A key or key/value pair within a URL&#39;s query (e.g.</span>
<a name="l01215"></a>01215 <span class="comment">   *                     &#39;foo=a&#39;, &#39;foo=&#39;, or &#39;foo&#39;.</span>
<a name="l01216"></a>01216 <span class="comment">   *</span>
<a name="l01217"></a>01217 <span class="comment">   * @return boolean</span>
<a name="l01218"></a>01218 <span class="comment">   */</span>
<a name="l01219"></a><a class="code" href="classBaseFacebook.html#a47e7827a14b19657e2a760afa5324dad">01219</a>   protected function shouldRetainParam($param) {
<a name="l01220"></a>01220     foreach (self::$DROP_QUERY_PARAMS as $drop_query_param) {
<a name="l01221"></a>01221       if (strpos($param, $drop_query_param.&#39;=&#39;) === 0) {
<a name="l01222"></a>01222         return false;
<a name="l01223"></a>01223       }
<a name="l01224"></a>01224     }
<a name="l01225"></a>01225 
<a name="l01226"></a>01226     return true;
<a name="l01227"></a>01227   }
<a name="l01228"></a>01228 <span class="comment"></span>
<a name="l01229"></a>01229 <span class="comment">  /**</span>
<a name="l01230"></a>01230 <span class="comment">   * Analyzes the supplied result to see if it was thrown</span>
<a name="l01231"></a>01231 <span class="comment">   * because the access token is no longer valid.  If that is</span>
<a name="l01232"></a>01232 <span class="comment">   * the case, then we destroy the session.</span>
<a name="l01233"></a>01233 <span class="comment">   *</span>
<a name="l01234"></a>01234 <span class="comment">   * @param $result array A record storing the error message returned</span>
<a name="l01235"></a>01235 <span class="comment">   *                      by a failed API call.</span>
<a name="l01236"></a>01236 <span class="comment">   */</span>
<a name="l01237"></a><a class="code" href="classBaseFacebook.html#a83875df5a95a05bbbb4857460e743404">01237</a>   protected function throwAPIException($result) {
<a name="l01238"></a>01238     $e = new FacebookApiException($result);
<a name="l01239"></a>01239     switch ($e-&gt;getType()) {
<a name="l01240"></a>01240       // OAuth 2.0 Draft 00 style
<a name="l01241"></a>01241       case &#39;OAuthException&#39;:
<a name="l01242"></a>01242         // OAuth 2.0 Draft 10 style
<a name="l01243"></a>01243       case &#39;invalid_token&#39;:
<a name="l01244"></a>01244         // REST server errors are just Exceptions
<a name="l01245"></a>01245       case &#39;Exception&#39;:
<a name="l01246"></a>01246         $message = $e-&gt;getMessage();
<a name="l01247"></a>01247         if ((strpos($message, &#39;Error validating access token&#39;) !== false) ||
<a name="l01248"></a>01248             (strpos($message, &#39;Invalid OAuth access token&#39;) !== false) ||
<a name="l01249"></a>01249             (strpos($message, &#39;An active access token must be used&#39;) !== false)
<a name="l01250"></a>01250         ) {
<a name="l01251"></a>01251           $this-&gt;destroySession();
<a name="l01252"></a>01252         }
<a name="l01253"></a>01253         break;
<a name="l01254"></a>01254     }
<a name="l01255"></a>01255 
<a name="l01256"></a>01256     throw $e;
<a name="l01257"></a>01257   }
<a name="l01258"></a>01258 
<a name="l01259"></a>01259 <span class="comment"></span>
<a name="l01260"></a>01260 <span class="comment">  /**</span>
<a name="l01261"></a>01261 <span class="comment">   * Prints to the error log if you aren&#39;t in command line mode.</span>
<a name="l01262"></a>01262 <span class="comment">   *</span>
<a name="l01263"></a>01263 <span class="comment">   * @param string $msg Log message</span>
<a name="l01264"></a>01264 <span class="comment">   */</span>
<a name="l01265"></a><a class="code" href="classBaseFacebook.html#a8f2b4289828f4f1e758c05f483eca682">01265</a>   protected static function errorLog($msg) {
<a name="l01266"></a>01266     // disable error log if we are running in a CLI environment
<a name="l01267"></a>01267     // @codeCoverageIgnoreStart
<a name="l01268"></a>01268     if (php_sapi_name() != &#39;cli&#39;) {
<a name="l01269"></a>01269       error_log($msg);
<a name="l01270"></a>01270     }
<a name="l01271"></a>01271     // uncomment this if you want to see the errors on the page
<a name="l01272"></a>01272     // print &#39;error_log: &#39;.$msg.&quot;\n&quot;;
<a name="l01273"></a>01273     // @codeCoverageIgnoreEnd
<a name="l01274"></a>01274   }
<a name="l01275"></a>01275 <span class="comment"></span>
<a name="l01276"></a>01276 <span class="comment">  /**</span>
<a name="l01277"></a>01277 <span class="comment">   * Base64 encoding that doesn&#39;t need to be urlencode()ed.</span>
<a name="l01278"></a>01278 <span class="comment">   * Exactly the same as base64_encode except it uses</span>
<a name="l01279"></a>01279 <span class="comment">   *   - instead of +</span>
<a name="l01280"></a>01280 <span class="comment">   *   _ instead of /</span>
<a name="l01281"></a>01281 <span class="comment">   *   No padded =</span>
<a name="l01282"></a>01282 <span class="comment">   *</span>
<a name="l01283"></a>01283 <span class="comment">   * @param string $input base64UrlEncoded string</span>
<a name="l01284"></a>01284 <span class="comment">   * @return string</span>
<a name="l01285"></a>01285 <span class="comment">   */</span>
<a name="l01286"></a><a class="code" href="classBaseFacebook.html#a8cb499f186fbbd10b7d30c37094d9b97">01286</a>   protected static function base64UrlDecode($input) {
<a name="l01287"></a>01287     return base64_decode(strtr($input, &#39;-_&#39;, &#39;+/&#39;));
<a name="l01288"></a>01288   }
<a name="l01289"></a>01289 <span class="comment"></span>
<a name="l01290"></a>01290 <span class="comment">  /**</span>
<a name="l01291"></a>01291 <span class="comment">   * Base64 encoding that doesn&#39;t need to be urlencode()ed.</span>
<a name="l01292"></a>01292 <span class="comment">   * Exactly the same as base64_encode except it uses</span>
<a name="l01293"></a>01293 <span class="comment">   *   - instead of +</span>
<a name="l01294"></a>01294 <span class="comment">   *   _ instead of /</span>
<a name="l01295"></a>01295 <span class="comment">   *</span>
<a name="l01296"></a>01296 <span class="comment">   * @param string $input string</span>
<a name="l01297"></a>01297 <span class="comment">   * @return string base64Url encoded string</span>
<a name="l01298"></a>01298 <span class="comment">   */</span>
<a name="l01299"></a><a class="code" href="classBaseFacebook.html#aa9a23342190c5b2dedfbab5354de6d8b">01299</a>   protected static function base64UrlEncode($input) {
<a name="l01300"></a>01300     $str = strtr(base64_encode($input), &#39;+/&#39;, &#39;-_&#39;);
<a name="l01301"></a>01301     $str = str_replace(&#39;=&#39;, &#39;&#39;, $str);
<a name="l01302"></a>01302     return $str;
<a name="l01303"></a>01303   }
<a name="l01304"></a>01304 <span class="comment"></span>
<a name="l01305"></a>01305 <span class="comment">  /**</span>
<a name="l01306"></a>01306 <span class="comment">   * Destroy the current session</span>
<a name="l01307"></a>01307 <span class="comment">   */</span>
<a name="l01308"></a><a class="code" href="classBaseFacebook.html#a4235356d20fcc14a74c1073b59948b65">01308</a>   public function destroySession() {
<a name="l01309"></a>01309     $this-&gt;accessToken = null;
<a name="l01310"></a>01310     $this-&gt;signedRequest = null;
<a name="l01311"></a>01311     $this-&gt;user = null;
<a name="l01312"></a>01312     $this-&gt;clearAllPersistentData();
<a name="l01313"></a>01313 
<a name="l01314"></a>01314     // Javascript sets a cookie that will be used in getSignedRequest that we
<a name="l01315"></a>01315     // need to clear if we can
<a name="l01316"></a>01316     $cookie_name = $this-&gt;getSignedRequestCookieName();
<a name="l01317"></a>01317     if (array_key_exists($cookie_name, $_COOKIE)) {
<a name="l01318"></a>01318       unset($_COOKIE[$cookie_name]);
<a name="l01319"></a>01319       if (!headers_sent()) {
<a name="l01320"></a>01320         $base_domain = $this-&gt;getBaseDomain();
<a name="l01321"></a>01321         setcookie($cookie_name, &#39;&#39;, 1, &#39;/&#39;, &#39;.&#39;.$base_domain);
<a name="l01322"></a>01322       } else {
<a name="l01323"></a>01323         // @codeCoverageIgnoreStart
<a name="l01324"></a>01324         self::errorLog(
<a name="l01325"></a>01325           &#39;There exists a cookie that we wanted to clear that we couldn\&#39;t &#39;.
<a name="l01326"></a>01326           &#39;clear because headers was already sent. Make sure to do the first &#39;.
<a name="l01327"></a>01327           &#39;API call before outputing anything.&#39;
<a name="l01328"></a>01328         );
<a name="l01329"></a>01329         // @codeCoverageIgnoreEnd
<a name="l01330"></a>01330       }
<a name="l01331"></a>01331     }
<a name="l01332"></a>01332   }
<a name="l01333"></a>01333 <span class="comment"></span>
<a name="l01334"></a>01334 <span class="comment">  /**</span>
<a name="l01335"></a>01335 <span class="comment">   * Parses the metadata cookie that our Javascript API set</span>
<a name="l01336"></a>01336 <span class="comment">   *</span>
<a name="l01337"></a>01337 <span class="comment">   * @return  an array mapping key to value</span>
<a name="l01338"></a>01338 <span class="comment">   */</span>
<a name="l01339"></a><a class="code" href="classBaseFacebook.html#a934183edea46236610bc661c92747c71">01339</a>   protected function getMetadataCookie() {
<a name="l01340"></a>01340     $cookie_name = $this-&gt;getMetadataCookieName();
<a name="l01341"></a>01341     if (!array_key_exists($cookie_name, $_COOKIE)) {
<a name="l01342"></a>01342       return array();
<a name="l01343"></a>01343     }
<a name="l01344"></a>01344 
<a name="l01345"></a>01345     // The cookie value can be wrapped in &quot;-characters so remove them
<a name="l01346"></a>01346     $cookie_value = trim($_COOKIE[$cookie_name], &#39;&quot;&#39;);
<a name="l01347"></a>01347 
<a name="l01348"></a>01348     if (empty($cookie_value)) {
<a name="l01349"></a>01349       return array();
<a name="l01350"></a>01350     }
<a name="l01351"></a>01351 
<a name="l01352"></a>01352     $parts = explode(&#39;&amp;&#39;, $cookie_value);
<a name="l01353"></a>01353     $metadata = array();
<a name="l01354"></a>01354     foreach ($parts as $part) {
<a name="l01355"></a>01355       $pair = explode(&#39;=&#39;, $part, 2);
<a name="l01356"></a>01356       if (!empty($pair[0])) {
<a name="l01357"></a>01357         $metadata[urldecode($pair[0])] =
<a name="l01358"></a>01358           (count($pair) &gt; 1) ? urldecode($pair[1]) : &#39;&#39;;
<a name="l01359"></a>01359       }
<a name="l01360"></a>01360     }
<a name="l01361"></a>01361 
<a name="l01362"></a>01362     return $metadata;
<a name="l01363"></a>01363   }
<a name="l01364"></a>01364 
<a name="l01365"></a><a class="code" href="classBaseFacebook.html#af9bbbb9875829d9f0dcbc9eff6524f43">01365</a>   protected static function isAllowedDomain($big, $small) {
<a name="l01366"></a>01366     if ($big === $small) {
<a name="l01367"></a>01367       return true;
<a name="l01368"></a>01368     }
<a name="l01369"></a>01369     return self::endsWith($big, &#39;.&#39;.$small);
<a name="l01370"></a>01370   }
<a name="l01371"></a>01371 
<a name="l01372"></a><a class="code" href="classBaseFacebook.html#a3d654f35a132f19cba844cb276bb09f3">01372</a>   protected static function endsWith($big, $small) {
<a name="l01373"></a>01373     $len = strlen($small);
<a name="l01374"></a>01374     if ($len === 0) {
<a name="l01375"></a>01375       return true;
<a name="l01376"></a>01376     }
<a name="l01377"></a>01377     return substr($big, -$len) === $small;
<a name="l01378"></a>01378   }
<a name="l01379"></a>01379 <span class="comment"></span>
<a name="l01380"></a>01380 <span class="comment">  /**</span>
<a name="l01381"></a>01381 <span class="comment">   * Each of the following four methods should be overridden in</span>
<a name="l01382"></a>01382 <span class="comment">   * a concrete subclass, as they are in the provided Facebook class.</span>
<a name="l01383"></a>01383 <span class="comment">   * The Facebook class uses PHP sessions to provide a primitive</span>
<a name="l01384"></a>01384 <span class="comment">   * persistent store, but another subclass--one that you implement--</span>
<a name="l01385"></a>01385 <span class="comment">   * might use a database, memcache, or an in-memory cache.</span>
<a name="l01386"></a>01386 <span class="comment">   *</span>
<a name="l01387"></a>01387 <span class="comment">   * @see Facebook</span>
<a name="l01388"></a>01388 <span class="comment">   */</span>
<a name="l01389"></a>01389 <span class="comment"></span>
<a name="l01390"></a>01390 <span class="comment">  /**</span>
<a name="l01391"></a>01391 <span class="comment">   * Stores the given ($key, $value) pair, so that future calls to</span>
<a name="l01392"></a>01392 <span class="comment">   * getPersistentData($key) return $value. This call may be in another request.</span>
<a name="l01393"></a>01393 <span class="comment">   *</span>
<a name="l01394"></a>01394 <span class="comment">   * @param string $key</span>
<a name="l01395"></a>01395 <span class="comment">   * @param array $value</span>
<a name="l01396"></a>01396 <span class="comment">   *</span>
<a name="l01397"></a>01397 <span class="comment">   * @return void</span>
<a name="l01398"></a>01398 <span class="comment">   */</span>
<a name="l01399"></a>01399   abstract protected function setPersistentData($key, $value);
<a name="l01400"></a>01400 <span class="comment"></span>
<a name="l01401"></a>01401 <span class="comment">  /**</span>
<a name="l01402"></a>01402 <span class="comment">   * Get the data for $key, persisted by BaseFacebook::setPersistentData()</span>
<a name="l01403"></a>01403 <span class="comment">   *</span>
<a name="l01404"></a>01404 <span class="comment">   * @param string $key The key of the data to retrieve</span>
<a name="l01405"></a>01405 <span class="comment">   * @param boolean $default The default value to return if $key is not found</span>
<a name="l01406"></a>01406 <span class="comment">   *</span>
<a name="l01407"></a>01407 <span class="comment">   * @return mixed</span>
<a name="l01408"></a>01408 <span class="comment">   */</span>
<a name="l01409"></a>01409   abstract protected function getPersistentData($key, $default = false);
<a name="l01410"></a>01410 <span class="comment"></span>
<a name="l01411"></a>01411 <span class="comment">  /**</span>
<a name="l01412"></a>01412 <span class="comment">   * Clear the data with $key from the persistent storage</span>
<a name="l01413"></a>01413 <span class="comment">   *</span>
<a name="l01414"></a>01414 <span class="comment">   * @param string $key</span>
<a name="l01415"></a>01415 <span class="comment">   * @return void</span>
<a name="l01416"></a>01416 <span class="comment">   */</span>
<a name="l01417"></a>01417   abstract protected function clearPersistentData($key);
<a name="l01418"></a>01418 <span class="comment"></span>
<a name="l01419"></a>01419 <span class="comment">  /**</span>
<a name="l01420"></a>01420 <span class="comment">   * Clear all data from the persistent storage</span>
<a name="l01421"></a>01421 <span class="comment">   *</span>
<a name="l01422"></a>01422 <span class="comment">   * @return void</span>
<a name="l01423"></a>01423 <span class="comment">   */</span>
<a name="l01424"></a>01424   abstract protected function clearAllPersistentData();
<a name="l01425"></a>01425 }
</pre></div></div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="base__facebook_8php.html">base_facebook.php</a>      </li>

    <li class="footer">Generated on Sat Apr 27 2013 13:22:24 for RFSCMSAPIDocumentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
