<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>RFSCMSAPIDocumentation: sqlparser.lib.php Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">RFSCMSAPIDocumentation
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('sqlparser_8lib_8php.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">sqlparser.lib.php</div>  </div>
</div><!--header-->
<div class="contents">
<a href="sqlparser_8lib_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 <span class="comment">/* vim: set expandtab sw=4 ts=4 sts=4: */</span><span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">/** SQL Parser Functions for phpMyAdmin</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * These functions define an SQL parser system, capable of understanding and</span>
<a name="l00006"></a>00006 <span class="comment"> * extracting data from a MySQL type SQL query.</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * The basic procedure for using the new SQL parser:</span>
<a name="l00009"></a>00009 <span class="comment"> * On any page that needs to extract data from a query or to pretty-print a</span>
<a name="l00010"></a>00010 <span class="comment"> * query, you need code like this up at the top:</span>
<a name="l00011"></a>00011 <span class="comment"> *</span>
<a name="l00012"></a>00012 <span class="comment"> * ($sql contains the query)</span>
<a name="l00013"></a>00013 <span class="comment"> * $parsed_sql = PMA_SQP_parse($sql);</span>
<a name="l00014"></a>00014 <span class="comment"> *</span>
<a name="l00015"></a>00015 <span class="comment"> * If you want to extract data from it then, you just need to run</span>
<a name="l00016"></a>00016 <span class="comment"> * $sql_info = PMA_SQP_analyze($parsed_sql);</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * See comments in PMA_SQP_analyze for the returned info</span>
<a name="l00019"></a>00019 <span class="comment"> * from the analyzer.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * If you want a pretty-printed version of the query, do:</span>
<a name="l00022"></a>00022 <span class="comment"> * $string = PMA_SQP_formatHtml($parsed_sql);</span>
<a name="l00023"></a>00023 <span class="comment"> * (note that that you need to have syntax.css.php included somehow in your</span>
<a name="l00024"></a>00024 <span class="comment"> * page for it to work, I recommend &#39;&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot;</span>
<a name="l00025"></a>00025 <span class="comment"> * href=&quot;syntax.css.php&quot; /&gt;&#39; at the moment.)</span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> * @package PhpMyAdmin</span>
<a name="l00028"></a>00028 <span class="comment"> */</span>
<a name="l00029"></a>00029 <span class="keywordflow">if</span> (! defined(<span class="stringliteral">&#39;PHPMYADMIN&#39;</span>)) {
<a name="l00030"></a>00030     <a class="code" href="footer_8inc_8php.html#a74ed6a30cde2182cef18dc4d7d998773" title="for PMA_setHistory()">exit</a>;
<a name="l00031"></a>00031 }
<a name="l00032"></a>00032 <span class="comment"></span>
<a name="l00033"></a>00033 <span class="comment">/**</span>
<a name="l00034"></a>00034 <span class="comment"> * Minimum inclusion? (i.e. for the stylesheet builder)</span>
<a name="l00035"></a>00035 <span class="comment"> */</span>
<a name="l00036"></a>00036 <span class="keywordflow">if</span> (! defined(<span class="stringliteral">&#39;PMA_MINIMUM_COMMON&#39;</span>)) {<span class="comment"></span>
<a name="l00037"></a>00037 <span class="comment">    /**</span>
<a name="l00038"></a>00038 <span class="comment">     * Include the string library as we use it heavily</span>
<a name="l00039"></a>00039 <span class="comment">     */</span>
<a name="l00040"></a>00040     include_once <span class="stringliteral">&#39;./libraries/string.lib.php&#39;</span>;
<a name="l00041"></a>00041 <span class="comment"></span>
<a name="l00042"></a>00042 <span class="comment">    /**</span>
<a name="l00043"></a>00043 <span class="comment">     * Include data for the SQL Parser</span>
<a name="l00044"></a>00044 <span class="comment">     */</span>
<a name="l00045"></a>00045     include_once <span class="stringliteral">&#39;./libraries/sqlparser.data.php&#39;</span>;
<a name="l00046"></a>00046     <span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;TESTSUITE&#39;</span>)) {
<a name="l00047"></a>00047         include_once <span class="stringliteral">&#39;./libraries/mysql_charsets.lib.php&#39;</span>;
<a name="l00048"></a>00048     }
<a name="l00049"></a>00049     <span class="keywordflow">if</span> (! isset($mysql_charsets)) {
<a name="l00050"></a>00050         $mysql_charsets = array();
<a name="l00051"></a>00051         $mysql_collations_flat = array();
<a name="l00052"></a>00052     }
<a name="l00053"></a>00053 
<a name="l00054"></a>00054     <span class="keywordflow">if</span> (!defined(<span class="stringliteral">&#39;DEBUG_TIMING&#39;</span>)) {<span class="comment"></span>
<a name="l00055"></a>00055 <span class="comment">        /**</span>
<a name="l00056"></a>00056 <span class="comment">         * currently we don&#39;t need the $pos (token position in query)</span>
<a name="l00057"></a>00057 <span class="comment">         * for other purposes than LIMIT clause verification,</span>
<a name="l00058"></a>00058 <span class="comment">         * so many calls to this function do not include the 4th parameter</span>
<a name="l00059"></a>00059 <span class="comment">         */</span>
<a name="l00060"></a>00060         <span class="keyword">function</span> PMA_SQP_arrayAdd(&amp;$arr, <a class="code" href="sp_8php.html#a9a4a6fba2208984cabb3afacadf33919">$type</a>, <a class="code" href="video__wall_8php.html#a6efc15b5a2314dd4b5aaa556a375c6d6">$data</a>, &amp;$arrsize, <a class="code" href="bs__disp__as__mime__type_8php.html#a5de51f0c80b3bb3b39a57b23f6b9ea9f">$pos</a> = 0)
<a name="l00061"></a>00061         {
<a name="l00062"></a>00062             $arr[] = array(<span class="stringliteral">&#39;type&#39;</span> =&gt; <a class="code" href="sp_8php.html#a9a4a6fba2208984cabb3afacadf33919">$type</a>, <span class="stringliteral">&#39;data&#39;</span> =&gt; <a class="code" href="video__wall_8php.html#a6efc15b5a2314dd4b5aaa556a375c6d6">$data</a>, <span class="stringliteral">&#39;pos&#39;</span> =&gt; <a class="code" href="bs__disp__as__mime__type_8php.html#a5de51f0c80b3bb3b39a57b23f6b9ea9f">$pos</a>);
<a name="l00063"></a>00063             $arrsize++;
<a name="l00064"></a>00064         } <span class="comment">// end of the &quot;PMA_SQP_arrayAdd()&quot; function</span>
<a name="l00065"></a>00065     } <span class="keywordflow">else</span> {<span class="comment"></span>
<a name="l00066"></a>00066 <span class="comment">        /**</span>
<a name="l00067"></a>00067 <span class="comment">         * This is debug variant of above.</span>
<a name="l00068"></a>00068 <span class="comment">         * @ignore</span>
<a name="l00069"></a>00069 <span class="comment">         */</span>
<a name="l00070"></a>00070         <span class="keyword">function</span> PMA_SQP_arrayAdd(&amp;$arr, <a class="code" href="sp_8php.html#a9a4a6fba2208984cabb3afacadf33919">$type</a>, <a class="code" href="video__wall_8php.html#a6efc15b5a2314dd4b5aaa556a375c6d6">$data</a>, &amp;$arrsize, <a class="code" href="bs__disp__as__mime__type_8php.html#a5de51f0c80b3bb3b39a57b23f6b9ea9f">$pos</a> = 0)
<a name="l00071"></a>00071         {
<a name="l00072"></a>00072             global $timer;
<a name="l00073"></a>00073 
<a name="l00074"></a>00074             $t     = $timer;
<a name="l00075"></a>00075             $arr[] = array(
<a name="l00076"></a>00076                 <span class="stringliteral">&#39;type&#39;</span> =&gt; <a class="code" href="sp_8php.html#a9a4a6fba2208984cabb3afacadf33919">$type</a>,
<a name="l00077"></a>00077                 <span class="stringliteral">&#39;data&#39;</span> =&gt; <a class="code" href="video__wall_8php.html#a6efc15b5a2314dd4b5aaa556a375c6d6">$data</a>,
<a name="l00078"></a>00078                 <span class="stringliteral">&#39;pos&#39;</span> =&gt; <a class="code" href="bs__disp__as__mime__type_8php.html#a5de51f0c80b3bb3b39a57b23f6b9ea9f">$pos</a>,
<a name="l00079"></a>00079                 <span class="stringliteral">&#39;time&#39;</span> =&gt; $t);
<a name="l00080"></a>00080             $timer = microtime();
<a name="l00081"></a>00081             $arrsize++;
<a name="l00082"></a>00082         } <span class="comment">// end of the &quot;PMA_SQP_arrayAdd()&quot; function</span>
<a name="l00083"></a>00083     } <span class="comment">// end if... else...</span>
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="comment"></span>
<a name="l00086"></a>00086 <span class="comment">    /**</span>
<a name="l00087"></a>00087 <span class="comment">     * Reset the error variable for the SQL parser</span>
<a name="l00088"></a>00088 <span class="comment">     *</span>
<a name="l00089"></a>00089 <span class="comment">     * @access public</span>
<a name="l00090"></a>00090 <span class="comment">     */</span>
<a name="l00091"></a>00091     <span class="keyword">function</span> PMA_SQP_resetError()
<a name="l00092"></a>00092     {
<a name="l00093"></a>00093         global $SQP_errorString;
<a name="l00094"></a>00094         $SQP_errorString = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00095"></a>00095         unset($SQP_errorString);
<a name="l00096"></a>00096     }
<a name="l00097"></a>00097 <span class="comment"></span>
<a name="l00098"></a>00098 <span class="comment">    /**</span>
<a name="l00099"></a>00099 <span class="comment">     * Get the contents of the error variable for the SQL parser</span>
<a name="l00100"></a>00100 <span class="comment">     *</span>
<a name="l00101"></a>00101 <span class="comment">     * @return string Error string from SQL parser</span>
<a name="l00102"></a>00102 <span class="comment">     *</span>
<a name="l00103"></a>00103 <span class="comment">     * @access public</span>
<a name="l00104"></a>00104 <span class="comment">     */</span>
<a name="l00105"></a>00105     <span class="keyword">function</span> PMA_SQP_getErrorString()
<a name="l00106"></a>00106     {
<a name="l00107"></a>00107         global $SQP_errorString;
<a name="l00108"></a>00108         <span class="keywordflow">return</span> isset($SQP_errorString) ? $SQP_errorString : <span class="stringliteral">&#39;&#39;</span>;
<a name="l00109"></a>00109     }
<a name="l00110"></a>00110 <span class="comment"></span>
<a name="l00111"></a>00111 <span class="comment">    /**</span>
<a name="l00112"></a>00112 <span class="comment">     * Check if the SQL parser hit an error</span>
<a name="l00113"></a>00113 <span class="comment">     *</span>
<a name="l00114"></a>00114 <span class="comment">     * @return boolean error state</span>
<a name="l00115"></a>00115 <span class="comment">     *</span>
<a name="l00116"></a>00116 <span class="comment">     * @access public</span>
<a name="l00117"></a>00117 <span class="comment">     */</span>
<a name="l00118"></a>00118     <span class="keyword">function</span> PMA_SQP_isError()
<a name="l00119"></a>00119     {
<a name="l00120"></a>00120         global $SQP_errorString;
<a name="l00121"></a>00121         <span class="keywordflow">return</span> isset($SQP_errorString) &amp;&amp; !empty($SQP_errorString);
<a name="l00122"></a>00122     }
<a name="l00123"></a>00123 <span class="comment"></span>
<a name="l00124"></a>00124 <span class="comment">    /**</span>
<a name="l00125"></a>00125 <span class="comment">     * Set an error message for the system</span>
<a name="l00126"></a>00126 <span class="comment">     *</span>
<a name="l00127"></a>00127 <span class="comment">     * @param string  The error message</span>
<a name="l00128"></a>00128 <span class="comment">     * @param string  The failing SQL query</span>
<a name="l00129"></a>00129 <span class="comment">     *</span>
<a name="l00130"></a>00130 <span class="comment">     * @access private</span>
<a name="l00131"></a>00131 <span class="comment">     * @scope SQL Parser internal</span>
<a name="l00132"></a>00132 <span class="comment">     */</span>
<a name="l00133"></a>00133     <span class="keyword">function</span> PMA_SQP_throwError(<a class="code" href="forums_8php.html#abf17cb2dba2ed17cb28aa5f37deb5293">$message</a>, <a class="code" href="ldi_8php.html#a778a0e0eff4555e51ea81fd9d2851e84">$sql</a>)
<a name="l00134"></a>00134     {
<a name="l00135"></a>00135         global $SQP_errorString;
<a name="l00136"></a>00136         $SQP_errorString = <span class="stringliteral">&#39;&lt;p&gt;&#39;</span>.__(<span class="stringliteral">&#39;There seems to be an error in your SQL query. The MySQL server error output below, if there is any, may also help you in diagnosing the problem&#39;</span>) . <span class="stringliteral">&#39;&lt;/p&gt;&#39;</span> . <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00137"></a>00137             . <span class="stringliteral">&#39;&lt;pre&gt;&#39;</span> . <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00138"></a>00138             . <span class="stringliteral">&#39;ERROR: &#39;</span> . <a class="code" href="forums_8php.html#abf17cb2dba2ed17cb28aa5f37deb5293">$message</a> . <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00139"></a>00139             . <span class="stringliteral">&#39;SQL: &#39;</span> . htmlspecialchars(<a class="code" href="ldi_8php.html#a778a0e0eff4555e51ea81fd9d2851e84">$sql</a>) .  <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00140"></a>00140             . <span class="stringliteral">&#39;&lt;/pre&gt;&#39;</span> . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142     } <span class="comment">// end of the &quot;PMA_SQP_throwError()&quot; function</span>
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 <span class="comment"></span>
<a name="l00145"></a>00145 <span class="comment">    /**</span>
<a name="l00146"></a>00146 <span class="comment">     * Do display the bug report</span>
<a name="l00147"></a>00147 <span class="comment">     *</span>
<a name="l00148"></a>00148 <span class="comment">     * @param string  The error message</span>
<a name="l00149"></a>00149 <span class="comment">     * @param string  The failing SQL query</span>
<a name="l00150"></a>00150 <span class="comment">     *</span>
<a name="l00151"></a>00151 <span class="comment">     * @access public</span>
<a name="l00152"></a>00152 <span class="comment">     */</span>
<a name="l00153"></a>00153     <span class="keyword">function</span> PMA_SQP_bug(<a class="code" href="forums_8php.html#abf17cb2dba2ed17cb28aa5f37deb5293">$message</a>, <a class="code" href="ldi_8php.html#a778a0e0eff4555e51ea81fd9d2851e84">$sql</a>)
<a name="l00154"></a>00154     {
<a name="l00155"></a>00155         global $SQP_errorString;
<a name="l00156"></a>00156         $debugstr = <span class="stringliteral">&#39;ERROR: &#39;</span> . <a class="code" href="forums_8php.html#abf17cb2dba2ed17cb28aa5f37deb5293">$message</a> . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00157"></a>00157         $debugstr .= <span class="stringliteral">&#39;MySQL: &#39;</span>.PMA_MYSQL_STR_VERSION . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00158"></a>00158         $debugstr .= <span class="stringliteral">&#39;USR OS, AGENT, VER: &#39;</span> . PMA_USR_OS . <span class="charliteral">&#39; &#39;</span>;
<a name="l00159"></a>00159         $debugstr .= PMA_USR_BROWSER_AGENT . <span class="charliteral">&#39; &#39;</span> . PMA_USR_BROWSER_VER . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00160"></a>00160         $debugstr .= <span class="stringliteral">&#39;PMA: &#39;</span> . PMA_VERSION . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00161"></a>00161         $debugstr .= <span class="stringliteral">&#39;PHP VER,OS: &#39;</span> . PMA_PHP_STR_VERSION . <span class="charliteral">&#39; &#39;</span> . PHP_OS . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00162"></a>00162         $debugstr .= <span class="stringliteral">&#39;LANG: &#39;</span> . <a class="code" href="config_2config_8php.html#aad108a6abffdea835bc6cc2f3244751e">$GLOBALS</a>[<span class="stringliteral">&#39;lang&#39;</span>] . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00163"></a>00163         $debugstr .= <span class="stringliteral">&#39;SQL: &#39;</span> . htmlspecialchars(<a class="code" href="ldi_8php.html#a778a0e0eff4555e51ea81fd9d2851e84">$sql</a>);
<a name="l00164"></a>00164 
<a name="l00165"></a>00165         $encodedstr     = $debugstr;
<a name="l00166"></a>00166         <span class="keywordflow">if</span> (@function_exists(<span class="stringliteral">&#39;gzcompress&#39;</span>)) {
<a name="l00167"></a>00167             $encodedstr = gzcompress($debugstr, 9);
<a name="l00168"></a>00168         }
<a name="l00169"></a>00169         $encodedstr     = preg_replace(
<a name="l00170"></a>00170             <span class="stringliteral">&quot;/(\015\012)|(\015)|(\012)/&quot;</span>,
<a name="l00171"></a>00171             <span class="stringliteral">&#39;&lt;br /&gt;&#39;</span> . <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00172"></a>00172             chunk_split(base64_encode($encodedstr)));
<a name="l00173"></a>00173 
<a name="l00174"></a>00174 
<a name="l00175"></a>00175         $SQP_errorString .= __(<span class="stringliteral">&#39;There is a chance that you may have found a bug in the SQL parser. Please examine your query closely, and check that the quotes are correct and not mis-matched. Other possible failure causes may be that you are uploading a file with binary outside of a quoted text area. You can also try your query on the MySQL command line interface. The MySQL server error output below, if there is any, may also help you in diagnosing the problem. If you still have problems or if the parser fails where the command line interface succeeds, please reduce your SQL query input to the single query that causes problems, and submit a bug report with the data chunk in the CUT section below:&#39;</span>)
<a name="l00176"></a>00176              . <span class="stringliteral">&#39;&lt;br /&gt;&#39;</span> . <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00177"></a>00177              . <span class="stringliteral">&#39;----&#39;</span> . __(<span class="stringliteral">&#39;BEGIN CUT&#39;</span>) . <span class="stringliteral">&#39;----&#39;</span> . <span class="stringliteral">&#39;&lt;br /&gt;&#39;</span> . <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00178"></a>00178              . $encodedstr . <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00179"></a>00179              . <span class="stringliteral">&#39;----&#39;</span> . __(<span class="stringliteral">&#39;END CUT&#39;</span>) . <span class="stringliteral">&#39;----&#39;</span> . <span class="stringliteral">&#39;&lt;br /&gt;&#39;</span> . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00180"></a>00180 
<a name="l00181"></a>00181         $SQP_errorString .= <span class="stringliteral">&#39;----&#39;</span> . __(<span class="stringliteral">&#39;BEGIN RAW&#39;</span>) . <span class="stringliteral">&#39;----&lt;br /&gt;&#39;</span> . <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00182"></a>00182              . <span class="stringliteral">&#39;&lt;pre&gt;&#39;</span> . <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00183"></a>00183              . $debugstr
<a name="l00184"></a>00184              . <span class="stringliteral">&#39;&lt;/pre&gt;&#39;</span> . <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00185"></a>00185              . <span class="stringliteral">&#39;----&#39;</span> . __(<span class="stringliteral">&#39;END RAW&#39;</span>) . <span class="stringliteral">&#39;----&lt;br /&gt;&#39;</span> . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187     } <span class="comment">// end of the &quot;PMA_SQP_bug()&quot; function</span>
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="comment"></span>
<a name="l00190"></a>00190 <span class="comment">    /**</span>
<a name="l00191"></a>00191 <span class="comment">     * Parses the SQL queries</span>
<a name="l00192"></a>00192 <span class="comment">     *</span>
<a name="l00193"></a>00193 <span class="comment">     * @param string   The SQL query list</span>
<a name="l00194"></a>00194 <span class="comment">     *</span>
<a name="l00195"></a>00195 <span class="comment">     * @return mixed    Most of times, nothing...</span>
<a name="l00196"></a>00196 <span class="comment">     *</span>
<a name="l00197"></a>00197 <span class="comment">     * @global array    The current PMA configuration</span>
<a name="l00198"></a>00198 <span class="comment">     * @global array    MySQL column attributes</span>
<a name="l00199"></a>00199 <span class="comment">     * @global array    MySQL reserved words</span>
<a name="l00200"></a>00200 <span class="comment">     * @global array    MySQL column types</span>
<a name="l00201"></a>00201 <span class="comment">     * @global array    MySQL function names</span>
<a name="l00202"></a>00202 <span class="comment">     * @global array    List of available character sets</span>
<a name="l00203"></a>00203 <span class="comment">     * @global array    List of available collations</span>
<a name="l00204"></a>00204 <span class="comment">     *</span>
<a name="l00205"></a>00205 <span class="comment">     * @access public</span>
<a name="l00206"></a>00206 <span class="comment">     */</span>
<a name="l00207"></a>00207     <span class="keyword">function</span> PMA_SQP_parse(<a class="code" href="ldi_8php.html#a778a0e0eff4555e51ea81fd9d2851e84">$sql</a>)
<a name="l00208"></a>00208     {
<a name="l00209"></a>00209         <span class="keyword">static</span> <a class="code" href="sqlparser_8data_8php.html#a8bd91a50dcc302de72ea22696d9745fb" title="array MySQL attributes">$PMA_SQPdata_column_attrib</a>, <a class="code" href="sqlparser_8data_8php.html#a42da272ba228cb51484cc9c9866a686b" title="words that are reserved by MySQL and may not be used as identifiers without quotes">$PMA_SQPdata_reserved_word</a>;
<a name="l00210"></a>00210         <span class="keyword">static</span> <a class="code" href="sqlparser_8data_8php.html#a48da959f268ade600c0bd5d248774420" title="the MySQL column/data types">$PMA_SQPdata_column_type</a>;
<a name="l00211"></a>00211         <span class="keyword">static</span> <a class="code" href="sqlparser_8data_8php.html#a1192efca519d82b6d7c1abc99a009827" title="array MySQL function names">$PMA_SQPdata_function_name</a>, <a class="code" href="sqlparser_8data_8php.html#a22967b72bd8e6c6d0227863ad7ca9a00" title="words forbidden to be used as column or table name wihtout quotes as seen in http://dev.mysql.com/doc/mysql/en/reserved-words.html">$PMA_SQPdata_forbidden_word</a>;
<a name="l00212"></a>00212         global $mysql_charsets, $mysql_collations_flat;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214         <span class="comment">// Convert all line feeds to Unix style</span>
<a name="l00215"></a>00215         <a class="code" href="ldi_8php.html#a778a0e0eff4555e51ea81fd9d2851e84">$sql</a> = str_replace(<span class="stringliteral">&quot;\r\n&quot;</span>, <span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="ldi_8php.html#a778a0e0eff4555e51ea81fd9d2851e84">$sql</a>);
<a name="l00216"></a>00216         <a class="code" href="ldi_8php.html#a778a0e0eff4555e51ea81fd9d2851e84">$sql</a> = str_replace(<span class="stringliteral">&quot;\r&quot;</span>, <span class="stringliteral">&quot;\n&quot;</span>, <a class="code" href="ldi_8php.html#a778a0e0eff4555e51ea81fd9d2851e84">$sql</a>);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218         <a class="code" href="import_2csv_8php.html#aa28657aaa5fcc7509dd883662f8accbe">$len</a> = <a class="code" href="string__mb_8lib_8php.html#a7d2b5c0ddb1f11882d037a29bf551ec0" title="Returns length of string depending on current charset.">PMA_strlen</a>(<a class="code" href="ldi_8php.html#a778a0e0eff4555e51ea81fd9d2851e84">$sql</a>);
<a name="l00219"></a>00219         <span class="keywordflow">if</span> (<a class="code" href="import_2csv_8php.html#aa28657aaa5fcc7509dd883662f8accbe">$len</a> == 0) {
<a name="l00220"></a>00220             <span class="keywordflow">return</span> array();
<a name="l00221"></a>00221         }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223         <span class="comment">// Create local hashtables</span>
<a name="l00224"></a>00224         <span class="keywordflow">if</span> (!isset(<a class="code" href="sqlparser_8data_8php.html#a8bd91a50dcc302de72ea22696d9745fb" title="array MySQL attributes">$PMA_SQPdata_column_attrib</a>)) {
<a name="l00225"></a>00225             <a class="code" href="sqlparser_8data_8php.html#a8bd91a50dcc302de72ea22696d9745fb" title="array MySQL attributes">$PMA_SQPdata_column_attrib</a>  = array_flip(
<a name="l00226"></a>00226                 <a class="code" href="config_2config_8php.html#aad108a6abffdea835bc6cc2f3244751e">$GLOBALS</a>[<span class="stringliteral">&#39;PMA_SQPdata_column_attrib&#39;</span>]
<a name="l00227"></a>00227                 );
<a name="l00228"></a>00228             <a class="code" href="sqlparser_8data_8php.html#a1192efca519d82b6d7c1abc99a009827" title="array MySQL function names">$PMA_SQPdata_function_name</a>  = array_flip(
<a name="l00229"></a>00229                 <a class="code" href="config_2config_8php.html#aad108a6abffdea835bc6cc2f3244751e">$GLOBALS</a>[<span class="stringliteral">&#39;PMA_SQPdata_function_name&#39;</span>]
<a name="l00230"></a>00230                 );
<a name="l00231"></a>00231             $PMA_SQPdata_reserved_word  = array_flip(
<a name="l00232"></a>00232                 <a class="code" href="config_2config_8php.html#aad108a6abffdea835bc6cc2f3244751e">$GLOBALS</a>[<span class="stringliteral">&#39;PMA_SQPdata_reserved_word&#39;</span>]
<a name="l00233"></a>00233                 );
<a name="l00234"></a>00234             $PMA_SQPdata_forbidden_word = array_flip(
<a name="l00235"></a>00235                 <a class="code" href="config_2config_8php.html#aad108a6abffdea835bc6cc2f3244751e">$GLOBALS</a>[<span class="stringliteral">&#39;PMA_SQPdata_forbidden_word&#39;</span>]
<a name="l00236"></a>00236                 );
<a name="l00237"></a>00237             <a class="code" href="sqlparser_8data_8php.html#a48da959f268ade600c0bd5d248774420" title="the MySQL column/data types">$PMA_SQPdata_column_type</a>    = array_flip(
<a name="l00238"></a>00238                 <a class="code" href="config_2config_8php.html#aad108a6abffdea835bc6cc2f3244751e">$GLOBALS</a>[<span class="stringliteral">&#39;PMA_SQPdata_column_type&#39;</span>]
<a name="l00239"></a>00239                 );
<a name="l00240"></a>00240         }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242         $sql_array               = array();
<a name="l00243"></a>00243         $sql_array[<span class="stringliteral">&#39;raw&#39;</span>]        = <a class="code" href="ldi_8php.html#a778a0e0eff4555e51ea81fd9d2851e84">$sql</a>;
<a name="l00244"></a>00244         $count1                  = 0;
<a name="l00245"></a>00245         $count2                  = 0;
<a name="l00246"></a>00246         $punct_queryend          = <span class="charliteral">&#39;;&#39;</span>;
<a name="l00247"></a>00247         $punct_qualifier         = <span class="charliteral">&#39;.&#39;</span>;
<a name="l00248"></a>00248         $punct_listsep           = <span class="charliteral">&#39;,&#39;</span>;
<a name="l00249"></a>00249         $punct_level_plus        = <span class="charliteral">&#39;(&#39;</span>;
<a name="l00250"></a>00250         $punct_level_minus       = <span class="charliteral">&#39;)&#39;</span>;
<a name="l00251"></a>00251         $punct_user              = <span class="charliteral">&#39;@&#39;</span>;
<a name="l00252"></a>00252         $digit_floatdecimal      = <span class="charliteral">&#39;.&#39;</span>;
<a name="l00253"></a>00253         $digit_hexset            = <span class="charliteral">&#39;x&#39;</span>;
<a name="l00254"></a>00254         $bracket_list            = <span class="stringliteral">&#39;()[]{}&#39;</span>;
<a name="l00255"></a>00255         $allpunct_list           =  <span class="stringliteral">&#39;-,;:!?/.^~\*&amp;%+&lt;=&gt;|&#39;</span>;
<a name="l00256"></a>00256         $allpunct_list_pair      = array(
<a name="l00257"></a>00257             <span class="stringliteral">&#39;!=&#39;</span> =&gt; 1,
<a name="l00258"></a>00258             <span class="stringliteral">&#39;&amp;&amp;&#39;</span> =&gt; 1,
<a name="l00259"></a>00259             <span class="stringliteral">&#39;:=&#39;</span> =&gt; 1,
<a name="l00260"></a>00260             <span class="stringliteral">&#39;&lt;&lt;&#39;</span> =&gt; 1,
<a name="l00261"></a>00261             <span class="stringliteral">&#39;&lt;=&#39;</span> =&gt; 1,
<a name="l00262"></a>00262             <span class="stringliteral">&#39;&lt;=&gt;&#39;</span> =&gt; 1,
<a name="l00263"></a>00263             <span class="stringliteral">&#39;&lt;&gt;&#39;</span> =&gt; 1,
<a name="l00264"></a>00264             <span class="stringliteral">&#39;&gt;=&#39;</span> =&gt; 1,
<a name="l00265"></a>00265             <span class="stringliteral">&#39;&gt;&gt;&#39;</span> =&gt; 1,
<a name="l00266"></a>00266             <span class="stringliteral">&#39;||&#39;</span> =&gt; 1,
<a name="l00267"></a>00267             <span class="stringliteral">&#39;==&#39;</span> =&gt; 1
<a name="l00268"></a>00268         );
<a name="l00269"></a>00269         $quote_list              = <span class="charliteral">&#39;\&#39;</span><span class="stringliteral">&quot;`&#39;;</span>
<a name="l00270"></a>00270 <span class="stringliteral">        $arraysize               = 0;</span>
<a name="l00271"></a>00271 <span class="stringliteral"></span>
<a name="l00272"></a>00272 <span class="stringliteral">        $previous_was_space   = false;</span>
<a name="l00273"></a>00273 <span class="stringliteral">        $this_was_space       = false;</span>
<a name="l00274"></a>00274 <span class="stringliteral">        $previous_was_bracket = false;</span>
<a name="l00275"></a>00275 <span class="stringliteral">        $this_was_bracket     = false;</span>
<a name="l00276"></a>00276 <span class="stringliteral">        $previous_was_punct   = false;</span>
<a name="l00277"></a>00277 <span class="stringliteral">        $this_was_punct       = false;</span>
<a name="l00278"></a>00278 <span class="stringliteral">        $previous_was_listsep = false;</span>
<a name="l00279"></a>00279 <span class="stringliteral">        $this_was_listsep     = false;</span>
<a name="l00280"></a>00280 <span class="stringliteral">        $previous_was_quote   = false;</span>
<a name="l00281"></a>00281 <span class="stringliteral">        $this_was_quote       = false;</span>
<a name="l00282"></a>00282 <span class="stringliteral"></span>
<a name="l00283"></a>00283 <span class="stringliteral">        while ($count2 &lt; $len) {</span>
<a name="l00284"></a>00284 <span class="stringliteral">            $c      = PMA_substr($sql, $count2, 1);</span>
<a name="l00285"></a>00285 <span class="stringliteral">            $count1 = $count2;</span>
<a name="l00286"></a>00286 <span class="stringliteral"></span>
<a name="l00287"></a>00287 <span class="stringliteral">            $previous_was_space = $this_was_space;</span>
<a name="l00288"></a>00288 <span class="stringliteral">            $this_was_space = false;</span>
<a name="l00289"></a>00289 <span class="stringliteral">            $previous_was_bracket = $this_was_bracket;</span>
<a name="l00290"></a>00290 <span class="stringliteral">            $this_was_bracket = false;</span>
<a name="l00291"></a>00291 <span class="stringliteral">            $previous_was_punct = $this_was_punct;</span>
<a name="l00292"></a>00292 <span class="stringliteral">            $this_was_punct = false;</span>
<a name="l00293"></a>00293 <span class="stringliteral">            $previous_was_listsep = $this_was_listsep;</span>
<a name="l00294"></a>00294 <span class="stringliteral">            $this_was_listsep = false;</span>
<a name="l00295"></a>00295 <span class="stringliteral">            $previous_was_quote = $this_was_quote;</span>
<a name="l00296"></a>00296 <span class="stringliteral">            $this_was_quote = false;</span>
<a name="l00297"></a>00297 <span class="stringliteral"></span>
<a name="l00298"></a>00298 <span class="stringliteral">            if (($c == &quot;</span>\n<span class="stringliteral">&quot;)) {</span>
<a name="l00299"></a>00299 <span class="stringliteral">                $this_was_space = true;</span>
<a name="l00300"></a>00300 <span class="stringliteral">                $count2++;</span>
<a name="l00301"></a>00301 <span class="stringliteral">                PMA_SQP_arrayAdd($sql_array, &#39;white_newline&#39;, &#39;&#39;, $arraysize);</span>
<a name="l00302"></a>00302 <span class="stringliteral">                continue;</span>
<a name="l00303"></a>00303 <span class="stringliteral">            }</span>
<a name="l00304"></a>00304 <span class="stringliteral"></span>
<a name="l00305"></a>00305 <span class="stringliteral">            // Checks for white space</span>
<a name="l00306"></a>00306 <span class="stringliteral">            if (PMA_STR_isSpace($c)) {</span>
<a name="l00307"></a>00307 <span class="stringliteral">                $this_was_space = true;</span>
<a name="l00308"></a>00308 <span class="stringliteral">                $count2++;</span>
<a name="l00309"></a>00309 <span class="stringliteral">                continue;</span>
<a name="l00310"></a>00310 <span class="stringliteral">            }</span>
<a name="l00311"></a>00311 <span class="stringliteral"></span>
<a name="l00312"></a>00312 <span class="stringliteral">            // Checks for comment lines.</span>
<a name="l00313"></a>00313 <span class="stringliteral">            // MySQL style #</span>
<a name="l00314"></a>00314 <span class="stringliteral">            // C style /* */</span>
<a name="l00315"></a>00315 <span class="stringliteral">            // ANSI style --</span>
<a name="l00316"></a>00316 <span class="stringliteral">            $next_c = PMA_substr($sql, $count2 + 1, 1);</span>
<a name="l00317"></a>00317 <span class="stringliteral">            if (($c == &#39;#&#39;)</span>
<a name="l00318"></a>00318 <span class="stringliteral">                || (($count2 + 1 &lt; $len) &amp;&amp; ($c == &#39;/&#39;) &amp;&amp; ($next_c == &#39;*&#39;))</span>
<a name="l00319"></a>00319 <span class="stringliteral">                || (($count2 + 2 == $len) &amp;&amp; ($c == &#39;-&#39;) &amp;&amp; ($next_c == &#39;-&#39;))</span>
<a name="l00320"></a>00320 <span class="stringliteral">                || (($count2 + 2 &lt; $len) &amp;&amp; ($c == &#39;-&#39;) &amp;&amp; ($next_c == &#39;-&#39;) &amp;&amp; ((PMA_substr($sql, $count2 + 2, 1) &lt;= &#39; &#39;)))) {</span>
<a name="l00321"></a>00321 <span class="stringliteral">                $count2++;</span>
<a name="l00322"></a>00322 <span class="stringliteral">                $pos  = 0;</span>
<a name="l00323"></a>00323 <span class="stringliteral">                $type = &#39;bad&#39;;</span>
<a name="l00324"></a>00324 <span class="stringliteral">                switch ($c) {</span>
<a name="l00325"></a>00325 <span class="stringliteral">                case &#39;#&#39;:</span>
<a name="l00326"></a>00326 <span class="stringliteral">                    $type = &#39;mysql&#39;;</span>
<a name="l00327"></a>00327 <span class="stringliteral">                case &#39;-&#39;:</span>
<a name="l00328"></a>00328 <span class="stringliteral">                    $type = &#39;ansi&#39;;</span>
<a name="l00329"></a>00329 <span class="stringliteral">                    $pos  = PMA_strpos($sql, &quot;</span>\n<span class="stringliteral">&quot;, $count2);</span>
<a name="l00330"></a>00330 <span class="stringliteral">                    break;</span>
<a name="l00331"></a>00331 <span class="stringliteral">                case &#39;/&#39;:</span>
<a name="l00332"></a>00332 <span class="stringliteral">                    $type = &#39;c&#39;;</span>
<a name="l00333"></a>00333 <span class="stringliteral">                    $pos  = PMA_strpos($sql, &#39;*/&#39;, $count2);</span>
<a name="l00334"></a>00334 <span class="stringliteral">                    $pos  += 2;</span>
<a name="l00335"></a>00335 <span class="stringliteral">                    break;</span>
<a name="l00336"></a>00336 <span class="stringliteral">                default:</span>
<a name="l00337"></a>00337 <span class="stringliteral">                    break;</span>
<a name="l00338"></a>00338 <span class="stringliteral">                } // end switch</span>
<a name="l00339"></a>00339 <span class="stringliteral">                $count2 = ($pos &lt; $count2) ? $len : $pos;</span>
<a name="l00340"></a>00340 <span class="stringliteral">                $str    = PMA_substr($sql, $count1, $count2 - $count1);</span>
<a name="l00341"></a>00341 <span class="stringliteral">                PMA_SQP_arrayAdd($sql_array, &#39;comment_&#39; . $type, $str, $arraysize);</span>
<a name="l00342"></a>00342 <span class="stringliteral">                continue;</span>
<a name="l00343"></a>00343 <span class="stringliteral">            } // end if</span>
<a name="l00344"></a>00344 <span class="stringliteral"></span>
<a name="l00345"></a>00345 <span class="stringliteral">            // Checks for something inside quotation marks</span>
<a name="l00346"></a>00346 <span class="stringliteral">            if (PMA_strpos($quote_list, $c) !== false) {</span>
<a name="l00347"></a>00347 <span class="stringliteral">                $startquotepos   = $count2;</span>
<a name="l00348"></a>00348 <span class="stringliteral">                $quotetype       = $c;</span>
<a name="l00349"></a>00349 <span class="stringliteral">                $count2++;</span>
<a name="l00350"></a>00350 <span class="stringliteral">                $escaped         = false;</span>
<a name="l00351"></a>00351 <span class="stringliteral">                $pos             = $count2;</span>
<a name="l00352"></a>00352 <span class="stringliteral">                $oldpos          = 0;</span>
<a name="l00353"></a>00353 <span class="stringliteral">                do {</span>
<a name="l00354"></a>00354 <span class="stringliteral">                    $oldpos = $pos;</span>
<a name="l00355"></a>00355 <span class="stringliteral">                    $pos    = PMA_strpos(&#39; &#39; . $sql, $quotetype, $oldpos + 1) - 1;</span>
<a name="l00356"></a>00356 <span class="stringliteral">                    // ($pos === false)</span>
<a name="l00357"></a>00357 <span class="stringliteral">                    if ($pos &lt; 0) {</span>
<a name="l00358"></a>00358 <span class="stringliteral">                        if ($c == &#39;`&#39;) {</span>
<a name="l00359"></a>00359 <span class="stringliteral">                            /*</span>
<a name="l00360"></a>00360 <span class="stringliteral">                             * Behave same as MySQL and accept end of query as end of backtick.</span>
<a name="l00361"></a>00361 <span class="stringliteral">                             * I know this is sick, but MySQL behaves like this:</span>
<a name="l00362"></a>00362 <span class="stringliteral">                             *</span>
<a name="l00363"></a>00363 <span class="stringliteral">                             * SELECT * FROM `table</span>
<a name="l00364"></a>00364 <span class="stringliteral">                             *</span>
<a name="l00365"></a>00365 <span class="stringliteral">                             * is treated like</span>
<a name="l00366"></a>00366 <span class="stringliteral">                             *</span>
<a name="l00367"></a>00367 <span class="stringliteral">                             * SELECT * FROM `table`</span>
<a name="l00368"></a>00368 <span class="stringliteral">                             */</span>
<a name="l00369"></a>00369 <span class="stringliteral">                            $pos_quote_separator = PMA_strpos(&#39; &#39; . $sql, $GLOBALS[&#39;sql_delimiter&#39;], $oldpos + 1) - 1;</span>
<a name="l00370"></a>00370 <span class="stringliteral">                            if ($pos_quote_separator &lt; 0) {</span>
<a name="l00371"></a>00371 <span class="stringliteral">                                $len += 1;</span>
<a name="l00372"></a>00372 <span class="stringliteral">                                $sql .= &#39;`&#39;;</span>
<a name="l00373"></a>00373 <span class="stringliteral">                                $sql_array[&#39;raw&#39;] .= &#39;`&#39;;</span>
<a name="l00374"></a>00374 <span class="stringliteral">                                $pos = $len;</span>
<a name="l00375"></a>00375 <span class="stringliteral">                            } else {</span>
<a name="l00376"></a>00376 <span class="stringliteral">                                $len += 1;</span>
<a name="l00377"></a>00377 <span class="stringliteral">                                $sql = PMA_substr($sql, 0, $pos_quote_separator) . &#39;`&#39; . PMA_substr($sql, $pos_quote_separator);</span>
<a name="l00378"></a>00378 <span class="stringliteral">                                $sql_array[&#39;raw&#39;] = $sql;</span>
<a name="l00379"></a>00379 <span class="stringliteral">                                $pos = $pos_quote_separator;</span>
<a name="l00380"></a>00380 <span class="stringliteral">                            }</span>
<a name="l00381"></a>00381 <span class="stringliteral">                            if (class_exists(&#39;PMA_Message&#39;) &amp;&amp; $GLOBALS[&#39;is_ajax_request&#39;] != true) {</span>
<a name="l00382"></a>00382 <span class="stringliteral">                                PMA_Message::notice(__(&#39;Automatically appended backtick to the end of query!&#39;))-&gt;display();</span>
<a name="l00383"></a>00383 <span class="stringliteral">                            }</span>
<a name="l00384"></a>00384 <span class="stringliteral">                        } else {</span>
<a name="l00385"></a>00385 <span class="stringliteral">                            $debugstr = __(&#39;Unclosed quote&#39;) . &#39; @ &#39; . $startquotepos. &quot;</span>\n<span class="stringliteral">&quot;</span>
<a name="l00386"></a>00386 <span class="stringliteral">                                      . &#39;STR: &#39; . htmlspecialchars($quotetype);</span>
<a name="l00387"></a>00387 <span class="stringliteral">                            PMA_SQP_throwError($debugstr, $sql);</span>
<a name="l00388"></a>00388 <span class="stringliteral">                            return $sql_array;</span>
<a name="l00389"></a>00389 <span class="stringliteral">                        }</span>
<a name="l00390"></a>00390 <span class="stringliteral">                    }</span>
<a name="l00391"></a>00391 <span class="stringliteral"></span>
<a name="l00392"></a>00392 <span class="stringliteral">                    // If the quote is the first character, it can&#39;t be</span>
<a name="l00393"></a>00393 <span class="stringliteral">                    // escaped, so don&#39;t do the rest of the code</span>
<a name="l00394"></a>00394 <span class="stringliteral">                    if ($pos == 0) {</span>
<a name="l00395"></a>00395 <span class="stringliteral">                        break;</span>
<a name="l00396"></a>00396 <span class="stringliteral">                    }</span>
<a name="l00397"></a>00397 <span class="stringliteral"></span>
<a name="l00398"></a>00398 <span class="stringliteral">                    // Checks for MySQL escaping using a \</span>
<a name="l00399"></a>00399 <span class="stringliteral">                    // And checks for ANSI escaping using the $quotetype character</span>
<a name="l00400"></a>00400 <span class="stringliteral">                    if (($pos &lt; $len) &amp;&amp; PMA_STR_charIsEscaped($sql, $pos) &amp;&amp; $c != &#39;`&#39;) {</span>
<a name="l00401"></a>00401 <span class="stringliteral">                        $pos ++;</span>
<a name="l00402"></a>00402 <span class="stringliteral">                        continue;</span>
<a name="l00403"></a>00403 <span class="stringliteral">                    } elseif (($pos + 1 &lt; $len) &amp;&amp; (PMA_substr($sql, $pos, 1) == $quotetype) &amp;&amp; (PMA_substr($sql, $pos + 1, 1) == $quotetype)) {</span>
<a name="l00404"></a>00404 <span class="stringliteral">                        $pos = $pos + 2;</span>
<a name="l00405"></a>00405 <span class="stringliteral">                        continue;</span>
<a name="l00406"></a>00406 <span class="stringliteral">                    } else {</span>
<a name="l00407"></a>00407 <span class="stringliteral">                        break;</span>
<a name="l00408"></a>00408 <span class="stringliteral">                    }</span>
<a name="l00409"></a>00409 <span class="stringliteral">                } while ($len &gt; $pos); // end do</span>
<a name="l00410"></a>00410 <span class="stringliteral"></span>
<a name="l00411"></a>00411 <span class="stringliteral">                $count2       = $pos;</span>
<a name="l00412"></a>00412 <span class="stringliteral">                $count2++;</span>
<a name="l00413"></a>00413 <span class="stringliteral">                $type         = &#39;quote_&#39;;</span>
<a name="l00414"></a>00414 <span class="stringliteral">                switch ($quotetype) {</span>
<a name="l00415"></a>00415 <span class="stringliteral">                case &#39;\&#39;&#39;:</span>
<a name="l00416"></a>00416 <span class="stringliteral">                    $type .= &#39;single&#39;;</span>
<a name="l00417"></a>00417 <span class="stringliteral">                    $this_was_quote = true;</span>
<a name="l00418"></a>00418 <span class="stringliteral">                    break;</span>
<a name="l00419"></a>00419 <span class="stringliteral">                case &#39;&quot;</span><span class="stringliteral">&#39;:</span>
<a name="l00420"></a>00420 <span class="stringliteral">                    $type .= &#39;</span><span class="keywordtype">double</span><span class="stringliteral">&#39;;</span>
<a name="l00421"></a>00421 <span class="stringliteral">                    $this_was_quote = true;</span>
<a name="l00422"></a>00422 <span class="stringliteral">                    break;</span>
<a name="l00423"></a>00423 <span class="stringliteral">                case &#39;</span>`<span class="stringliteral">&#39;:</span>
<a name="l00424"></a>00424 <span class="stringliteral">                    $type .= &#39;</span>backtick<span class="stringliteral">&#39;;</span>
<a name="l00425"></a>00425 <span class="stringliteral">                    $this_was_quote = true;</span>
<a name="l00426"></a>00426 <span class="stringliteral">                    break;</span>
<a name="l00427"></a>00427 <span class="stringliteral">                default:</span>
<a name="l00428"></a>00428 <span class="stringliteral">                    break;</span>
<a name="l00429"></a>00429 <span class="stringliteral">                } // end switch</span>
<a name="l00430"></a>00430 <span class="stringliteral">                $data = PMA_substr($sql, $count1, $count2 - $count1);</span>
<a name="l00431"></a>00431 <span class="stringliteral">                PMA_SQP_arrayAdd($sql_array, $type, $data, $arraysize);</span>
<a name="l00432"></a>00432 <span class="stringliteral">                continue;</span>
<a name="l00433"></a>00433 <span class="stringliteral">            }</span>
<a name="l00434"></a>00434 <span class="stringliteral"></span>
<a name="l00435"></a>00435 <span class="stringliteral">            // Checks for brackets</span>
<a name="l00436"></a>00436 <span class="stringliteral">            if (PMA_strpos($bracket_list, $c) !== false) {</span>
<a name="l00437"></a>00437 <span class="stringliteral">                // All bracket tokens are only one item long</span>
<a name="l00438"></a>00438 <span class="stringliteral">                $this_was_bracket = true;</span>
<a name="l00439"></a>00439 <span class="stringliteral">                $count2++;</span>
<a name="l00440"></a>00440 <span class="stringliteral">                $type_type     = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00441"></a>00441 <span class="stringliteral">                if (PMA_strpos(&#39;</span>([{<span class="stringliteral">&#39;, $c) !== false) {</span>
<a name="l00442"></a>00442 <span class="stringliteral">                    $type_type = &#39;</span>open<span class="stringliteral">&#39;;</span>
<a name="l00443"></a>00443 <span class="stringliteral">                } else {</span>
<a name="l00444"></a>00444 <span class="stringliteral">                    $type_type = &#39;</span>close<span class="stringliteral">&#39;;</span>
<a name="l00445"></a>00445 <span class="stringliteral">                }</span>
<a name="l00446"></a>00446 <span class="stringliteral"></span>
<a name="l00447"></a>00447 <span class="stringliteral">                $type_style     = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00448"></a>00448 <span class="stringliteral">                if (PMA_strpos(&#39;</span>()<span class="stringliteral">&#39;, $c) !== false) {</span>
<a name="l00449"></a>00449 <span class="stringliteral">                    $type_style = &#39;</span>round<span class="stringliteral">&#39;;</span>
<a name="l00450"></a>00450 <span class="stringliteral">                } elseif (PMA_strpos(&#39;</span>[]<span class="stringliteral">&#39;, $c) !== false) {</span>
<a name="l00451"></a>00451 <span class="stringliteral">                    $type_style = &#39;</span>square<span class="stringliteral">&#39;;</span>
<a name="l00452"></a>00452 <span class="stringliteral">                } else {</span>
<a name="l00453"></a>00453 <span class="stringliteral">                    $type_style = &#39;</span>curly<span class="stringliteral">&#39;;</span>
<a name="l00454"></a>00454 <span class="stringliteral">                }</span>
<a name="l00455"></a>00455 <span class="stringliteral"></span>
<a name="l00456"></a>00456 <span class="stringliteral">                $type = &#39;</span>punct_bracket_<span class="stringliteral">&#39; . $type_type . &#39;</span>_<span class="stringliteral">&#39; . $type_style;</span>
<a name="l00457"></a>00457 <span class="stringliteral">                PMA_SQP_arrayAdd($sql_array, $type, $c, $arraysize);</span>
<a name="l00458"></a>00458 <span class="stringliteral">                continue;</span>
<a name="l00459"></a>00459 <span class="stringliteral">            }</span>
<a name="l00460"></a>00460 <span class="stringliteral"></span>
<a name="l00461"></a>00461 <span class="stringliteral">            /* DEBUG</span>
<a name="l00462"></a>00462 <span class="stringliteral">            echo &#39;</span>&lt;pre&gt;1<span class="stringliteral">&#39;;</span>
<a name="l00463"></a>00463 <span class="stringliteral">            var_dump(PMA_STR_isSqlIdentifier($c, false));</span>
<a name="l00464"></a>00464 <span class="stringliteral">            var_dump($c == &#39;</span>@<span class="stringliteral">&#39;);</span>
<a name="l00465"></a>00465 <span class="stringliteral">            var_dump($c == &#39;</span>.<span class="stringliteral">&#39;);</span>
<a name="l00466"></a>00466 <span class="stringliteral">            var_dump(PMA_STR_isDigit(PMA_substr($sql, $count2 + 1, 1)));</span>
<a name="l00467"></a>00467 <span class="stringliteral">            var_dump($previous_was_space);</span>
<a name="l00468"></a>00468 <span class="stringliteral">            var_dump($previous_was_bracket);</span>
<a name="l00469"></a>00469 <span class="stringliteral">            var_dump($previous_was_listsep);</span>
<a name="l00470"></a>00470 <span class="stringliteral">            echo &#39;</span>&lt;/pre&gt;<span class="stringliteral">&#39;;</span>
<a name="l00471"></a>00471 <span class="stringliteral">            */</span>
<a name="l00472"></a>00472 <span class="stringliteral"></span>
<a name="l00473"></a>00473 <span class="stringliteral">            // Checks for identifier (alpha or numeric)</span>
<a name="l00474"></a>00474 <span class="stringliteral">            if (PMA_STR_isSqlIdentifier($c, false)</span>
<a name="l00475"></a>00475 <span class="stringliteral">             || $c == &#39;</span>@<span class="stringliteral">&#39;</span>
<a name="l00476"></a>00476 <span class="stringliteral">             || ($c == &#39;</span>.<span class="stringliteral">&#39;</span>
<a name="l00477"></a>00477 <span class="stringliteral">              &amp;&amp; PMA_STR_isDigit(PMA_substr($sql, $count2 + 1, 1))</span>
<a name="l00478"></a>00478 <span class="stringliteral">              &amp;&amp; ($previous_was_space || $previous_was_bracket || $previous_was_listsep))) {</span>
<a name="l00479"></a>00479 <span class="stringliteral"></span>
<a name="l00480"></a>00480 <span class="stringliteral">                /* DEBUG</span>
<a name="l00481"></a>00481 <span class="stringliteral">                echo PMA_substr($sql, $count2);</span>
<a name="l00482"></a>00482 <span class="stringliteral">                echo &#39;</span>&lt;hr /&gt;<span class="stringliteral">&#39;;</span>
<a name="l00483"></a>00483 <span class="stringliteral">                */</span>
<a name="l00484"></a>00484 <span class="stringliteral"></span>
<a name="l00485"></a>00485 <span class="stringliteral">                $count2++;</span>
<a name="l00486"></a>00486 <span class="stringliteral"></span><span class="comment"></span>
<a name="l00487"></a>00487 <span class="comment">                /**</span>
<a name="l00488"></a>00488 <span class="comment">                 * @todo a @ can also be present in expressions like</span>
<a name="l00489"></a>00489 <span class="comment">                 * FROM &#39;user&#39;@&#39;%&#39; or  TO &#39;user&#39;@&#39;%&#39;</span>
<a name="l00490"></a>00490 <span class="comment">                 * in this case, the @ is wrongly marked as alpha_variable</span>
<a name="l00491"></a>00491 <span class="comment">                 */</span>
<a name="l00492"></a>00492                 $is_identifier           = $previous_was_punct;
<a name="l00493"></a>00493                 $is_sql_variable         = $c == &#39;@<span class="stringliteral">&#39; &amp;&amp; ! $previous_was_quote;</span>
<a name="l00494"></a>00494 <span class="stringliteral">                $is_user                 = $c == &#39;</span>@<span class="stringliteral">&#39; &amp;&amp; $previous_was_quote;</span>
<a name="l00495"></a>00495 <span class="stringliteral">                $is_digit                = !$is_identifier &amp;&amp; !$is_sql_variable &amp;&amp; PMA_STR_isDigit($c);</span>
<a name="l00496"></a>00496 <span class="stringliteral">                $is_hex_digit            = $is_digit &amp;&amp; $c == &#39;</span>0<span class="stringliteral">&#39; &amp;&amp; $count2 &lt; $len &amp;&amp; PMA_substr($sql, $count2, 1) == &#39;</span>x<span class="stringliteral">&#39;;</span>
<a name="l00497"></a>00497 <span class="stringliteral">                $is_float_digit          = $c == &#39;</span>.<span class="stringliteral">&#39;;</span>
<a name="l00498"></a>00498 <span class="stringliteral">                $is_float_digit_exponent = false;</span>
<a name="l00499"></a>00499 <span class="stringliteral"></span>
<a name="l00500"></a>00500 <span class="stringliteral">                /* DEBUG</span>
<a name="l00501"></a>00501 <span class="stringliteral">                echo &#39;</span>&lt;pre&gt;2<span class="stringliteral">&#39;;</span>
<a name="l00502"></a>00502 <span class="stringliteral">                var_dump($is_identifier);</span>
<a name="l00503"></a>00503 <span class="stringliteral">                var_dump($is_sql_variable);</span>
<a name="l00504"></a>00504 <span class="stringliteral">                var_dump($is_digit);</span>
<a name="l00505"></a>00505 <span class="stringliteral">                var_dump($is_float_digit);</span>
<a name="l00506"></a>00506 <span class="stringliteral">                echo &#39;</span>&lt;/pre&gt;<span class="stringliteral">&#39;;</span>
<a name="l00507"></a>00507 <span class="stringliteral">                 */</span>
<a name="l00508"></a>00508 <span class="stringliteral"></span>
<a name="l00509"></a>00509 <span class="stringliteral">                // Fast skip is especially needed for huge BLOB data</span>
<a name="l00510"></a>00510 <span class="stringliteral">                if ($is_hex_digit) {</span>
<a name="l00511"></a>00511 <span class="stringliteral">                    $count2++;</span>
<a name="l00512"></a>00512 <span class="stringliteral">                    $pos = strspn($sql, &#39;</span>0123456789abcdefABCDEF<span class="stringliteral">&#39;, $count2);</span>
<a name="l00513"></a>00513 <span class="stringliteral">                    if ($pos &gt; $count2) {</span>
<a name="l00514"></a>00514 <span class="stringliteral">                        $count2 = $pos;</span>
<a name="l00515"></a>00515 <span class="stringliteral">                    }</span>
<a name="l00516"></a>00516 <span class="stringliteral">                    unset($pos);</span>
<a name="l00517"></a>00517 <span class="stringliteral">                } elseif ($is_digit) {</span>
<a name="l00518"></a>00518 <span class="stringliteral">                    $pos = strspn($sql, &#39;</span>0123456789<span class="stringliteral">&#39;, $count2);</span>
<a name="l00519"></a>00519 <span class="stringliteral">                    if ($pos &gt; $count2) {</span>
<a name="l00520"></a>00520 <span class="stringliteral">                        $count2 = $pos;</span>
<a name="l00521"></a>00521 <span class="stringliteral">                    }</span>
<a name="l00522"></a>00522 <span class="stringliteral">                    unset($pos);</span>
<a name="l00523"></a>00523 <span class="stringliteral">                }</span>
<a name="l00524"></a>00524 <span class="stringliteral"></span>
<a name="l00525"></a>00525 <span class="stringliteral">                while (($count2 &lt; $len) &amp;&amp; PMA_STR_isSqlIdentifier(PMA_substr($sql, $count2, 1), ($is_sql_variable || $is_digit))) {</span>
<a name="l00526"></a>00526 <span class="stringliteral">                    $c2 = PMA_substr($sql, $count2, 1);</span>
<a name="l00527"></a>00527 <span class="stringliteral">                    if ($is_sql_variable &amp;&amp; ($c2 == &#39;</span>.<span class="stringliteral">&#39;)) {</span>
<a name="l00528"></a>00528 <span class="stringliteral">                        $count2++;</span>
<a name="l00529"></a>00529 <span class="stringliteral">                        continue;</span>
<a name="l00530"></a>00530 <span class="stringliteral">                    }</span>
<a name="l00531"></a>00531 <span class="stringliteral">                    if ($is_digit &amp;&amp; (!$is_hex_digit) &amp;&amp; ($c2 == &#39;</span>.<span class="stringliteral">&#39;)) {</span>
<a name="l00532"></a>00532 <span class="stringliteral">                        $count2++;</span>
<a name="l00533"></a>00533 <span class="stringliteral">                        if (!$is_float_digit) {</span>
<a name="l00534"></a>00534 <span class="stringliteral">                            $is_float_digit = true;</span>
<a name="l00535"></a>00535 <span class="stringliteral">                            continue;</span>
<a name="l00536"></a>00536 <span class="stringliteral">                        } else {</span>
<a name="l00537"></a>00537 <span class="stringliteral">                            $debugstr = __(&#39;</span>Invalid Identifer<span class="stringliteral">&#39;) . &#39;</span> @ <span class="stringliteral">&#39; . ($count1+1) . &quot;\n&quot;</span>
<a name="l00538"></a>00538 <span class="stringliteral">                                      . &#39;</span>STR: <span class="stringliteral">&#39; . htmlspecialchars(PMA_substr($sql, $count1, $count2 - $count1));</span>
<a name="l00539"></a>00539 <span class="stringliteral">                            PMA_SQP_throwError($debugstr, $sql);</span>
<a name="l00540"></a>00540 <span class="stringliteral">                            return $sql_array;</span>
<a name="l00541"></a>00541 <span class="stringliteral">                        }</span>
<a name="l00542"></a>00542 <span class="stringliteral">                    }</span>
<a name="l00543"></a>00543 <span class="stringliteral">                    if ($is_digit &amp;&amp; (!$is_hex_digit) &amp;&amp; (($c2 == &#39;</span>e<span class="stringliteral">&#39;) || ($c2 == &#39;</span>E<span class="stringliteral">&#39;))) {</span>
<a name="l00544"></a>00544 <span class="stringliteral">                        if (!$is_float_digit_exponent) {</span>
<a name="l00545"></a>00545 <span class="stringliteral">                            $is_float_digit_exponent = true;</span>
<a name="l00546"></a>00546 <span class="stringliteral">                            $is_float_digit          = true;</span>
<a name="l00547"></a>00547 <span class="stringliteral">                            $count2++;</span>
<a name="l00548"></a>00548 <span class="stringliteral">                            continue;</span>
<a name="l00549"></a>00549 <span class="stringliteral">                        } else {</span>
<a name="l00550"></a>00550 <span class="stringliteral">                            $is_digit                = false;</span>
<a name="l00551"></a>00551 <span class="stringliteral">                            $is_float_digit          = false;</span>
<a name="l00552"></a>00552 <span class="stringliteral">                        }</span>
<a name="l00553"></a>00553 <span class="stringliteral">                    }</span>
<a name="l00554"></a>00554 <span class="stringliteral">                    if (($is_hex_digit &amp;&amp; PMA_STR_isHexDigit($c2)) || ($is_digit &amp;&amp; PMA_STR_isDigit($c2))) {</span>
<a name="l00555"></a>00555 <span class="stringliteral">                        $count2++;</span>
<a name="l00556"></a>00556 <span class="stringliteral">                        continue;</span>
<a name="l00557"></a>00557 <span class="stringliteral">                    } else {</span>
<a name="l00558"></a>00558 <span class="stringliteral">                        $is_digit     = false;</span>
<a name="l00559"></a>00559 <span class="stringliteral">                        $is_hex_digit = false;</span>
<a name="l00560"></a>00560 <span class="stringliteral">                    }</span>
<a name="l00561"></a>00561 <span class="stringliteral"></span>
<a name="l00562"></a>00562 <span class="stringliteral">                    $count2++;</span>
<a name="l00563"></a>00563 <span class="stringliteral">                } // end while</span>
<a name="l00564"></a>00564 <span class="stringliteral"></span>
<a name="l00565"></a>00565 <span class="stringliteral">                $l    = $count2 - $count1;</span>
<a name="l00566"></a>00566 <span class="stringliteral">                $str  = PMA_substr($sql, $count1, $l);</span>
<a name="l00567"></a>00567 <span class="stringliteral"></span>
<a name="l00568"></a>00568 <span class="stringliteral">                $type = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00569"></a>00569 <span class="stringliteral">                if ($is_digit || $is_float_digit || $is_hex_digit) {</span>
<a name="l00570"></a>00570 <span class="stringliteral">                    $type     = &#39;</span>digit<span class="stringliteral">&#39;;</span>
<a name="l00571"></a>00571 <span class="stringliteral">                    if ($is_float_digit) {</span>
<a name="l00572"></a>00572 <span class="stringliteral">                        $type .= &#39;</span>_float<span class="stringliteral">&#39;;</span>
<a name="l00573"></a>00573 <span class="stringliteral">                    } elseif ($is_hex_digit) {</span>
<a name="l00574"></a>00574 <span class="stringliteral">                        $type .= &#39;</span>_hex<span class="stringliteral">&#39;;</span>
<a name="l00575"></a>00575 <span class="stringliteral">                    } else {</span>
<a name="l00576"></a>00576 <span class="stringliteral">                        $type .= &#39;</span>_integer<span class="stringliteral">&#39;;</span>
<a name="l00577"></a>00577 <span class="stringliteral">                    }</span>
<a name="l00578"></a>00578 <span class="stringliteral">                } elseif ($is_user) {</span>
<a name="l00579"></a>00579 <span class="stringliteral">                    $type = &#39;</span>punct_user<span class="stringliteral">&#39;;</span>
<a name="l00580"></a>00580 <span class="stringliteral">                } elseif ($is_sql_variable != false) {</span>
<a name="l00581"></a>00581 <span class="stringliteral">                    $type = &#39;</span>alpha_variable<span class="stringliteral">&#39;;</span>
<a name="l00582"></a>00582 <span class="stringliteral">                } else {</span>
<a name="l00583"></a>00583 <span class="stringliteral">                    $type = &#39;</span>alpha<span class="stringliteral">&#39;;</span>
<a name="l00584"></a>00584 <span class="stringliteral">                } // end if... else....</span>
<a name="l00585"></a>00585 <span class="stringliteral">                PMA_SQP_arrayAdd($sql_array, $type, $str, $arraysize, $count2);</span>
<a name="l00586"></a>00586 <span class="stringliteral"></span>
<a name="l00587"></a>00587 <span class="stringliteral">                continue;</span>
<a name="l00588"></a>00588 <span class="stringliteral">            }</span>
<a name="l00589"></a>00589 <span class="stringliteral"></span>
<a name="l00590"></a>00590 <span class="stringliteral">            // Checks for punct</span>
<a name="l00591"></a>00591 <span class="stringliteral">            if (PMA_strpos($allpunct_list, $c) !== false) {</span>
<a name="l00592"></a>00592 <span class="stringliteral">                while (($count2 &lt; $len) &amp;&amp; PMA_strpos($allpunct_list, PMA_substr($sql, $count2, 1)) !== false) {</span>
<a name="l00593"></a>00593 <span class="stringliteral">                    $count2++;</span>
<a name="l00594"></a>00594 <span class="stringliteral">                }</span>
<a name="l00595"></a>00595 <span class="stringliteral">                $l = $count2 - $count1;</span>
<a name="l00596"></a>00596 <span class="stringliteral">                if ($l == 1) {</span>
<a name="l00597"></a>00597 <span class="stringliteral">                    $punct_data = $c;</span>
<a name="l00598"></a>00598 <span class="stringliteral">                } else {</span>
<a name="l00599"></a>00599 <span class="stringliteral">                    $punct_data = PMA_substr($sql, $count1, $l);</span>
<a name="l00600"></a>00600 <span class="stringliteral">                }</span>
<a name="l00601"></a>00601 <span class="stringliteral"></span>
<a name="l00602"></a>00602 <span class="stringliteral">                // Special case, sometimes, althought two characters are</span>
<a name="l00603"></a>00603 <span class="stringliteral">                // adjectent directly, they ACTUALLY need to be seperate</span>
<a name="l00604"></a>00604 <span class="stringliteral">                /* DEBUG</span>
<a name="l00605"></a>00605 <span class="stringliteral">                echo &#39;</span>&lt;pre&gt;<span class="stringliteral">&#39;;</span>
<a name="l00606"></a>00606 <span class="stringliteral">                var_dump($l);</span>
<a name="l00607"></a>00607 <span class="stringliteral">                var_dump($punct_data);</span>
<a name="l00608"></a>00608 <span class="stringliteral">                echo &#39;</span>&lt;/pre&gt;<span class="stringliteral">&#39;;</span>
<a name="l00609"></a>00609 <span class="stringliteral">                */</span>
<a name="l00610"></a>00610 <span class="stringliteral"></span>
<a name="l00611"></a>00611 <span class="stringliteral">                if ($l == 1) {</span>
<a name="l00612"></a>00612 <span class="stringliteral">                    $t_suffix         = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00613"></a>00613 <span class="stringliteral">                    switch ($punct_data) {</span>
<a name="l00614"></a>00614 <span class="stringliteral">                    case $punct_queryend:</span>
<a name="l00615"></a>00615 <span class="stringliteral">                        $t_suffix = &#39;</span>_queryend<span class="stringliteral">&#39;;</span>
<a name="l00616"></a>00616 <span class="stringliteral">                        break;</span>
<a name="l00617"></a>00617 <span class="stringliteral">                    case $punct_qualifier:</span>
<a name="l00618"></a>00618 <span class="stringliteral">                        $t_suffix = &#39;</span>_qualifier<span class="stringliteral">&#39;;</span>
<a name="l00619"></a>00619 <span class="stringliteral">                        $this_was_punct = true;</span>
<a name="l00620"></a>00620 <span class="stringliteral">                        break;</span>
<a name="l00621"></a>00621 <span class="stringliteral">                    case $punct_listsep:</span>
<a name="l00622"></a>00622 <span class="stringliteral">                        $this_was_listsep = true;</span>
<a name="l00623"></a>00623 <span class="stringliteral">                        $t_suffix = &#39;</span>_listsep<span class="stringliteral">&#39;;</span>
<a name="l00624"></a>00624 <span class="stringliteral">                        break;</span>
<a name="l00625"></a>00625 <span class="stringliteral">                    default:</span>
<a name="l00626"></a>00626 <span class="stringliteral">                        break;</span>
<a name="l00627"></a>00627 <span class="stringliteral">                    }</span>
<a name="l00628"></a>00628 <span class="stringliteral">                    PMA_SQP_arrayAdd($sql_array, &#39;</span>punct<span class="stringliteral">&#39; . $t_suffix, $punct_data, $arraysize);</span>
<a name="l00629"></a>00629 <span class="stringliteral">                } elseif ($punct_data == $GLOBALS[&#39;</span>sql_delimiter<span class="stringliteral">&#39;] || isset($allpunct_list_pair[$punct_data])) {</span>
<a name="l00630"></a>00630 <span class="stringliteral">                    // Ok, we have one of the valid combined punct expressions</span>
<a name="l00631"></a>00631 <span class="stringliteral">                    PMA_SQP_arrayAdd($sql_array, &#39;</span>punct<span class="stringliteral">&#39;, $punct_data, $arraysize);</span>
<a name="l00632"></a>00632 <span class="stringliteral">                } else {</span>
<a name="l00633"></a>00633 <span class="stringliteral">                    // Bad luck, lets split it up more</span>
<a name="l00634"></a>00634 <span class="stringliteral">                    $first  = $punct_data[0];</span>
<a name="l00635"></a>00635 <span class="stringliteral">                    $first2 = $punct_data[0] . $punct_data[1];</span>
<a name="l00636"></a>00636 <span class="stringliteral">                    $last2  = $punct_data[$l - 2] . $punct_data[$l - 1];</span>
<a name="l00637"></a>00637 <span class="stringliteral">                    $last   = $punct_data[$l - 1];</span>
<a name="l00638"></a>00638 <span class="stringliteral">                    if (($first == &#39;</span>,<span class="stringliteral">&#39;) || ($first == &#39;</span>;<span class="stringliteral">&#39;) || ($first == &#39;</span>.<span class="stringliteral">&#39;) || ($first == &#39;</span>*<span class="stringliteral">&#39;)) {</span>
<a name="l00639"></a>00639 <span class="stringliteral">                        $count2     = $count1 + 1;</span>
<a name="l00640"></a>00640 <span class="stringliteral">                        $punct_data = $first;</span>
<a name="l00641"></a>00641 <span class="stringliteral">                    } elseif (($last2 == &#39;</span><span class="comment">/*&#39;) || (($last2 == &#39;--&#39;) &amp;&amp; ($count2 == $len || PMA_substr($sql, $count2, 1) &lt;= &#39; &#39;))) {</span>
<a name="l00642"></a>00642 <span class="comment">                        $count2     -= 2;</span>
<a name="l00643"></a>00643 <span class="comment">                        $punct_data = PMA_substr($sql, $count1, $count2 - $count1);</span>
<a name="l00644"></a>00644 <span class="comment">                    } elseif (($last == &#39;-&#39;) || ($last == &#39;+&#39;) || ($last == &#39;!&#39;)) {</span>
<a name="l00645"></a>00645 <span class="comment">                        $count2--;</span>
<a name="l00646"></a>00646 <span class="comment">                        $punct_data = PMA_substr($sql, $count1, $count2 - $count1);</span>
<a name="l00647"></a>00647 <span class="comment">                    } elseif ($last != &#39;~&#39;) {</span><span class="comment"></span>
<a name="l00648"></a>00648 <span class="comment">                        /**</span>
<a name="l00649"></a>00649 <span class="comment">                         * @todo for negation operator, split in 2 tokens ?</span>
<a name="l00650"></a>00650 <span class="comment">                         * &quot;select x&amp;~1 from t&quot;</span>
<a name="l00651"></a>00651 <span class="comment">                         * becomes &quot;select x &amp; ~ 1 from t&quot; ?</span>
<a name="l00652"></a>00652 <span class="comment">                         */</span>
<a name="l00653"></a>00653                         $debugstr =  __(&#39;Unknown Punctuation String&#39;) . &#39; @ &#39; . ($count1+1) . &quot;\n&quot;
<a name="l00654"></a>00654                                   . &#39;STR: &#39; . htmlspecialchars($punct_data);
<a name="l00655"></a>00655                         PMA_SQP_throwError($debugstr, $sql);
<a name="l00656"></a>00656                         return $sql_array;
<a name="l00657"></a>00657                     }
<a name="l00658"></a>00658                     PMA_SQP_arrayAdd($sql_array, &#39;punct&#39;, $punct_data, $arraysize);
<a name="l00659"></a>00659                     continue;
<a name="l00660"></a>00660                 } // end if... elseif... else
<a name="l00661"></a>00661                 continue;
<a name="l00662"></a>00662             }
<a name="l00663"></a>00663 
<a name="l00664"></a>00664             // DEBUG
<a name="l00665"></a>00665             $count2++;
<a name="l00666"></a>00666 
<a name="l00667"></a>00667             $debugstr = &#39;C1 C2 LEN: &#39; . $count1 . &#39; &#39; . $count2 . &#39; &#39; . $len .  &quot;\n&quot;
<a name="l00668"></a>00668                       . &#39;STR: &#39; . PMA_substr($sql, $count1, $count2 - $count1) . &quot;\n&quot;;
<a name="l00669"></a>00669             PMA_SQP_bug($debugstr, $sql);
<a name="l00670"></a>00670             return $sql_array;
<a name="l00671"></a>00671 
<a name="l00672"></a>00672         } // end while ($count2 &lt; $len)
<a name="l00673"></a>00673 
<a name="l00674"></a>00674         /*
<a name="l00675"></a>00675         echo &#39;&lt;pre&gt;&#39;;
<a name="l00676"></a>00676         print_r($sql_array);
<a name="l00677"></a>00677         echo &#39;&lt;/pre&gt;&#39;;
<a name="l00678"></a>00678         */
<a name="l00679"></a>00679 
<a name="l00680"></a>00680         if ($arraysize &gt; 0) {
<a name="l00681"></a>00681             $t_next           = $sql_array[0][&#39;type&#39;];
<a name="l00682"></a>00682             $t_prev           = &#39;&#39;;
<a name="l00683"></a>00683             $t_bef_prev       = &#39;&#39;;
<a name="l00684"></a>00684             $t_cur            = &#39;&#39;;
<a name="l00685"></a>00685             $d_next           = $sql_array[0][&#39;data&#39;];
<a name="l00686"></a>00686             $d_prev           = &#39;&#39;;
<a name="l00687"></a>00687             $d_bef_prev       = &#39;&#39;;
<a name="l00688"></a>00688             $d_cur            = &#39;&#39;;
<a name="l00689"></a>00689             $d_next_upper     = $t_next == &#39;alpha&#39; ? strtoupper($d_next) : $d_next;
<a name="l00690"></a>00690             $d_prev_upper     = &#39;&#39;;
<a name="l00691"></a>00691             $d_bef_prev_upper = &#39;&#39;;
<a name="l00692"></a>00692             $d_cur_upper      = &#39;&#39;;
<a name="l00693"></a>00693         }
<a name="l00694"></a>00694 
<a name="l00695"></a>00695         for ($i = 0; $i &lt; $arraysize; $i++) {
<a name="l00696"></a>00696             $t_bef_prev       = $t_prev;
<a name="l00697"></a>00697             $t_prev           = $t_cur;
<a name="l00698"></a>00698             $t_cur            = $t_next;
<a name="l00699"></a>00699             $d_bef_prev       = $d_prev;
<a name="l00700"></a>00700             $d_prev           = $d_cur;
<a name="l00701"></a>00701             $d_cur            = $d_next;
<a name="l00702"></a>00702             $d_bef_prev_upper = $d_prev_upper;
<a name="l00703"></a>00703             $d_prev_upper     = $d_cur_upper;
<a name="l00704"></a>00704             $d_cur_upper      = $d_next_upper;
<a name="l00705"></a>00705             if (($i + 1) &lt; $arraysize) {
<a name="l00706"></a>00706                 $t_next = $sql_array[$i + 1][&#39;type&#39;];
<a name="l00707"></a>00707                 $d_next = $sql_array[$i + 1][&#39;data&#39;];
<a name="l00708"></a>00708                 $d_next_upper = $t_next == &#39;alpha&#39; ? strtoupper($d_next) : $d_next;
<a name="l00709"></a>00709             } else {
<a name="l00710"></a>00710                 $t_next       = &#39;&#39;;
<a name="l00711"></a>00711                 $d_next       = &#39;&#39;;
<a name="l00712"></a>00712                 $d_next_upper = &#39;&#39;;
<a name="l00713"></a>00713             }
<a name="l00714"></a>00714 
<a name="l00715"></a>00715             //DEBUG echo &quot;[prev: &lt;strong&gt;&quot;.$d_prev.&quot;&lt;/strong&gt; &quot;.$t_prev.&quot;][cur: &lt;strong&gt;&quot;.$d_cur.&quot;&lt;/strong&gt; &quot;.$t_cur.&quot;][next: &lt;strong&gt;&quot;.$d_next.&quot;&lt;/strong&gt; &quot;.$t_next.&quot;]&lt;br /&gt;&quot;;
<a name="l00716"></a>00716 
<a name="l00717"></a>00717             if ($t_cur == &#39;alpha&#39;) {
<a name="l00718"></a>00718                 $t_suffix     = &#39;_identifier&#39;;
<a name="l00719"></a>00719                 // for example: `thebit` bit(8) NOT NULL DEFAULT b&#39;0&#39;
<a name="l00720"></a>00720                 if ($t_prev == &#39;alpha&#39; &amp;&amp; $d_prev == &#39;DEFAULT&#39; &amp;&amp; $d_cur == &#39;b&#39; &amp;&amp; $t_next == &#39;quote_single&#39;) {
<a name="l00721"></a>00721                     $t_suffix = &#39;_bitfield_constant_introducer&#39;;
<a name="l00722"></a>00722                 } elseif (($t_next == &#39;punct_qualifier&#39;) || ($t_prev == &#39;punct_qualifier&#39;)) {
<a name="l00723"></a>00723                     $t_suffix = &#39;_identifier&#39;;
<a name="l00724"></a>00724                 } elseif (($t_next == &#39;punct_bracket_open_round&#39;)
<a name="l00725"></a>00725                   &amp;&amp; isset($PMA_SQPdata_function_name[$d_cur_upper])) {<span class="comment"></span>
<a name="l00726"></a>00726 <span class="comment">                    /**</span>
<a name="l00727"></a>00727 <span class="comment">                     * @todo 2005-10-16: in the case of a CREATE TABLE containing</span>
<a name="l00728"></a>00728 <span class="comment">                     * a TIMESTAMP, since TIMESTAMP() is also a function, it&#39;s</span>
<a name="l00729"></a>00729 <span class="comment">                     * found here and the token is wrongly marked as alpha_functionName.</span>
<a name="l00730"></a>00730 <span class="comment">                     * But we compensate for this when analysing for timestamp_not_null</span>
<a name="l00731"></a>00731 <span class="comment">                     * later in this script.</span>
<a name="l00732"></a>00732 <span class="comment">                     *</span>
<a name="l00733"></a>00733 <span class="comment">                     * Same applies to CHAR vs. CHAR() function.</span>
<a name="l00734"></a>00734 <span class="comment">                     */</span>
<a name="l00735"></a>00735                     $t_suffix = &#39;_functionName&#39;;
<a name="l00736"></a>00736                     /* There are functions which might be as well column types */
<a name="l00737"></a>00737                 } elseif (isset($PMA_SQPdata_column_type[$d_cur_upper])) {
<a name="l00738"></a>00738                     $t_suffix = &#39;_columnType&#39;;
<a name="l00739"></a>00739 <span class="comment"></span>
<a name="l00740"></a>00740 <span class="comment">                    /**</span>
<a name="l00741"></a>00741 <span class="comment">                     * Temporary fix for BUG #621357 and #2027720</span>
<a name="l00742"></a>00742 <span class="comment">                     *</span>
<a name="l00743"></a>00743 <span class="comment">                     * @todo FIX PROPERLY NEEDS OVERHAUL OF SQL TOKENIZER</span>
<a name="l00744"></a>00744 <span class="comment">                     */</span>
<a name="l00745"></a>00745                     if (($d_cur_upper == &#39;SET&#39; || $d_cur_upper == &#39;BINARY&#39;) &amp;&amp; $t_next != &#39;punct_bracket_open_round&#39;) {
<a name="l00746"></a>00746                         $t_suffix = &#39;_reservedWord&#39;;
<a name="l00747"></a>00747                     }
<a name="l00748"></a>00748                     //END OF TEMPORARY FIX
<a name="l00749"></a>00749 
<a name="l00750"></a>00750                     // CHARACTER is a synonym for CHAR, but can also be meant as
<a name="l00751"></a>00751                     // CHARACTER SET. In this case, we have a reserved word.
<a name="l00752"></a>00752                     if ($d_cur_upper == &#39;CHARACTER&#39; &amp;&amp; $d_next_upper == &#39;SET&#39;) {
<a name="l00753"></a>00753                         $t_suffix = &#39;_reservedWord&#39;;
<a name="l00754"></a>00754                     }
<a name="l00755"></a>00755 
<a name="l00756"></a>00756                     // experimental
<a name="l00757"></a>00757                     // current is a column type, so previous must not be
<a name="l00758"></a>00758                     // a reserved word but an identifier
<a name="l00759"></a>00759                     // CREATE TABLE SG_Persons (first varchar(64))
<a name="l00760"></a>00760 
<a name="l00761"></a>00761                     //if ($sql_array[$i-1][&#39;type&#39;] ==&#39;alpha_reservedWord&#39;) {
<a name="l00762"></a>00762                     //    $sql_array[$i-1][&#39;type&#39;] = &#39;alpha_identifier&#39;;
<a name="l00763"></a>00763                     //}
<a name="l00764"></a>00764 
<a name="l00765"></a>00765                 } elseif (isset($PMA_SQPdata_reserved_word[$d_cur_upper])) {
<a name="l00766"></a>00766                     $t_suffix = &#39;_reservedWord&#39;;
<a name="l00767"></a>00767                 } elseif (isset($PMA_SQPdata_column_attrib[$d_cur_upper])) {
<a name="l00768"></a>00768                     $t_suffix = &#39;_columnAttrib&#39;;
<a name="l00769"></a>00769                     // INNODB is a MySQL table type, but in &quot;SHOW INNODB STATUS&quot;,
<a name="l00770"></a>00770                     // it should be regarded as a reserved word.
<a name="l00771"></a>00771                     if ($d_cur_upper == &#39;INNODB&#39; &amp;&amp; $d_prev_upper == &#39;SHOW&#39; &amp;&amp; $d_next_upper == &#39;STATUS&#39;) {
<a name="l00772"></a>00772                         $t_suffix = &#39;_reservedWord&#39;;
<a name="l00773"></a>00773                     }
<a name="l00774"></a>00774 
<a name="l00775"></a>00775                     if ($d_cur_upper == &#39;DEFAULT&#39; &amp;&amp; $d_next_upper == &#39;CHARACTER&#39;) {
<a name="l00776"></a>00776                         $t_suffix = &#39;_reservedWord&#39;;
<a name="l00777"></a>00777                     }
<a name="l00778"></a>00778                     // Binary as character set
<a name="l00779"></a>00779                     if ($d_cur_upper == &#39;BINARY&#39; &amp;&amp; (
<a name="l00780"></a>00780                       ($d_bef_prev_upper == &#39;CHARACTER&#39; &amp;&amp; $d_prev_upper == &#39;SET&#39;)
<a name="l00781"></a>00781                       || ($d_bef_prev_upper == &#39;SET&#39; &amp;&amp; $d_prev_upper == &#39;=&#39;)
<a name="l00782"></a>00782                       || ($d_bef_prev_upper == &#39;CHARSET&#39; &amp;&amp; $d_prev_upper == &#39;=&#39;)
<a name="l00783"></a>00783                       || $d_prev_upper == &#39;CHARSET&#39;
<a name="l00784"></a>00784                       ) &amp;&amp; in_array($d_cur, $mysql_charsets)) {
<a name="l00785"></a>00785                         $t_suffix = &#39;_charset&#39;;
<a name="l00786"></a>00786                     }
<a name="l00787"></a>00787                 } elseif (in_array($d_cur, $mysql_charsets)
<a name="l00788"></a>00788                   || in_array($d_cur, $mysql_collations_flat)
<a name="l00789"></a>00789                   || ($d_cur{0} == &#39;_&#39; &amp;&amp; in_array(substr($d_cur, 1), $mysql_charsets))) {
<a name="l00790"></a>00790                     $t_suffix = &#39;_charset&#39;;
<a name="l00791"></a>00791                 } else {
<a name="l00792"></a>00792                     // Do nothing
<a name="l00793"></a>00793                 }
<a name="l00794"></a>00794                 // check if present in the list of forbidden words
<a name="l00795"></a>00795                 if ($t_suffix == &#39;_reservedWord&#39; &amp;&amp; isset($PMA_SQPdata_forbidden_word[$d_cur_upper])) {
<a name="l00796"></a>00796                     $sql_array[$i][&#39;forbidden&#39;] = true;
<a name="l00797"></a>00797                 } else {
<a name="l00798"></a>00798                     $sql_array[$i][&#39;forbidden&#39;] = false;
<a name="l00799"></a>00799                 }
<a name="l00800"></a>00800                 $sql_array[$i][&#39;type&#39;] .= $t_suffix;
<a name="l00801"></a>00801             }
<a name="l00802"></a>00802         } // end for
<a name="l00803"></a>00803 
<a name="l00804"></a>00804         // Stores the size of the array inside the array, as count() is a slow
<a name="l00805"></a>00805         // operation.
<a name="l00806"></a>00806         $sql_array[&#39;len&#39;] = $arraysize;
<a name="l00807"></a>00807 
<a name="l00808"></a>00808         // DEBUG echo &#39;After parsing&lt;pre&gt;&#39;; print_r($sql_array); echo &#39;&lt;/pre&gt;&#39;;
<a name="l00809"></a>00809         // Sends the data back
<a name="l00810"></a>00810         return $sql_array;
<a name="l00811"></a>00811     } // end of the &quot;PMA_SQP_parse()&quot; function
<a name="l00812"></a>00812 <span class="comment"></span>
<a name="l00813"></a>00813 <span class="comment">    /**</span>
<a name="l00814"></a>00814 <span class="comment">     * Checks for token types being what we want...</span>
<a name="l00815"></a>00815 <span class="comment">     *</span>
<a name="l00816"></a>00816 <span class="comment">     * @param string String of type that we have</span>
<a name="l00817"></a>00817 <span class="comment">     * @param string String of type that we want</span>
<a name="l00818"></a>00818 <span class="comment">     *</span>
<a name="l00819"></a>00819 <span class="comment">     * @return boolean result of check</span>
<a name="l00820"></a>00820 <span class="comment">     *</span>
<a name="l00821"></a>00821 <span class="comment">     * @access private</span>
<a name="l00822"></a>00822 <span class="comment">     */</span>
<a name="l00823"></a>00823     function PMA_SQP_typeCheck($toCheck, $whatWeWant)
<a name="l00824"></a>00824     {
<a name="l00825"></a>00825         $typeSeperator = &#39;_&#39;;
<a name="l00826"></a>00826         if (strcmp($whatWeWant, $toCheck) == 0) {
<a name="l00827"></a>00827             return true;
<a name="l00828"></a>00828         } else {
<a name="l00829"></a>00829             if (strpos($whatWeWant, $typeSeperator) === false) {
<a name="l00830"></a>00830                 return strncmp($whatWeWant, $toCheck, strpos($toCheck, $typeSeperator)) == 0;
<a name="l00831"></a>00831             } else {
<a name="l00832"></a>00832                 return false;
<a name="l00833"></a>00833             }
<a name="l00834"></a>00834         }
<a name="l00835"></a>00835     }
<a name="l00836"></a>00836 
<a name="l00837"></a>00837 <span class="comment"></span>
<a name="l00838"></a>00838 <span class="comment">    /**</span>
<a name="l00839"></a>00839 <span class="comment">     * Analyzes SQL queries</span>
<a name="l00840"></a>00840 <span class="comment">     *</span>
<a name="l00841"></a>00841 <span class="comment">     * @param array   The SQL queries</span>
<a name="l00842"></a>00842 <span class="comment">     *</span>
<a name="l00843"></a>00843 <span class="comment">     * @return array   The analyzed SQL queries</span>
<a name="l00844"></a>00844 <span class="comment">     *</span>
<a name="l00845"></a>00845 <span class="comment">     * @access public</span>
<a name="l00846"></a>00846 <span class="comment">     */</span>
<a name="l00847"></a>00847     function PMA_SQP_analyze($arr)
<a name="l00848"></a>00848     {
<a name="l00849"></a>00849         if ($arr == array() || ! isset($arr[&#39;len&#39;])) {
<a name="l00850"></a>00850             return array();
<a name="l00851"></a>00851         }
<a name="l00852"></a>00852         $result          = array();
<a name="l00853"></a>00853         $size            = $arr[&#39;len&#39;];
<a name="l00854"></a>00854         $subresult       = array(
<a name="l00855"></a>00855             &#39;querytype&#39;      =&gt; &#39;&#39;,
<a name="l00856"></a>00856             &#39;select_expr_clause&#39;=&gt; &#39;&#39;, // the whole stuff between SELECT and FROM , except DISTINCT
<a name="l00857"></a>00857             &#39;position_of_first_select&#39; =&gt; &#39;&#39;, // the array index
<a name="l00858"></a>00858             &#39;from_clause&#39;=&gt; &#39;&#39;,
<a name="l00859"></a>00859             &#39;group_by_clause&#39;=&gt; &#39;&#39;,
<a name="l00860"></a>00860             &#39;order_by_clause&#39;=&gt; &#39;&#39;,
<a name="l00861"></a>00861             &#39;having_clause&#39;  =&gt; &#39;&#39;,
<a name="l00862"></a>00862             &#39;limit_clause&#39;  =&gt; &#39;&#39;,
<a name="l00863"></a>00863             &#39;where_clause&#39;   =&gt; &#39;&#39;,
<a name="l00864"></a>00864             &#39;where_clause_identifiers&#39;   =&gt; array(),
<a name="l00865"></a>00865             &#39;unsorted_query&#39; =&gt; &#39;&#39;,
<a name="l00866"></a>00866             &#39;queryflags&#39;     =&gt; array(),
<a name="l00867"></a>00867             &#39;select_expr&#39;    =&gt; array(),
<a name="l00868"></a>00868             &#39;table_ref&#39;      =&gt; array(),
<a name="l00869"></a>00869             &#39;foreign_keys&#39;   =&gt; array(),
<a name="l00870"></a>00870             &#39;create_table_fields&#39; =&gt; array()
<a name="l00871"></a>00871         );
<a name="l00872"></a>00872         $subresult_empty = $subresult;
<a name="l00873"></a>00873         $seek_queryend         = false;
<a name="l00874"></a>00874         $seen_end_of_table_ref = false;
<a name="l00875"></a>00875         $number_of_brackets_in_extract = 0;
<a name="l00876"></a>00876         $number_of_brackets_in_group_concat = 0;
<a name="l00877"></a>00877 
<a name="l00878"></a>00878         $number_of_brackets = 0;
<a name="l00879"></a>00879         $in_subquery = false;
<a name="l00880"></a>00880         $seen_subquery = false;
<a name="l00881"></a>00881         $seen_from = false;
<a name="l00882"></a>00882 
<a name="l00883"></a>00883         // for SELECT EXTRACT(YEAR_MONTH FROM CURDATE())
<a name="l00884"></a>00884         // we must not use CURDATE as a table_ref
<a name="l00885"></a>00885         // so we track whether we are in the EXTRACT()
<a name="l00886"></a>00886         $in_extract          = false;
<a name="l00887"></a>00887 
<a name="l00888"></a>00888         // for GROUP_CONCAT(...)
<a name="l00889"></a>00889         $in_group_concat     = false;
<a name="l00890"></a>00890 
<a name="l00891"></a>00891         /* Description of analyzer results
<a name="l00892"></a>00892          *
<a name="l00893"></a>00893          * db, table, column, alias
<a name="l00894"></a>00894          * ------------------------
<a name="l00895"></a>00895          *
<a name="l00896"></a>00896          * Inside the $subresult array, we create [&#39;select_expr&#39;] and [&#39;table_ref&#39;] arrays.
<a name="l00897"></a>00897          *
<a name="l00898"></a>00898          * The SELECT syntax (simplified) is
<a name="l00899"></a>00899          *
<a name="l00900"></a>00900          * SELECT
<a name="l00901"></a>00901          *    select_expression,...
<a name="l00902"></a>00902          *    [FROM [table_references]
<a name="l00903"></a>00903          *
<a name="l00904"></a>00904          *
<a name="l00905"></a>00905          * [&#39;select_expr&#39;] is filled with each expression, the key represents the
<a name="l00906"></a>00906          * expression position in the list (0-based) (so we don&#39;t lose track of
<a name="l00907"></a>00907          * multiple occurences of the same column).
<a name="l00908"></a>00908          *
<a name="l00909"></a>00909          * [&#39;table_ref&#39;] is filled with each table ref, same thing for the key.
<a name="l00910"></a>00910          *
<a name="l00911"></a>00911          * I create all sub-values empty, even if they are
<a name="l00912"></a>00912          * not present (for example no select_expression alias).
<a name="l00913"></a>00913          *
<a name="l00914"></a>00914          * There is a debug section at the end of loop #1, if you want to
<a name="l00915"></a>00915          * see the exact contents of select_expr and table_ref
<a name="l00916"></a>00916          *
<a name="l00917"></a>00917          * queryflags
<a name="l00918"></a>00918          * ----------
<a name="l00919"></a>00919          *
<a name="l00920"></a>00920          * In $subresult, array &#39;queryflags&#39; is filled, according to what we
<a name="l00921"></a>00921          * find in the query.
<a name="l00922"></a>00922          *
<a name="l00923"></a>00923          * Currently, those are generated:
<a name="l00924"></a>00924          *
<a name="l00925"></a>00925          * [&#39;queryflags&#39;][&#39;need_confirm&#39;] = 1; if the query needs confirmation
<a name="l00926"></a>00926          * [&#39;queryflags&#39;][&#39;select_from&#39;] = 1;  if this is a real SELECT...FROM
<a name="l00927"></a>00927          * [&#39;queryflags&#39;][&#39;distinct&#39;] = 1;     for a DISTINCT
<a name="l00928"></a>00928          * [&#39;queryflags&#39;][&#39;union&#39;] = 1;        for a UNION
<a name="l00929"></a>00929          * [&#39;queryflags&#39;][&#39;join&#39;] = 1;         for a JOIN
<a name="l00930"></a>00930          * [&#39;queryflags&#39;][&#39;offset&#39;] = 1;       for the presence of OFFSET
<a name="l00931"></a>00931          * [&#39;queryflags&#39;][&#39;procedure&#39;] = 1;    for the presence of PROCEDURE
<a name="l00932"></a>00932          *
<a name="l00933"></a>00933          * query clauses
<a name="l00934"></a>00934          * -------------
<a name="l00935"></a>00935          *
<a name="l00936"></a>00936          * The select is splitted in those clauses:
<a name="l00937"></a>00937          * [&#39;select_expr_clause&#39;]
<a name="l00938"></a>00938          * [&#39;from_clause&#39;]
<a name="l00939"></a>00939          * [&#39;group_by_clause&#39;]
<a name="l00940"></a>00940          * [&#39;order_by_clause&#39;]
<a name="l00941"></a>00941          * [&#39;having_clause&#39;]
<a name="l00942"></a>00942          * [&#39;limit_clause&#39;]
<a name="l00943"></a>00943          * [&#39;where_clause&#39;]
<a name="l00944"></a>00944          *
<a name="l00945"></a>00945          * The identifiers of the WHERE clause are put into the array
<a name="l00946"></a>00946          * [&#39;where_clause_identifier&#39;]
<a name="l00947"></a>00947          *
<a name="l00948"></a>00948          * For a SELECT, the whole query without the ORDER BY clause is put into
<a name="l00949"></a>00949          * [&#39;unsorted_query&#39;]
<a name="l00950"></a>00950          *
<a name="l00951"></a>00951          * foreign keys
<a name="l00952"></a>00952          * ------------
<a name="l00953"></a>00953          * The CREATE TABLE may contain FOREIGN KEY clauses, so they get
<a name="l00954"></a>00954          * analyzed and [&#39;foreign_keys&#39;] is an array filled with
<a name="l00955"></a>00955          * the constraint name, the index list,
<a name="l00956"></a>00956          * the REFERENCES table name and REFERENCES index list,
<a name="l00957"></a>00957          * and ON UPDATE | ON DELETE clauses
<a name="l00958"></a>00958          *
<a name="l00959"></a>00959          * position_of_first_select
<a name="l00960"></a>00960          * ------------------------
<a name="l00961"></a>00961          *
<a name="l00962"></a>00962          * The array index of the first SELECT we find. Will be used to
<a name="l00963"></a>00963          * insert a SQL_CALC_FOUND_ROWS.
<a name="l00964"></a>00964          *
<a name="l00965"></a>00965          * create_table_fields
<a name="l00966"></a>00966          * -------------------
<a name="l00967"></a>00967          *
<a name="l00968"></a>00968          * Used to detect the DEFAULT CURRENT_TIMESTAMP and
<a name="l00969"></a>00969          * ON UPDATE CURRENT_TIMESTAMP clauses of the CREATE TABLE query.
<a name="l00970"></a>00970          * Also used to store the default value of the field.
<a name="l00971"></a>00971          * An array, each element is the identifier name.
<a name="l00972"></a>00972          * Note that for now, the timestamp_not_null element is created
<a name="l00973"></a>00973          * even for non-TIMESTAMP fields.
<a name="l00974"></a>00974          *
<a name="l00975"></a>00975          * Sub-elements: [&#39;type&#39;] which contains the column type
<a name="l00976"></a>00976          *               optional (currently they are never false but can be absent):
<a name="l00977"></a>00977          *               [&#39;default_current_timestamp&#39;] boolean
<a name="l00978"></a>00978          *               [&#39;on_update_current_timestamp&#39;] boolean
<a name="l00979"></a>00979          *               [&#39;timestamp_not_null&#39;] boolean
<a name="l00980"></a>00980          *
<a name="l00981"></a>00981          * section_before_limit, section_after_limit
<a name="l00982"></a>00982          * -----------------------------------------
<a name="l00983"></a>00983          *
<a name="l00984"></a>00984          * Marks the point of the query where we can insert a LIMIT clause;
<a name="l00985"></a>00985          * so the section_before_limit will contain the left part before
<a name="l00986"></a>00986          * a possible LIMIT clause
<a name="l00987"></a>00987          *
<a name="l00988"></a>00988          *
<a name="l00989"></a>00989          * End of description of analyzer results
<a name="l00990"></a>00990          */
<a name="l00991"></a>00991 
<a name="l00992"></a>00992         // must be sorted
<a name="l00993"></a>00993         // TODO: current logic checks for only one word, so I put only the
<a name="l00994"></a>00994         // first word of the reserved expressions that end a table ref;
<a name="l00995"></a>00995         // maybe this is not ok (the first word might mean something else)
<a name="l00996"></a>00996         //        $words_ending_table_ref = array(
<a name="l00997"></a>00997         //            &#39;FOR UPDATE&#39;,
<a name="l00998"></a>00998         //            &#39;GROUP BY&#39;,
<a name="l00999"></a>00999         //            &#39;HAVING&#39;,
<a name="l01000"></a>01000         //            &#39;LIMIT&#39;,
<a name="l01001"></a>01001         //            &#39;LOCK IN SHARE MODE&#39;,
<a name="l01002"></a>01002         //            &#39;ORDER BY&#39;,
<a name="l01003"></a>01003         //            &#39;PROCEDURE&#39;,
<a name="l01004"></a>01004         //            &#39;UNION&#39;,
<a name="l01005"></a>01005         //            &#39;WHERE&#39;
<a name="l01006"></a>01006         //        );
<a name="l01007"></a>01007         $words_ending_table_ref = array(
<a name="l01008"></a>01008             &#39;FOR&#39; =&gt; 1,
<a name="l01009"></a>01009             &#39;GROUP&#39; =&gt; 1,
<a name="l01010"></a>01010             &#39;HAVING&#39; =&gt; 1,
<a name="l01011"></a>01011             &#39;LIMIT&#39; =&gt; 1,
<a name="l01012"></a>01012             &#39;LOCK&#39; =&gt; 1,
<a name="l01013"></a>01013             &#39;ORDER&#39; =&gt; 1,
<a name="l01014"></a>01014             &#39;PROCEDURE&#39; =&gt; 1,
<a name="l01015"></a>01015             &#39;UNION&#39; =&gt; 1,
<a name="l01016"></a>01016             &#39;WHERE&#39; =&gt; 1
<a name="l01017"></a>01017         );
<a name="l01018"></a>01018 
<a name="l01019"></a>01019         $words_ending_clauses = array(
<a name="l01020"></a>01020             &#39;FOR&#39; =&gt; 1,
<a name="l01021"></a>01021             &#39;LIMIT&#39; =&gt; 1,
<a name="l01022"></a>01022             &#39;LOCK&#39; =&gt; 1,
<a name="l01023"></a>01023             &#39;PROCEDURE&#39; =&gt; 1,
<a name="l01024"></a>01024             &#39;UNION&#39; =&gt; 1
<a name="l01025"></a>01025         );
<a name="l01026"></a>01026 
<a name="l01027"></a>01027         $supported_query_types = array(
<a name="l01028"></a>01028             &#39;SELECT&#39; =&gt; 1,
<a name="l01029"></a>01029             /*
<a name="l01030"></a>01030             // Support for these additional query types will come later on.
<a name="l01031"></a>01031             &#39;DELETE&#39; =&gt; 1,
<a name="l01032"></a>01032             &#39;INSERT&#39; =&gt; 1,
<a name="l01033"></a>01033             &#39;REPLACE&#39; =&gt; 1,
<a name="l01034"></a>01034             &#39;TRUNCATE&#39; =&gt; 1,
<a name="l01035"></a>01035             &#39;UPDATE&#39; =&gt; 1,
<a name="l01036"></a>01036             &#39;EXPLAIN&#39; =&gt; 1,
<a name="l01037"></a>01037             &#39;DESCRIBE&#39; =&gt; 1,
<a name="l01038"></a>01038             &#39;SHOW&#39; =&gt; 1,
<a name="l01039"></a>01039             &#39;CREATE&#39; =&gt; 1,
<a name="l01040"></a>01040             &#39;SET&#39; =&gt; 1,
<a name="l01041"></a>01041             &#39;ALTER&#39; =&gt; 1
<a name="l01042"></a>01042             */
<a name="l01043"></a>01043         );
<a name="l01044"></a>01044 
<a name="l01045"></a>01045         // loop #1 for each token: select_expr, table_ref for SELECT
<a name="l01046"></a>01046 
<a name="l01047"></a>01047         for ($i = 0; $i &lt; $size; $i++) {
<a name="l01048"></a>01048             //DEBUG echo &quot;Loop1 &lt;strong&gt;&quot;  . $arr[$i][&#39;data&#39;] . &quot;&lt;/strong&gt; (&quot; . $arr[$i][&#39;type&#39;] . &quot;)&lt;br /&gt;&quot;;
<a name="l01049"></a>01049 
<a name="l01050"></a>01050             // High speed seek for locating the end of the current query
<a name="l01051"></a>01051             if ($seek_queryend == true) {
<a name="l01052"></a>01052                 if ($arr[$i][&#39;type&#39;] == &#39;punct_queryend&#39;) {
<a name="l01053"></a>01053                     $seek_queryend = false;
<a name="l01054"></a>01054                 } else {
<a name="l01055"></a>01055                     continue;
<a name="l01056"></a>01056                 } // end if (type == punct_queryend)
<a name="l01057"></a>01057             } // end if ($seek_queryend)
<a name="l01058"></a>01058 <span class="comment"></span>
<a name="l01059"></a>01059 <span class="comment">            /**</span>
<a name="l01060"></a>01060 <span class="comment">             * Note: do not split if this is a punct_queryend for the first and only query</span>
<a name="l01061"></a>01061 <span class="comment">             * @todo when we find a UNION, should we split in another subresult?</span>
<a name="l01062"></a>01062 <span class="comment">             */</span>
<a name="l01063"></a>01063             if ($arr[$i][&#39;type&#39;] == &#39;punct_queryend&#39; &amp;&amp; ($i + 1 != $size)) {
<a name="l01064"></a>01064                 $result[]  = $subresult;
<a name="l01065"></a>01065                 $subresult = $subresult_empty;
<a name="l01066"></a>01066                 continue;
<a name="l01067"></a>01067             } // end if (type == punct_queryend)
<a name="l01068"></a>01068 
<a name="l01069"></a>01069             // ==============================================================
<a name="l01070"></a>01070             if ($arr[$i][&#39;type&#39;] == &#39;punct_bracket_open_round&#39;) {
<a name="l01071"></a>01071                 $number_of_brackets++;
<a name="l01072"></a>01072                 if ($in_extract) {
<a name="l01073"></a>01073                     $number_of_brackets_in_extract++;
<a name="l01074"></a>01074                 }
<a name="l01075"></a>01075                 if ($in_group_concat) {
<a name="l01076"></a>01076                     $number_of_brackets_in_group_concat++;
<a name="l01077"></a>01077                 }
<a name="l01078"></a>01078             }
<a name="l01079"></a>01079             // ==============================================================
<a name="l01080"></a>01080             if ($arr[$i][&#39;type&#39;] == &#39;punct_bracket_close_round&#39;) {
<a name="l01081"></a>01081                 $number_of_brackets--;
<a name="l01082"></a>01082                 if ($number_of_brackets == 0) {
<a name="l01083"></a>01083                     $in_subquery = false;
<a name="l01084"></a>01084                 }
<a name="l01085"></a>01085                 if ($in_extract) {
<a name="l01086"></a>01086                     $number_of_brackets_in_extract--;
<a name="l01087"></a>01087                     if ($number_of_brackets_in_extract == 0) {
<a name="l01088"></a>01088                        $in_extract = false;
<a name="l01089"></a>01089                     }
<a name="l01090"></a>01090                 }
<a name="l01091"></a>01091                 if ($in_group_concat) {
<a name="l01092"></a>01092                     $number_of_brackets_in_group_concat--;
<a name="l01093"></a>01093                     if ($number_of_brackets_in_group_concat == 0) {
<a name="l01094"></a>01094                        $in_group_concat = false;
<a name="l01095"></a>01095                     }
<a name="l01096"></a>01096                 }
<a name="l01097"></a>01097             }
<a name="l01098"></a>01098 
<a name="l01099"></a>01099             if ($in_subquery) {<span class="comment"></span>
<a name="l01100"></a>01100 <span class="comment">                /**</span>
<a name="l01101"></a>01101 <span class="comment">                 * skip the subquery to avoid setting</span>
<a name="l01102"></a>01102 <span class="comment">                 * select_expr or table_ref with the contents</span>
<a name="l01103"></a>01103 <span class="comment">                 * of this subquery; this is to avoid a bug when</span>
<a name="l01104"></a>01104 <span class="comment">                 * trying to edit the results of</span>
<a name="l01105"></a>01105 <span class="comment">                 * select * from child where not exists (select id from</span>
<a name="l01106"></a>01106 <span class="comment">                 * parent where child.parent_id = parent.id);</span>
<a name="l01107"></a>01107 <span class="comment">                 */</span>
<a name="l01108"></a>01108                 continue;
<a name="l01109"></a>01109             }
<a name="l01110"></a>01110             // ==============================================================
<a name="l01111"></a>01111             if ($arr[$i][&#39;type&#39;] == &#39;alpha_functionName&#39;) {
<a name="l01112"></a>01112                 $upper_data = strtoupper($arr[$i][&#39;data&#39;]);
<a name="l01113"></a>01113                 if ($upper_data ==&#39;EXTRACT&#39;) {
<a name="l01114"></a>01114                     $in_extract = true;
<a name="l01115"></a>01115                     $number_of_brackets_in_extract = 0;
<a name="l01116"></a>01116                 }
<a name="l01117"></a>01117                 if ($upper_data ==&#39;GROUP_CONCAT&#39;) {
<a name="l01118"></a>01118                     $in_group_concat = true;
<a name="l01119"></a>01119                     $number_of_brackets_in_group_concat = 0;
<a name="l01120"></a>01120                 }
<a name="l01121"></a>01121             }
<a name="l01122"></a>01122 
<a name="l01123"></a>01123             // ==============================================================
<a name="l01124"></a>01124             if ($arr[$i][&#39;type&#39;] == &#39;alpha_reservedWord&#39;
<a name="l01125"></a>01125                 //&amp;&amp; $arr[$i][&#39;forbidden&#39;] == false) {
<a name="l01126"></a>01126                 ) {
<a name="l01127"></a>01127                 // We don&#39;t know what type of query yet, so run this
<a name="l01128"></a>01128                 if ($subresult[&#39;querytype&#39;] == &#39;&#39;) {
<a name="l01129"></a>01129                     $subresult[&#39;querytype&#39;] = strtoupper($arr[$i][&#39;data&#39;]);
<a name="l01130"></a>01130                 } // end if (querytype was empty)
<a name="l01131"></a>01131 
<a name="l01132"></a>01132                 // Check if we support this type of query
<a name="l01133"></a>01133                 if (!isset($supported_query_types[$subresult[&#39;querytype&#39;]])) {
<a name="l01134"></a>01134                     // Skip ahead to the next one if we don&#39;t
<a name="l01135"></a>01135                     $seek_queryend = true;
<a name="l01136"></a>01136                     continue;
<a name="l01137"></a>01137                 } // end if (query not supported)
<a name="l01138"></a>01138 
<a name="l01139"></a>01139                 // upper once
<a name="l01140"></a>01140                 $upper_data = strtoupper($arr[$i][&#39;data&#39;]);<span class="comment"></span>
<a name="l01141"></a>01141 <span class="comment">                /**</span>
<a name="l01142"></a>01142 <span class="comment">                 * @todo reset for each query?</span>
<a name="l01143"></a>01143 <span class="comment">                 */</span>
<a name="l01144"></a>01144 
<a name="l01145"></a>01145                 if ($upper_data == &#39;SELECT&#39;) {
<a name="l01146"></a>01146                     if ($number_of_brackets &gt; 0) {
<a name="l01147"></a>01147                         $in_subquery = true;
<a name="l01148"></a>01148                         $seen_subquery = true;
<a name="l01149"></a>01149                         // this is a subquery so do not analyze inside it
<a name="l01150"></a>01150                         continue;
<a name="l01151"></a>01151                     }
<a name="l01152"></a>01152                     $seen_from = false;
<a name="l01153"></a>01153                     $previous_was_identifier = false;
<a name="l01154"></a>01154                     $current_select_expr = -1;
<a name="l01155"></a>01155                     $seen_end_of_table_ref = false;
<a name="l01156"></a>01156                 } // end if (data == SELECT)
<a name="l01157"></a>01157 
<a name="l01158"></a>01158                 if ($upper_data ==&#39;FROM&#39; &amp;&amp; !$in_extract) {
<a name="l01159"></a>01159                     $current_table_ref = -1;
<a name="l01160"></a>01160                     $seen_from = true;
<a name="l01161"></a>01161                     $previous_was_identifier = false;
<a name="l01162"></a>01162                     $save_table_ref = true;
<a name="l01163"></a>01163                 } // end if (data == FROM)
<a name="l01164"></a>01164 
<a name="l01165"></a>01165                 // here, do not &#39;continue&#39; the loop, as we have more work for
<a name="l01166"></a>01166                 // reserved words below
<a name="l01167"></a>01167             } // end if (type == alpha_reservedWord)
<a name="l01168"></a>01168 
<a name="l01169"></a>01169             // ==============================
<a name="l01170"></a>01170             if ($arr[$i][&#39;type&#39;] == &#39;quote_backtick&#39;
<a name="l01171"></a>01171              || $arr[$i][&#39;type&#39;] == &#39;quote_double&#39;
<a name="l01172"></a>01172              || $arr[$i][&#39;type&#39;] == &#39;quote_single&#39;
<a name="l01173"></a>01173              || $arr[$i][&#39;type&#39;] == &#39;alpha_identifier&#39;
<a name="l01174"></a>01174              || ($arr[$i][&#39;type&#39;] == &#39;alpha_reservedWord&#39;
<a name="l01175"></a>01175                 &amp;&amp; $arr[$i][&#39;forbidden&#39;] == false)) {
<a name="l01176"></a>01176 
<a name="l01177"></a>01177                 switch ($arr[$i][&#39;type&#39;]) {
<a name="l01178"></a>01178                 case &#39;alpha_identifier&#39;:
<a name="l01179"></a>01179                 case &#39;alpha_reservedWord&#39;:<span class="comment"></span>
<a name="l01180"></a>01180 <span class="comment">                    /**</span>
<a name="l01181"></a>01181 <span class="comment">                     * this is not a real reservedWord, because it&#39;s not</span>
<a name="l01182"></a>01182 <span class="comment">                     * present in the list of forbidden words, for example</span>
<a name="l01183"></a>01183 <span class="comment">                     * &quot;storage&quot; which can be used as an identifier</span>
<a name="l01184"></a>01184 <span class="comment">                     *</span>
<a name="l01185"></a>01185 <span class="comment">                     * @todo avoid the pretty printing in color in this case</span>
<a name="l01186"></a>01186 <span class="comment">                     */</span>
<a name="l01187"></a>01187                     $identifier = $arr[$i][&#39;data&#39;];
<a name="l01188"></a>01188                     break;
<a name="l01189"></a>01189 
<a name="l01190"></a>01190                 case &#39;quote_backtick&#39;:
<a name="l01191"></a>01191                 case &#39;quote_double&#39;:
<a name="l01192"></a>01192                 case &#39;quote_single&#39;:
<a name="l01193"></a>01193                     $identifier = PMA_unQuote($arr[$i][&#39;data&#39;]);
<a name="l01194"></a>01194                     break;
<a name="l01195"></a>01195                 } // end switch
<a name="l01196"></a>01196 
<a name="l01197"></a>01197                 if ($subresult[&#39;querytype&#39;] == &#39;SELECT&#39;
<a name="l01198"></a>01198                  &amp;&amp; ! $in_group_concat
<a name="l01199"></a>01199                  &amp;&amp; ! ($seen_subquery &amp;&amp; $arr[$i - 1][&#39;type&#39;] == &#39;punct_bracket_close_round&#39;)) {
<a name="l01200"></a>01200                     if (!$seen_from) {
<a name="l01201"></a>01201                         if ($previous_was_identifier &amp;&amp; isset($chain)) {
<a name="l01202"></a>01202                             // found alias for this select_expr, save it
<a name="l01203"></a>01203                             // but only if we got something in $chain
<a name="l01204"></a>01204                             // (for example, SELECT COUNT(*) AS cnt
<a name="l01205"></a>01205                             // puts nothing in $chain, so we avoid
<a name="l01206"></a>01206                             // setting the alias)
<a name="l01207"></a>01207                             $alias_for_select_expr = $identifier;
<a name="l01208"></a>01208                         } else {
<a name="l01209"></a>01209                             $chain[] = $identifier;
<a name="l01210"></a>01210                             $previous_was_identifier = true;
<a name="l01211"></a>01211 
<a name="l01212"></a>01212                         } // end if !$previous_was_identifier
<a name="l01213"></a>01213                     } else {
<a name="l01214"></a>01214                         // ($seen_from)
<a name="l01215"></a>01215                         if ($save_table_ref &amp;&amp; !$seen_end_of_table_ref) {
<a name="l01216"></a>01216                             if ($previous_was_identifier) {
<a name="l01217"></a>01217                                 // found alias for table ref
<a name="l01218"></a>01218                                 // save it for later
<a name="l01219"></a>01219                                 $alias_for_table_ref = $identifier;
<a name="l01220"></a>01220                             } else {
<a name="l01221"></a>01221                                 $chain[] = $identifier;
<a name="l01222"></a>01222                                 $previous_was_identifier = true;
<a name="l01223"></a>01223 
<a name="l01224"></a>01224                             } // end if ($previous_was_identifier)
<a name="l01225"></a>01225                         } // end if ($save_table_ref &amp;&amp;!$seen_end_of_table_ref)
<a name="l01226"></a>01226                     } // end if (!$seen_from)
<a name="l01227"></a>01227                 } // end if (querytype SELECT)
<a name="l01228"></a>01228             } // end if (quote_backtick or double quote or alpha_identifier)
<a name="l01229"></a>01229 
<a name="l01230"></a>01230             // ===================================
<a name="l01231"></a>01231             if ($arr[$i][&#39;type&#39;] == &#39;punct_qualifier&#39;) {
<a name="l01232"></a>01232                 // to be able to detect an identifier following another
<a name="l01233"></a>01233                 $previous_was_identifier = false;
<a name="l01234"></a>01234                 continue;
<a name="l01235"></a>01235             } // end if (punct_qualifier)
<a name="l01236"></a>01236 <span class="comment"></span>
<a name="l01237"></a>01237 <span class="comment">            /**</span>
<a name="l01238"></a>01238 <span class="comment">             * @todo check if 3 identifiers following one another -&gt; error</span>
<a name="l01239"></a>01239 <span class="comment">             */</span>
<a name="l01240"></a>01240 
<a name="l01241"></a>01241             //    s a v e    a    s e l e c t    e x p r
<a name="l01242"></a>01242             // finding a list separator or FROM
<a name="l01243"></a>01243             // means that we must save the current chain of identifiers
<a name="l01244"></a>01244             // into a select expression
<a name="l01245"></a>01245 
<a name="l01246"></a>01246             // for now, we only save a select expression if it contains
<a name="l01247"></a>01247             // at least one identifier, as we are interested in checking
<a name="l01248"></a>01248             // the columns and table names, so in &quot;select * from persons&quot;,
<a name="l01249"></a>01249             // the &quot;*&quot; is not saved
<a name="l01250"></a>01250 
<a name="l01251"></a>01251             if (isset($chain) &amp;&amp; !$seen_end_of_table_ref
<a name="l01252"></a>01252              &amp;&amp; ((!$seen_from &amp;&amp; $arr[$i][&#39;type&#39;] == &#39;punct_listsep&#39;)
<a name="l01253"></a>01253               || ($arr[$i][&#39;type&#39;] == &#39;alpha_reservedWord&#39; &amp;&amp; $upper_data == &#39;FROM&#39;))) {
<a name="l01254"></a>01254                 $size_chain = count($chain);
<a name="l01255"></a>01255                 $current_select_expr++;
<a name="l01256"></a>01256                 $subresult[&#39;select_expr&#39;][$current_select_expr] = array(
<a name="l01257"></a>01257                   &#39;expr&#39; =&gt; &#39;&#39;,
<a name="l01258"></a>01258                   &#39;alias&#39; =&gt; &#39;&#39;,
<a name="l01259"></a>01259                   &#39;db&#39;   =&gt; &#39;&#39;,
<a name="l01260"></a>01260                   &#39;table_name&#39; =&gt; &#39;&#39;,
<a name="l01261"></a>01261                   &#39;table_true_name&#39; =&gt; &#39;&#39;,
<a name="l01262"></a>01262                   &#39;column&#39; =&gt; &#39;&#39;
<a name="l01263"></a>01263                  );
<a name="l01264"></a>01264 
<a name="l01265"></a>01265                 if (isset($alias_for_select_expr) &amp;&amp; strlen($alias_for_select_expr)) {
<a name="l01266"></a>01266                     // we had found an alias for this select expression
<a name="l01267"></a>01267                     $subresult[&#39;select_expr&#39;][$current_select_expr][&#39;alias&#39;] = $alias_for_select_expr;
<a name="l01268"></a>01268                     unset($alias_for_select_expr);
<a name="l01269"></a>01269                 }
<a name="l01270"></a>01270                 // there is at least a column
<a name="l01271"></a>01271                 $subresult[&#39;select_expr&#39;][$current_select_expr][&#39;column&#39;] = $chain[$size_chain - 1];
<a name="l01272"></a>01272                 $subresult[&#39;select_expr&#39;][$current_select_expr][&#39;expr&#39;] = $chain[$size_chain - 1];
<a name="l01273"></a>01273 
<a name="l01274"></a>01274                 // maybe a table
<a name="l01275"></a>01275                 if ($size_chain &gt; 1) {
<a name="l01276"></a>01276                     $subresult[&#39;select_expr&#39;][$current_select_expr][&#39;table_name&#39;] = $chain[$size_chain - 2];
<a name="l01277"></a>01277                     // we assume for now that this is also the true name
<a name="l01278"></a>01278                     $subresult[&#39;select_expr&#39;][$current_select_expr][&#39;table_true_name&#39;] = $chain[$size_chain - 2];
<a name="l01279"></a>01279                     $subresult[&#39;select_expr&#39;][$current_select_expr][&#39;expr&#39;]
<a name="l01280"></a>01280                         = $subresult[&#39;select_expr&#39;][$current_select_expr][&#39;table_name&#39;]
<a name="l01281"></a>01281                         . &#39;.&#39; . $subresult[&#39;select_expr&#39;][$current_select_expr][&#39;expr&#39;];
<a name="l01282"></a>01282                 } // end if ($size_chain &gt; 1)
<a name="l01283"></a>01283 
<a name="l01284"></a>01284                 // maybe a db
<a name="l01285"></a>01285                 if ($size_chain &gt; 2) {
<a name="l01286"></a>01286                     $subresult[&#39;select_expr&#39;][$current_select_expr][&#39;db&#39;] = $chain[$size_chain - 3];
<a name="l01287"></a>01287                     $subresult[&#39;select_expr&#39;][$current_select_expr][&#39;expr&#39;]
<a name="l01288"></a>01288                         = $subresult[&#39;select_expr&#39;][$current_select_expr][&#39;db&#39;]
<a name="l01289"></a>01289                         . &#39;.&#39; . $subresult[&#39;select_expr&#39;][$current_select_expr][&#39;expr&#39;];
<a name="l01290"></a>01290                 } // end if ($size_chain &gt; 2)
<a name="l01291"></a>01291                 unset($chain);
<a name="l01292"></a>01292 <span class="comment"></span>
<a name="l01293"></a>01293 <span class="comment">                /**</span>
<a name="l01294"></a>01294 <span class="comment">                 * @todo explain this:</span>
<a name="l01295"></a>01295 <span class="comment">                 */</span>
<a name="l01296"></a>01296                 if (($arr[$i][&#39;type&#39;] == &#39;alpha_reservedWord&#39;)
<a name="l01297"></a>01297                  &amp;&amp; ($upper_data != &#39;FROM&#39;)) {
<a name="l01298"></a>01298                     $previous_was_identifier = true;
<a name="l01299"></a>01299                 }
<a name="l01300"></a>01300 
<a name="l01301"></a>01301             } // end if (save a select expr)
<a name="l01302"></a>01302 
<a name="l01303"></a>01303 
<a name="l01304"></a>01304             //======================================
<a name="l01305"></a>01305             //    s a v e    a    t a b l e    r e f
<a name="l01306"></a>01306             //======================================
<a name="l01307"></a>01307 
<a name="l01308"></a>01308             // maybe we just saw the end of table refs
<a name="l01309"></a>01309             // but the last table ref has to be saved
<a name="l01310"></a>01310             // or we are at the last token
<a name="l01311"></a>01311             // or we just got a reserved word<span class="comment"></span>
<a name="l01312"></a>01312 <span class="comment">            /**</span>
<a name="l01313"></a>01313 <span class="comment">             * @todo there could be another query after this one</span>
<a name="l01314"></a>01314 <span class="comment">             */</span>
<a name="l01315"></a>01315 
<a name="l01316"></a>01316             if (isset($chain) &amp;&amp; $seen_from &amp;&amp; $save_table_ref
<a name="l01317"></a>01317              &amp;&amp; ($arr[$i][&#39;type&#39;] == &#39;punct_listsep&#39;
<a name="l01318"></a>01318                || ($arr[$i][&#39;type&#39;] == &#39;alpha_reservedWord&#39; &amp;&amp; $upper_data!=&quot;AS&quot;)
<a name="l01319"></a>01319                || $seen_end_of_table_ref
<a name="l01320"></a>01320                || $i==$size-1)) {
<a name="l01321"></a>01321 
<a name="l01322"></a>01322                 $size_chain = count($chain);
<a name="l01323"></a>01323                 $current_table_ref++;
<a name="l01324"></a>01324                 $subresult[&#39;table_ref&#39;][$current_table_ref] = array(
<a name="l01325"></a>01325                   &#39;expr&#39;            =&gt; &#39;&#39;,
<a name="l01326"></a>01326                   &#39;db&#39;              =&gt; &#39;&#39;,
<a name="l01327"></a>01327                   &#39;table_name&#39;      =&gt; &#39;&#39;,
<a name="l01328"></a>01328                   &#39;table_alias&#39;     =&gt; &#39;&#39;,
<a name="l01329"></a>01329                   &#39;table_true_name&#39; =&gt; &#39;&#39;
<a name="l01330"></a>01330                  );
<a name="l01331"></a>01331                 if (isset($alias_for_table_ref) &amp;&amp; strlen($alias_for_table_ref)) {
<a name="l01332"></a>01332                     $subresult[&#39;table_ref&#39;][$current_table_ref][&#39;table_alias&#39;] = $alias_for_table_ref;
<a name="l01333"></a>01333                     unset($alias_for_table_ref);
<a name="l01334"></a>01334                 }
<a name="l01335"></a>01335                 $subresult[&#39;table_ref&#39;][$current_table_ref][&#39;table_name&#39;] = $chain[$size_chain - 1];
<a name="l01336"></a>01336                 // we assume for now that this is also the true name
<a name="l01337"></a>01337                 $subresult[&#39;table_ref&#39;][$current_table_ref][&#39;table_true_name&#39;] = $chain[$size_chain - 1];
<a name="l01338"></a>01338                 $subresult[&#39;table_ref&#39;][$current_table_ref][&#39;expr&#39;]
<a name="l01339"></a>01339                     = $subresult[&#39;table_ref&#39;][$current_table_ref][&#39;table_name&#39;];
<a name="l01340"></a>01340                 // maybe a db
<a name="l01341"></a>01341                 if ($size_chain &gt; 1) {
<a name="l01342"></a>01342                     $subresult[&#39;table_ref&#39;][$current_table_ref][&#39;db&#39;] = $chain[$size_chain - 2];
<a name="l01343"></a>01343                     $subresult[&#39;table_ref&#39;][$current_table_ref][&#39;expr&#39;]
<a name="l01344"></a>01344                         = $subresult[&#39;table_ref&#39;][$current_table_ref][&#39;db&#39;]
<a name="l01345"></a>01345                         . &#39;.&#39; . $subresult[&#39;table_ref&#39;][$current_table_ref][&#39;expr&#39;];
<a name="l01346"></a>01346                 } // end if ($size_chain &gt; 1)
<a name="l01347"></a>01347 
<a name="l01348"></a>01348                 // add the table alias into the whole expression
<a name="l01349"></a>01349                 $subresult[&#39;table_ref&#39;][$current_table_ref][&#39;expr&#39;]
<a name="l01350"></a>01350                  .= &#39; &#39; . $subresult[&#39;table_ref&#39;][$current_table_ref][&#39;table_alias&#39;];
<a name="l01351"></a>01351 
<a name="l01352"></a>01352                 unset($chain);
<a name="l01353"></a>01353                 $previous_was_identifier = true;
<a name="l01354"></a>01354                 //continue;
<a name="l01355"></a>01355 
<a name="l01356"></a>01356             } // end if (save a table ref)
<a name="l01357"></a>01357 
<a name="l01358"></a>01358 
<a name="l01359"></a>01359             // when we have found all table refs,
<a name="l01360"></a>01360             // for each table_ref alias, put the true name of the table
<a name="l01361"></a>01361             // in the corresponding select expressions
<a name="l01362"></a>01362 
<a name="l01363"></a>01363             if (isset($current_table_ref) &amp;&amp; ($seen_end_of_table_ref || $i == $size-1) &amp;&amp; $subresult != $subresult_empty) {
<a name="l01364"></a>01364                 for ($tr=0; $tr &lt;= $current_table_ref; $tr++) {
<a name="l01365"></a>01365                     $alias = $subresult[&#39;table_ref&#39;][$tr][&#39;table_alias&#39;];
<a name="l01366"></a>01366                     $truename = $subresult[&#39;table_ref&#39;][$tr][&#39;table_true_name&#39;];
<a name="l01367"></a>01367                     for ($se=0; $se &lt;= $current_select_expr; $se++) {
<a name="l01368"></a>01368                         if (isset($alias)
<a name="l01369"></a>01369                             &amp;&amp; strlen($alias)
<a name="l01370"></a>01370                             &amp;&amp; $subresult[&#39;select_expr&#39;][$se][&#39;table_true_name&#39;] == $alias
<a name="l01371"></a>01371                         ) {
<a name="l01372"></a>01372                             $subresult[&#39;select_expr&#39;][$se][&#39;table_true_name&#39;] = $truename;
<a name="l01373"></a>01373                         } // end if (found the alias)
<a name="l01374"></a>01374                     } // end for (select expressions)
<a name="l01375"></a>01375 
<a name="l01376"></a>01376                 } // end for (table refs)
<a name="l01377"></a>01377             } // end if (set the true names)
<a name="l01378"></a>01378 
<a name="l01379"></a>01379 
<a name="l01380"></a>01380             // e n d i n g    l o o p  #1
<a name="l01381"></a>01381             // set the $previous_was_identifier to false if the current
<a name="l01382"></a>01382             // token is not an identifier
<a name="l01383"></a>01383             if (($arr[$i][&#39;type&#39;] != &#39;alpha_identifier&#39;)
<a name="l01384"></a>01384              &amp;&amp; ($arr[$i][&#39;type&#39;] != &#39;quote_double&#39;)
<a name="l01385"></a>01385              &amp;&amp; ($arr[$i][&#39;type&#39;] != &#39;quote_single&#39;)
<a name="l01386"></a>01386              &amp;&amp; ($arr[$i][&#39;type&#39;] != &#39;quote_backtick&#39;)) {
<a name="l01387"></a>01387                 $previous_was_identifier = false;
<a name="l01388"></a>01388             } // end if
<a name="l01389"></a>01389 
<a name="l01390"></a>01390             // however, if we are on AS, we must keep the $previous_was_identifier
<a name="l01391"></a>01391             if (($arr[$i][&#39;type&#39;] == &#39;alpha_reservedWord&#39;)
<a name="l01392"></a>01392              &amp;&amp; ($upper_data == &#39;AS&#39;)) {
<a name="l01393"></a>01393                 $previous_was_identifier = true;
<a name="l01394"></a>01394             }
<a name="l01395"></a>01395 
<a name="l01396"></a>01396             if (($arr[$i][&#39;type&#39;] == &#39;alpha_reservedWord&#39;)
<a name="l01397"></a>01397              &amp;&amp; ($upper_data ==&#39;ON&#39; || $upper_data ==&#39;USING&#39;)) {
<a name="l01398"></a>01398                 $save_table_ref = false;
<a name="l01399"></a>01399             } // end if (data == ON)
<a name="l01400"></a>01400 
<a name="l01401"></a>01401             if (($arr[$i][&#39;type&#39;] == &#39;alpha_reservedWord&#39;)
<a name="l01402"></a>01402              &amp;&amp; ($upper_data ==&#39;JOIN&#39; || $upper_data ==&#39;FROM&#39;)) {
<a name="l01403"></a>01403                 $save_table_ref = true;
<a name="l01404"></a>01404             } // end if (data == JOIN)
<a name="l01405"></a>01405 <span class="comment"></span>
<a name="l01406"></a>01406 <span class="comment">            /**</span>
<a name="l01407"></a>01407 <span class="comment">             * no need to check the end of table ref if we already did</span>
<a name="l01408"></a>01408 <span class="comment">             *</span>
<a name="l01409"></a>01409 <span class="comment">             * @todo maybe add &quot;&amp;&amp; $seen_from&quot;</span>
<a name="l01410"></a>01410 <span class="comment">             */</span>
<a name="l01411"></a>01411             if (!$seen_end_of_table_ref) {
<a name="l01412"></a>01412                 // if this is the last token, it implies that we have
<a name="l01413"></a>01413                 // seen the end of table references
<a name="l01414"></a>01414                 // Check for the end of table references
<a name="l01415"></a>01415                 //
<a name="l01416"></a>01416                 // Note: if we are analyzing a GROUP_CONCAT clause,
<a name="l01417"></a>01417                 // we might find a word that seems to indicate that
<a name="l01418"></a>01418                 // we have found the end of table refs (like ORDER)
<a name="l01419"></a>01419                 // but it&#39;s a modifier of the GROUP_CONCAT so
<a name="l01420"></a>01420                 // it&#39;s not the real end of table refs
<a name="l01421"></a>01421                 if (($i == $size-1)
<a name="l01422"></a>01422                  || ($arr[$i][&#39;type&#39;] == &#39;alpha_reservedWord&#39;
<a name="l01423"></a>01423                  &amp;&amp; !$in_group_concat
<a name="l01424"></a>01424                  &amp;&amp; isset($words_ending_table_ref[$upper_data]))) {
<a name="l01425"></a>01425                     $seen_end_of_table_ref = true;
<a name="l01426"></a>01426                     // to be able to save the last table ref, but do not
<a name="l01427"></a>01427                     // set it true if we found a word like &quot;ON&quot; that has
<a name="l01428"></a>01428                     // already set it to false
<a name="l01429"></a>01429                     if (isset($save_table_ref) &amp;&amp; $save_table_ref != false) {
<a name="l01430"></a>01430                         $save_table_ref = true;
<a name="l01431"></a>01431                     } //end if
<a name="l01432"></a>01432 
<a name="l01433"></a>01433                 } // end if (check for end of table ref)
<a name="l01434"></a>01434             } //end if (!$seen_end_of_table_ref)
<a name="l01435"></a>01435 
<a name="l01436"></a>01436             if ($seen_end_of_table_ref) {
<a name="l01437"></a>01437                 $save_table_ref = false;
<a name="l01438"></a>01438             } // end if
<a name="l01439"></a>01439 
<a name="l01440"></a>01440         } // end for $i (loop #1)
<a name="l01441"></a>01441 
<a name="l01442"></a>01442         //DEBUG
<a name="l01443"></a>01443         /*
<a name="l01444"></a>01444           if (isset($current_select_expr)) {
<a name="l01445"></a>01445            for ($trace=0; $trace&lt;=$current_select_expr; $trace++) {
<a name="l01446"></a>01446                echo &quot;&lt;br /&gt;&quot;;
<a name="l01447"></a>01447                reset ($subresult[&#39;select_expr&#39;][$trace]);
<a name="l01448"></a>01448                while (list ($key, $val) = each ($subresult[&#39;select_expr&#39;][$trace]))
<a name="l01449"></a>01449                    echo &quot;sel expr $trace $key =&gt; $val&lt;br /&gt;\n&quot;;
<a name="l01450"></a>01450                }
<a name="l01451"></a>01451           }
<a name="l01452"></a>01452 
<a name="l01453"></a>01453           if (isset($current_table_ref)) {
<a name="l01454"></a>01454            echo &quot;current_table_ref = &quot; . $current_table_ref . &quot;&lt;br&gt;&quot;;
<a name="l01455"></a>01455            for ($trace=0; $trace&lt;=$current_table_ref; $trace++) {
<a name="l01456"></a>01456 
<a name="l01457"></a>01457                echo &quot;&lt;br /&gt;&quot;;
<a name="l01458"></a>01458                reset ($subresult[&#39;table_ref&#39;][$trace]);
<a name="l01459"></a>01459                while (list ($key, $val) = each ($subresult[&#39;table_ref&#39;][$trace]))
<a name="l01460"></a>01460                echo &quot;table ref $trace $key =&gt; $val&lt;br /&gt;\n&quot;;
<a name="l01461"></a>01461                }
<a name="l01462"></a>01462           }
<a name="l01463"></a>01463         */
<a name="l01464"></a>01464         // -------------------------------------------------------
<a name="l01465"></a>01465 
<a name="l01466"></a>01466 
<a name="l01467"></a>01467         // loop #2: - queryflags
<a name="l01468"></a>01468         //          - querytype (for queries != &#39;SELECT&#39;)
<a name="l01469"></a>01469         //          - section_before_limit, section_after_limit
<a name="l01470"></a>01470         //
<a name="l01471"></a>01471         // we will also need this queryflag in loop 2
<a name="l01472"></a>01472         // so set it here
<a name="l01473"></a>01473         if (isset($current_table_ref) &amp;&amp; $current_table_ref &gt; -1) {
<a name="l01474"></a>01474             $subresult[&#39;queryflags&#39;][&#39;select_from&#39;] = 1;
<a name="l01475"></a>01475         }
<a name="l01476"></a>01476 
<a name="l01477"></a>01477         $section_before_limit = &#39;&#39;;
<a name="l01478"></a>01478         $section_after_limit = &#39;&#39;; // truly the section after the limit clause
<a name="l01479"></a>01479         $seen_reserved_word = false;
<a name="l01480"></a>01480         $seen_group = false;
<a name="l01481"></a>01481         $seen_order = false;
<a name="l01482"></a>01482         $seen_order_by = false;
<a name="l01483"></a>01483         $in_group_by = false; // true when we are inside the GROUP BY clause
<a name="l01484"></a>01484         $in_order_by = false; // true when we are inside the ORDER BY clause
<a name="l01485"></a>01485         $in_having = false; // true when we are inside the HAVING clause
<a name="l01486"></a>01486         $in_select_expr = false; // true when we are inside the select expr clause
<a name="l01487"></a>01487         $in_where = false; // true when we are inside the WHERE clause
<a name="l01488"></a>01488         $seen_limit = false; // true if we have seen a LIMIT clause
<a name="l01489"></a>01489         $in_limit = false; // true when we are inside the LIMIT clause
<a name="l01490"></a>01490         $after_limit = false; // true when we are after the LIMIT clause
<a name="l01491"></a>01491         $in_from = false; // true when we are in the FROM clause
<a name="l01492"></a>01492         $in_group_concat = false;
<a name="l01493"></a>01493         $first_reserved_word = &#39;&#39;;
<a name="l01494"></a>01494         $current_identifier = &#39;&#39;;
<a name="l01495"></a>01495         $unsorted_query = $arr[&#39;raw&#39;]; // in case there is no ORDER BY
<a name="l01496"></a>01496         $number_of_brackets = 0;
<a name="l01497"></a>01497         $in_subquery = false;
<a name="l01498"></a>01498 
<a name="l01499"></a>01499         for ($i = 0; $i &lt; $size; $i++) {
<a name="l01500"></a>01500             //DEBUG echo &quot;Loop2 &lt;strong&gt;&quot;  . $arr[$i][&#39;data&#39;] . &quot;&lt;/strong&gt; (&quot; . $arr[$i][&#39;type&#39;] . &quot;)&lt;br /&gt;&quot;;
<a name="l01501"></a>01501 
<a name="l01502"></a>01502             // need_confirm
<a name="l01503"></a>01503             //
<a name="l01504"></a>01504             // check for reserved words that will have to generate
<a name="l01505"></a>01505             // a confirmation request later in sql.php
<a name="l01506"></a>01506             // the cases are:
<a name="l01507"></a>01507             //   DROP TABLE
<a name="l01508"></a>01508             //   DROP DATABASE
<a name="l01509"></a>01509             //   ALTER TABLE... DROP
<a name="l01510"></a>01510             //   DELETE FROM...
<a name="l01511"></a>01511             //
<a name="l01512"></a>01512             // this code is not used for confirmations coming from functions.js
<a name="l01513"></a>01513 
<a name="l01514"></a>01514             if ($arr[$i][&#39;type&#39;] == &#39;punct_bracket_open_round&#39;) {
<a name="l01515"></a>01515                 $number_of_brackets++;
<a name="l01516"></a>01516             }
<a name="l01517"></a>01517 
<a name="l01518"></a>01518             if ($arr[$i][&#39;type&#39;] == &#39;punct_bracket_close_round&#39;) {
<a name="l01519"></a>01519                 $number_of_brackets--;
<a name="l01520"></a>01520                 if ($number_of_brackets == 0) {
<a name="l01521"></a>01521                     $in_subquery = false;
<a name="l01522"></a>01522                 }
<a name="l01523"></a>01523             }
<a name="l01524"></a>01524 
<a name="l01525"></a>01525             if ($arr[$i][&#39;type&#39;] == &#39;alpha_reservedWord&#39;) {
<a name="l01526"></a>01526                 $upper_data = strtoupper($arr[$i][&#39;data&#39;]);
<a name="l01527"></a>01527 
<a name="l01528"></a>01528                 if ($upper_data == &#39;SELECT&#39; &amp;&amp; $number_of_brackets &gt; 0) {
<a name="l01529"></a>01529                     $in_subquery = true;
<a name="l01530"></a>01530                 }
<a name="l01531"></a>01531 
<a name="l01532"></a>01532                 if (!$seen_reserved_word) {
<a name="l01533"></a>01533                     $first_reserved_word = $upper_data;
<a name="l01534"></a>01534                     $subresult[&#39;querytype&#39;] = $upper_data;
<a name="l01535"></a>01535                     $seen_reserved_word = true;
<a name="l01536"></a>01536 
<a name="l01537"></a>01537                     // if the first reserved word is DROP or DELETE,
<a name="l01538"></a>01538                     // we know this is a query that needs to be confirmed
<a name="l01539"></a>01539                     if ($first_reserved_word==&#39;DROP&#39;
<a name="l01540"></a>01540                      || $first_reserved_word == &#39;DELETE&#39;
<a name="l01541"></a>01541                      || $first_reserved_word == &#39;TRUNCATE&#39;) {
<a name="l01542"></a>01542                         $subresult[&#39;queryflags&#39;][&#39;need_confirm&#39;] = 1;
<a name="l01543"></a>01543                     }
<a name="l01544"></a>01544 
<a name="l01545"></a>01545                     if ($first_reserved_word==&#39;SELECT&#39;) {
<a name="l01546"></a>01546                         $position_of_first_select = $i;
<a name="l01547"></a>01547                     }
<a name="l01548"></a>01548 
<a name="l01549"></a>01549                 } else {
<a name="l01550"></a>01550                     if ($upper_data == &#39;DROP&#39; &amp;&amp; $first_reserved_word == &#39;ALTER&#39;) {
<a name="l01551"></a>01551                         $subresult[&#39;queryflags&#39;][&#39;need_confirm&#39;] = 1;
<a name="l01552"></a>01552                     }
<a name="l01553"></a>01553                 }
<a name="l01554"></a>01554 
<a name="l01555"></a>01555                 if ($upper_data == &#39;LIMIT&#39; &amp;&amp; ! $in_subquery) {
<a name="l01556"></a>01556                     $section_before_limit = substr($arr[&#39;raw&#39;], 0, $arr[$i][&#39;pos&#39;] - 5);
<a name="l01557"></a>01557                     $in_limit = true;
<a name="l01558"></a>01558                     $seen_limit = true;
<a name="l01559"></a>01559                     $limit_clause = &#39;&#39;;
<a name="l01560"></a>01560                     $in_order_by = false; // @todo maybe others to set false
<a name="l01561"></a>01561                 }
<a name="l01562"></a>01562 
<a name="l01563"></a>01563                 if ($upper_data == &#39;PROCEDURE&#39;) {
<a name="l01564"></a>01564                     $subresult[&#39;queryflags&#39;][&#39;procedure&#39;] = 1;
<a name="l01565"></a>01565                     $in_limit = false;
<a name="l01566"></a>01566                     $after_limit = true;
<a name="l01567"></a>01567                 }<span class="comment"></span>
<a name="l01568"></a>01568 <span class="comment">                /**</span>
<a name="l01569"></a>01569 <span class="comment">                 * @todo set also to false if we find FOR UPDATE or LOCK IN SHARE MODE</span>
<a name="l01570"></a>01570 <span class="comment">                 */</span>
<a name="l01571"></a>01571                 if ($upper_data == &#39;SELECT&#39;) {
<a name="l01572"></a>01572                     $in_select_expr = true;
<a name="l01573"></a>01573                     $select_expr_clause = &#39;&#39;;
<a name="l01574"></a>01574                 }
<a name="l01575"></a>01575                 if ($upper_data == &#39;DISTINCT&#39; &amp;&amp; !$in_group_concat) {
<a name="l01576"></a>01576                     $subresult[&#39;queryflags&#39;][&#39;distinct&#39;] = 1;
<a name="l01577"></a>01577                 }
<a name="l01578"></a>01578 
<a name="l01579"></a>01579                 if ($upper_data == &#39;UNION&#39;) {
<a name="l01580"></a>01580                     $subresult[&#39;queryflags&#39;][&#39;union&#39;] = 1;
<a name="l01581"></a>01581                 }
<a name="l01582"></a>01582 
<a name="l01583"></a>01583                 if ($upper_data == &#39;JOIN&#39;) {
<a name="l01584"></a>01584                     $subresult[&#39;queryflags&#39;][&#39;join&#39;] = 1;
<a name="l01585"></a>01585                 }
<a name="l01586"></a>01586 
<a name="l01587"></a>01587                 if ($upper_data == &#39;OFFSET&#39;) {
<a name="l01588"></a>01588                     $subresult[&#39;queryflags&#39;][&#39;offset&#39;] = 1;
<a name="l01589"></a>01589                 }
<a name="l01590"></a>01590 
<a name="l01591"></a>01591                 // if this is a real SELECT...FROM
<a name="l01592"></a>01592                 if ($upper_data == &#39;FROM&#39; &amp;&amp; isset($subresult[&#39;queryflags&#39;][&#39;select_from&#39;]) &amp;&amp; $subresult[&#39;queryflags&#39;][&#39;select_from&#39;] == 1) {
<a name="l01593"></a>01593                     $in_from = true;
<a name="l01594"></a>01594                     $from_clause = &#39;&#39;;
<a name="l01595"></a>01595                     $in_select_expr = false;
<a name="l01596"></a>01596                 }
<a name="l01597"></a>01597 
<a name="l01598"></a>01598 
<a name="l01599"></a>01599                 // (we could have less resetting of variables to false
<a name="l01600"></a>01600                 // if we trust that the query respects the standard
<a name="l01601"></a>01601                 // MySQL order for clauses)
<a name="l01602"></a>01602 
<a name="l01603"></a>01603                 // we use $seen_group and $seen_order because we are looking
<a name="l01604"></a>01604                 // for the BY
<a name="l01605"></a>01605                 if ($upper_data == &#39;GROUP&#39;) {
<a name="l01606"></a>01606                     $seen_group = true;
<a name="l01607"></a>01607                     $seen_order = false;
<a name="l01608"></a>01608                     $in_having = false;
<a name="l01609"></a>01609                     $in_order_by = false;
<a name="l01610"></a>01610                     $in_where = false;
<a name="l01611"></a>01611                     $in_select_expr = false;
<a name="l01612"></a>01612                     $in_from = false;
<a name="l01613"></a>01613                 }
<a name="l01614"></a>01614                 if ($upper_data == &#39;ORDER&#39; &amp;&amp; !$in_group_concat) {
<a name="l01615"></a>01615                     $seen_order = true;
<a name="l01616"></a>01616                     $seen_group = false;
<a name="l01617"></a>01617                     $in_having = false;
<a name="l01618"></a>01618                     $in_group_by = false;
<a name="l01619"></a>01619                     $in_where = false;
<a name="l01620"></a>01620                     $in_select_expr = false;
<a name="l01621"></a>01621                     $in_from = false;
<a name="l01622"></a>01622                 }
<a name="l01623"></a>01623                 if ($upper_data == &#39;HAVING&#39;) {
<a name="l01624"></a>01624                     $in_having = true;
<a name="l01625"></a>01625                     $having_clause = &#39;&#39;;
<a name="l01626"></a>01626                     $seen_group = false;
<a name="l01627"></a>01627                     $seen_order = false;
<a name="l01628"></a>01628                     $in_group_by = false;
<a name="l01629"></a>01629                     $in_order_by = false;
<a name="l01630"></a>01630                     $in_where = false;
<a name="l01631"></a>01631                     $in_select_expr = false;
<a name="l01632"></a>01632                     $in_from = false;
<a name="l01633"></a>01633                 }
<a name="l01634"></a>01634 
<a name="l01635"></a>01635                 if ($upper_data == &#39;WHERE&#39;) {
<a name="l01636"></a>01636                     $in_where = true;
<a name="l01637"></a>01637                     $where_clause = &#39;&#39;;
<a name="l01638"></a>01638                     $where_clause_identifiers = array();
<a name="l01639"></a>01639                     $seen_group = false;
<a name="l01640"></a>01640                     $seen_order = false;
<a name="l01641"></a>01641                     $in_group_by = false;
<a name="l01642"></a>01642                     $in_order_by = false;
<a name="l01643"></a>01643                     $in_having = false;
<a name="l01644"></a>01644                     $in_select_expr = false;
<a name="l01645"></a>01645                     $in_from = false;
<a name="l01646"></a>01646                 }
<a name="l01647"></a>01647 
<a name="l01648"></a>01648                 if ($upper_data == &#39;BY&#39;) {
<a name="l01649"></a>01649                     if ($seen_group) {
<a name="l01650"></a>01650                         $in_group_by = true;
<a name="l01651"></a>01651                         $group_by_clause = &#39;&#39;;
<a name="l01652"></a>01652                     }
<a name="l01653"></a>01653                     if ($seen_order) {
<a name="l01654"></a>01654                         $seen_order_by = true;
<a name="l01655"></a>01655                         // Here we assume that the ORDER BY keywords took
<a name="l01656"></a>01656                         // exactly 8 characters.
<a name="l01657"></a>01657                         // We use PMA_substr() to be charset-safe; otherwise
<a name="l01658"></a>01658                         // if the table name contains accents, the unsorted
<a name="l01659"></a>01659                         // query would be missing some characters.
<a name="l01660"></a>01660                         $unsorted_query = PMA_substr($arr[&#39;raw&#39;], 0, $arr[$i][&#39;pos&#39;] - 8);
<a name="l01661"></a>01661                         $in_order_by = true;
<a name="l01662"></a>01662                         $order_by_clause = &#39;&#39;;
<a name="l01663"></a>01663                     }
<a name="l01664"></a>01664                 }
<a name="l01665"></a>01665 
<a name="l01666"></a>01666                 // if we find one of the words that could end the clause
<a name="l01667"></a>01667                 if (isset($words_ending_clauses[$upper_data])) {
<a name="l01668"></a>01668 
<a name="l01669"></a>01669                     $in_group_by = false;
<a name="l01670"></a>01670                     $in_order_by = false;
<a name="l01671"></a>01671                     $in_having   = false;
<a name="l01672"></a>01672                     $in_where    = false;
<a name="l01673"></a>01673                     $in_select_expr = false;
<a name="l01674"></a>01674                     $in_from = false;
<a name="l01675"></a>01675                 }
<a name="l01676"></a>01676 
<a name="l01677"></a>01677             } // endif (reservedWord)
<a name="l01678"></a>01678 
<a name="l01679"></a>01679 
<a name="l01680"></a>01680             // do not add a space after a function name<span class="comment"></span>
<a name="l01681"></a>01681 <span class="comment">            /**</span>
<a name="l01682"></a>01682 <span class="comment">             * @todo can we combine loop 2 and loop 1? some code is repeated here...</span>
<a name="l01683"></a>01683 <span class="comment">             */</span>
<a name="l01684"></a>01684 
<a name="l01685"></a>01685             $sep = &#39; &#39;;
<a name="l01686"></a>01686             if ($arr[$i][&#39;type&#39;] == &#39;alpha_functionName&#39;) {
<a name="l01687"></a>01687                 $sep=&#39;&#39;;
<a name="l01688"></a>01688                 $upper_data = strtoupper($arr[$i][&#39;data&#39;]);
<a name="l01689"></a>01689                 if ($upper_data ==&#39;GROUP_CONCAT&#39;) {
<a name="l01690"></a>01690                     $in_group_concat = true;
<a name="l01691"></a>01691                     $number_of_brackets_in_group_concat = 0;
<a name="l01692"></a>01692                 }
<a name="l01693"></a>01693             }
<a name="l01694"></a>01694 
<a name="l01695"></a>01695             if ($arr[$i][&#39;type&#39;] == &#39;punct_bracket_open_round&#39;) {
<a name="l01696"></a>01696                 if ($in_group_concat) {
<a name="l01697"></a>01697                     $number_of_brackets_in_group_concat++;
<a name="l01698"></a>01698                 }
<a name="l01699"></a>01699             }
<a name="l01700"></a>01700             if ($arr[$i][&#39;type&#39;] == &#39;punct_bracket_close_round&#39;) {
<a name="l01701"></a>01701                 if ($in_group_concat) {
<a name="l01702"></a>01702                     $number_of_brackets_in_group_concat--;
<a name="l01703"></a>01703                     if ($number_of_brackets_in_group_concat == 0) {
<a name="l01704"></a>01704                         $in_group_concat = false;
<a name="l01705"></a>01705                     }
<a name="l01706"></a>01706                 }
<a name="l01707"></a>01707             }
<a name="l01708"></a>01708 
<a name="l01709"></a>01709             // do not add a space after an identifier if followed by a dot
<a name="l01710"></a>01710             if ($arr[$i][&#39;type&#39;] == &#39;alpha_identifier&#39; &amp;&amp; $i &lt; $size - 1 &amp;&amp; $arr[$i + 1][&#39;data&#39;] == &#39;.&#39;) {
<a name="l01711"></a>01711                 $sep = &#39;&#39;;
<a name="l01712"></a>01712             }
<a name="l01713"></a>01713 
<a name="l01714"></a>01714             // do not add a space after a dot if followed by an identifier
<a name="l01715"></a>01715             if ($arr[$i][&#39;data&#39;] == &#39;.&#39; &amp;&amp; $i &lt; $size - 1 &amp;&amp; $arr[$i + 1][&#39;type&#39;] == &#39;alpha_identifier&#39;) {
<a name="l01716"></a>01716                 $sep = &#39;&#39;;
<a name="l01717"></a>01717             }
<a name="l01718"></a>01718 
<a name="l01719"></a>01719             if ($in_select_expr &amp;&amp; $upper_data != &#39;SELECT&#39; &amp;&amp; $upper_data != &#39;DISTINCT&#39;) {
<a name="l01720"></a>01720                 $select_expr_clause .= $arr[$i][&#39;data&#39;] . $sep;
<a name="l01721"></a>01721             }
<a name="l01722"></a>01722             if ($in_from &amp;&amp; $upper_data != &#39;FROM&#39;) {
<a name="l01723"></a>01723                 $from_clause .= $arr[$i][&#39;data&#39;] . $sep;
<a name="l01724"></a>01724             }
<a name="l01725"></a>01725             if ($in_group_by &amp;&amp; $upper_data != &#39;GROUP&#39; &amp;&amp; $upper_data != &#39;BY&#39;) {
<a name="l01726"></a>01726                 $group_by_clause .= $arr[$i][&#39;data&#39;] . $sep;
<a name="l01727"></a>01727             }
<a name="l01728"></a>01728             if ($in_order_by &amp;&amp; $upper_data != &#39;ORDER&#39; &amp;&amp; $upper_data != &#39;BY&#39;) {
<a name="l01729"></a>01729                 // add a space only before ASC or DESC
<a name="l01730"></a>01730                 // not around the dot between dbname and tablename
<a name="l01731"></a>01731                 if ($arr[$i][&#39;type&#39;] == &#39;alpha_reservedWord&#39;) {
<a name="l01732"></a>01732                     $order_by_clause .= $sep;
<a name="l01733"></a>01733                 }
<a name="l01734"></a>01734                 $order_by_clause .= $arr[$i][&#39;data&#39;];
<a name="l01735"></a>01735             }
<a name="l01736"></a>01736             if ($in_having &amp;&amp; $upper_data != &#39;HAVING&#39;) {
<a name="l01737"></a>01737                 $having_clause .= $arr[$i][&#39;data&#39;] . $sep;
<a name="l01738"></a>01738             }
<a name="l01739"></a>01739             if ($in_where &amp;&amp; $upper_data != &#39;WHERE&#39;) {
<a name="l01740"></a>01740                 $where_clause .= $arr[$i][&#39;data&#39;] . $sep;
<a name="l01741"></a>01741 
<a name="l01742"></a>01742                 if (($arr[$i][&#39;type&#39;] == &#39;quote_backtick&#39;)
<a name="l01743"></a>01743                  || ($arr[$i][&#39;type&#39;] == &#39;alpha_identifier&#39;)) {
<a name="l01744"></a>01744                     $where_clause_identifiers[] = $arr[$i][&#39;data&#39;];
<a name="l01745"></a>01745                 }
<a name="l01746"></a>01746             }
<a name="l01747"></a>01747 
<a name="l01748"></a>01748             // to grab the rest of the query after the ORDER BY clause
<a name="l01749"></a>01749             if (isset($subresult[&#39;queryflags&#39;][&#39;select_from&#39;])
<a name="l01750"></a>01750              &amp;&amp; $subresult[&#39;queryflags&#39;][&#39;select_from&#39;] == 1
<a name="l01751"></a>01751              &amp;&amp; ! $in_order_by
<a name="l01752"></a>01752              &amp;&amp; $seen_order_by
<a name="l01753"></a>01753              &amp;&amp; $upper_data != &#39;BY&#39;) {
<a name="l01754"></a>01754                 $unsorted_query .= $arr[$i][&#39;data&#39;];
<a name="l01755"></a>01755                 if ($arr[$i][&#39;type&#39;] != &#39;punct_bracket_open_round&#39;
<a name="l01756"></a>01756                  &amp;&amp; $arr[$i][&#39;type&#39;] != &#39;punct_bracket_close_round&#39;
<a name="l01757"></a>01757                  &amp;&amp; $arr[$i][&#39;type&#39;] != &#39;punct&#39;) {
<a name="l01758"></a>01758                     $unsorted_query .= $sep;
<a name="l01759"></a>01759                 }
<a name="l01760"></a>01760             }
<a name="l01761"></a>01761 
<a name="l01762"></a>01762             if ($in_limit) {
<a name="l01763"></a>01763                 if ($upper_data == &#39;OFFSET&#39;) {
<a name="l01764"></a>01764                     $limit_clause .= $sep;
<a name="l01765"></a>01765                 }
<a name="l01766"></a>01766                 $limit_clause .= $arr[$i][&#39;data&#39;];
<a name="l01767"></a>01767                 if ($upper_data == &#39;LIMIT&#39; || $upper_data == &#39;OFFSET&#39;) {
<a name="l01768"></a>01768                     $limit_clause .= $sep;
<a name="l01769"></a>01769                 }
<a name="l01770"></a>01770             }
<a name="l01771"></a>01771             if ($after_limit &amp;&amp; $seen_limit) {
<a name="l01772"></a>01772                 $section_after_limit .= $arr[$i][&#39;data&#39;] . $sep;
<a name="l01773"></a>01773             }
<a name="l01774"></a>01774 
<a name="l01775"></a>01775             // clear $upper_data for next iteration
<a name="l01776"></a>01776             $upper_data=&#39;&#39;;
<a name="l01777"></a>01777         } // end for $i (loop #2)
<a name="l01778"></a>01778         if (empty($section_before_limit)) {
<a name="l01779"></a>01779             $section_before_limit = $arr[&#39;raw&#39;];
<a name="l01780"></a>01780         }
<a name="l01781"></a>01781 
<a name="l01782"></a>01782         // -----------------------------------------------------
<a name="l01783"></a>01783         // loop #3: foreign keys and MySQL 4.1.2+ TIMESTAMP options
<a name="l01784"></a>01784         // (for now, check only the first query)
<a name="l01785"></a>01785         // (for now, identifiers are assumed to be backquoted)
<a name="l01786"></a>01786 
<a name="l01787"></a>01787         // If we find that we are dealing with a CREATE TABLE query,
<a name="l01788"></a>01788         // we look for the next punct_bracket_open_round, which
<a name="l01789"></a>01789         // introduces the fields list. Then, when we find a
<a name="l01790"></a>01790         // quote_backtick, it must be a field, so we put it into
<a name="l01791"></a>01791         // the create_table_fields array. Even if this field is
<a name="l01792"></a>01792         // not a timestamp, it will be useful when logic has been
<a name="l01793"></a>01793         // added for complete field attributes analysis.
<a name="l01794"></a>01794 
<a name="l01795"></a>01795         $seen_foreign = false;
<a name="l01796"></a>01796         $seen_references = false;
<a name="l01797"></a>01797         $seen_constraint = false;
<a name="l01798"></a>01798         $foreign_key_number = -1;
<a name="l01799"></a>01799         $seen_create_table = false;
<a name="l01800"></a>01800         $seen_create = false;
<a name="l01801"></a>01801         $seen_alter = false;
<a name="l01802"></a>01802         $in_create_table_fields = false;
<a name="l01803"></a>01803         $brackets_level = 0;
<a name="l01804"></a>01804         $in_timestamp_options = false;
<a name="l01805"></a>01805         $seen_default = false;
<a name="l01806"></a>01806 
<a name="l01807"></a>01807         for ($i = 0; $i &lt; $size; $i++) {
<a name="l01808"></a>01808         // DEBUG echo &quot;Loop 3 &lt;strong&gt;&quot; . $arr[$i][&#39;data&#39;] . &quot;&lt;/strong&gt; &quot; . $arr[$i][&#39;type&#39;] . &quot;&lt;br /&gt;&quot;;
<a name="l01809"></a>01809 
<a name="l01810"></a>01810             if ($arr[$i][&#39;type&#39;] == &#39;alpha_reservedWord&#39;) {
<a name="l01811"></a>01811                 $upper_data = strtoupper($arr[$i][&#39;data&#39;]);
<a name="l01812"></a>01812 
<a name="l01813"></a>01813                 if ($upper_data == &#39;NOT&#39; &amp;&amp; $in_timestamp_options) {
<a name="l01814"></a>01814                     $create_table_fields[$current_identifier][&#39;timestamp_not_null&#39;] = true;
<a name="l01815"></a>01815 
<a name="l01816"></a>01816                 }
<a name="l01817"></a>01817 
<a name="l01818"></a>01818                 if ($upper_data == &#39;CREATE&#39;) {
<a name="l01819"></a>01819                     $seen_create = true;
<a name="l01820"></a>01820                 }
<a name="l01821"></a>01821 
<a name="l01822"></a>01822                 if ($upper_data == &#39;ALTER&#39;) {
<a name="l01823"></a>01823                     $seen_alter = true;
<a name="l01824"></a>01824                 }
<a name="l01825"></a>01825 
<a name="l01826"></a>01826                 if ($upper_data == &#39;TABLE&#39; &amp;&amp; $seen_create) {
<a name="l01827"></a>01827                     $seen_create_table = true;
<a name="l01828"></a>01828                     $create_table_fields = array();
<a name="l01829"></a>01829                 }
<a name="l01830"></a>01830 
<a name="l01831"></a>01831                 if ($upper_data == &#39;CURRENT_TIMESTAMP&#39;) {
<a name="l01832"></a>01832                     if ($in_timestamp_options) {
<a name="l01833"></a>01833                         if ($seen_default) {
<a name="l01834"></a>01834                             $create_table_fields[$current_identifier][&#39;default_current_timestamp&#39;] = true;
<a name="l01835"></a>01835                         }
<a name="l01836"></a>01836                     }
<a name="l01837"></a>01837                 }
<a name="l01838"></a>01838 
<a name="l01839"></a>01839                 if ($upper_data == &#39;CONSTRAINT&#39;) {
<a name="l01840"></a>01840                     $foreign_key_number++;
<a name="l01841"></a>01841                     $seen_foreign = false;
<a name="l01842"></a>01842                     $seen_references = false;
<a name="l01843"></a>01843                     $seen_constraint = true;
<a name="l01844"></a>01844                 }
<a name="l01845"></a>01845                 if ($upper_data == &#39;FOREIGN&#39;) {
<a name="l01846"></a>01846                     $seen_foreign = true;
<a name="l01847"></a>01847                     $seen_references = false;
<a name="l01848"></a>01848                     $seen_constraint = false;
<a name="l01849"></a>01849                 }
<a name="l01850"></a>01850                 if ($upper_data == &#39;REFERENCES&#39;) {
<a name="l01851"></a>01851                     $seen_foreign = false;
<a name="l01852"></a>01852                     $seen_references = true;
<a name="l01853"></a>01853                     $seen_constraint = false;
<a name="l01854"></a>01854                 }
<a name="l01855"></a>01855 
<a name="l01856"></a>01856 
<a name="l01857"></a>01857                 // Cases covered:
<a name="l01858"></a>01858 
<a name="l01859"></a>01859                 // [ON DELETE {CASCADE | SET NULL | NO ACTION | RESTRICT}]
<a name="l01860"></a>01860                 // [ON UPDATE {CASCADE | SET NULL | NO ACTION | RESTRICT}]
<a name="l01861"></a>01861 
<a name="l01862"></a>01862                 // but we set [&#39;on_delete&#39;] or [&#39;on_cascade&#39;] to
<a name="l01863"></a>01863                 // CASCADE | SET_NULL | NO_ACTION | RESTRICT
<a name="l01864"></a>01864 
<a name="l01865"></a>01865                 // ON UPDATE CURRENT_TIMESTAMP
<a name="l01866"></a>01866 
<a name="l01867"></a>01867                 if ($upper_data == &#39;ON&#39;) {
<a name="l01868"></a>01868                     if (isset($arr[$i+1]) &amp;&amp; $arr[$i+1][&#39;type&#39;] == &#39;alpha_reservedWord&#39;) {
<a name="l01869"></a>01869                         $second_upper_data = strtoupper($arr[$i+1][&#39;data&#39;]);
<a name="l01870"></a>01870                         if ($second_upper_data == &#39;DELETE&#39;) {
<a name="l01871"></a>01871                             $clause = &#39;on_delete&#39;;
<a name="l01872"></a>01872                         }
<a name="l01873"></a>01873                         if ($second_upper_data == &#39;UPDATE&#39;) {
<a name="l01874"></a>01874                             $clause = &#39;on_update&#39;;
<a name="l01875"></a>01875                         }
<a name="l01876"></a>01876                         if (isset($clause)
<a name="l01877"></a>01877                         &amp;&amp; ($arr[$i+2][&#39;type&#39;] == &#39;alpha_reservedWord&#39;
<a name="l01878"></a>01878 
<a name="l01879"></a>01879                 // ugly workaround because currently, NO is not
<a name="l01880"></a>01880                 // in the list of reserved words in sqlparser.data
<a name="l01881"></a>01881                 // (we got a bug report about not being able to use
<a name="l01882"></a>01882                 // &#39;no&#39; as an identifier)
<a name="l01883"></a>01883                            || ($arr[$i+2][&#39;type&#39;] == &#39;alpha_identifier&#39;
<a name="l01884"></a>01884                               &amp;&amp; strtoupper($arr[$i+2][&#39;data&#39;])==&#39;NO&#39;))
<a name="l01885"></a>01885                           ) {
<a name="l01886"></a>01886                             $third_upper_data = strtoupper($arr[$i+2][&#39;data&#39;]);
<a name="l01887"></a>01887                             if ($third_upper_data == &#39;CASCADE&#39;
<a name="l01888"></a>01888                             || $third_upper_data == &#39;RESTRICT&#39;) {
<a name="l01889"></a>01889                                 $value = $third_upper_data;
<a name="l01890"></a>01890                             } elseif ($third_upper_data == &#39;SET&#39;
<a name="l01891"></a>01891                               || $third_upper_data == &#39;NO&#39;) {
<a name="l01892"></a>01892                                 if ($arr[$i+3][&#39;type&#39;] == &#39;alpha_reservedWord&#39;) {
<a name="l01893"></a>01893                                     $value = $third_upper_data . &#39;_&#39; . strtoupper($arr[$i+3][&#39;data&#39;]);
<a name="l01894"></a>01894                                 }
<a name="l01895"></a>01895                             } elseif ($third_upper_data == &#39;CURRENT_TIMESTAMP&#39;) {
<a name="l01896"></a>01896                                 if ($clause == &#39;on_update&#39;
<a name="l01897"></a>01897                                 &amp;&amp; $in_timestamp_options) {
<a name="l01898"></a>01898                                     $create_table_fields[$current_identifier][&#39;on_update_current_timestamp&#39;] = true;
<a name="l01899"></a>01899                                     $seen_default = false;
<a name="l01900"></a>01900                                 }
<a name="l01901"></a>01901 
<a name="l01902"></a>01902                             } else {
<a name="l01903"></a>01903                                 $value = &#39;&#39;;
<a name="l01904"></a>01904                             }
<a name="l01905"></a>01905                             if (!empty($value)) {
<a name="l01906"></a>01906                                 $foreign[$foreign_key_number][$clause] = $value;
<a name="l01907"></a>01907                             }
<a name="l01908"></a>01908                             unset($clause);
<a name="l01909"></a>01909                         } // endif (isset($clause))
<a name="l01910"></a>01910                     }
<a name="l01911"></a>01911                 }
<a name="l01912"></a>01912 
<a name="l01913"></a>01913             } // end of reserved words analysis
<a name="l01914"></a>01914 
<a name="l01915"></a>01915 
<a name="l01916"></a>01916             if ($arr[$i][&#39;type&#39;] == &#39;punct_bracket_open_round&#39;) {
<a name="l01917"></a>01917                 $brackets_level++;
<a name="l01918"></a>01918                 if ($seen_create_table &amp;&amp; $brackets_level == 1) {
<a name="l01919"></a>01919                     $in_create_table_fields = true;
<a name="l01920"></a>01920                 }
<a name="l01921"></a>01921             }
<a name="l01922"></a>01922 
<a name="l01923"></a>01923 
<a name="l01924"></a>01924             if ($arr[$i][&#39;type&#39;] == &#39;punct_bracket_close_round&#39;) {
<a name="l01925"></a>01925                 $brackets_level--;
<a name="l01926"></a>01926                 if ($seen_references) {
<a name="l01927"></a>01927                     $seen_references = false;
<a name="l01928"></a>01928                 }
<a name="l01929"></a>01929                 if ($seen_create_table &amp;&amp; $brackets_level == 0) {
<a name="l01930"></a>01930                     $in_create_table_fields = false;
<a name="l01931"></a>01931                 }
<a name="l01932"></a>01932             }
<a name="l01933"></a>01933 
<a name="l01934"></a>01934             if (($arr[$i][&#39;type&#39;] == &#39;alpha_columnAttrib&#39;)) {
<a name="l01935"></a>01935                 $upper_data = strtoupper($arr[$i][&#39;data&#39;]);
<a name="l01936"></a>01936                 if ($seen_create_table &amp;&amp; $in_create_table_fields) {
<a name="l01937"></a>01937                     if ($upper_data == &#39;DEFAULT&#39;) {
<a name="l01938"></a>01938                         $seen_default = true;
<a name="l01939"></a>01939                         $create_table_fields[$current_identifier][&#39;default_value&#39;] = $arr[$i + 1][&#39;data&#39;];
<a name="l01940"></a>01940                     }
<a name="l01941"></a>01941                 }
<a name="l01942"></a>01942             }
<a name="l01943"></a>01943 <span class="comment"></span>
<a name="l01944"></a>01944 <span class="comment">            /**</span>
<a name="l01945"></a>01945 <span class="comment">             * @see @todo 2005-10-16 note: the &quot;or&quot; part here is a workaround for a bug</span>
<a name="l01946"></a>01946 <span class="comment">             */</span>
<a name="l01947"></a>01947             if (($arr[$i][&#39;type&#39;] == &#39;alpha_columnType&#39;) || ($arr[$i][&#39;type&#39;] == &#39;alpha_functionName&#39; &amp;&amp; $seen_create_table)) {
<a name="l01948"></a>01948                 $upper_data = strtoupper($arr[$i][&#39;data&#39;]);
<a name="l01949"></a>01949                 if ($seen_create_table &amp;&amp; $in_create_table_fields &amp;&amp; isset($current_identifier)) {
<a name="l01950"></a>01950                     $create_table_fields[$current_identifier][&#39;type&#39;] = $upper_data;
<a name="l01951"></a>01951                     if ($upper_data == &#39;TIMESTAMP&#39;) {
<a name="l01952"></a>01952                         $arr[$i][&#39;type&#39;] = &#39;alpha_columnType&#39;;
<a name="l01953"></a>01953                         $in_timestamp_options = true;
<a name="l01954"></a>01954                     } else {
<a name="l01955"></a>01955                         $in_timestamp_options = false;
<a name="l01956"></a>01956                         if ($upper_data == &#39;CHAR&#39;) {
<a name="l01957"></a>01957                             $arr[$i][&#39;type&#39;] = &#39;alpha_columnType&#39;;
<a name="l01958"></a>01958                         }
<a name="l01959"></a>01959                     }
<a name="l01960"></a>01960                 }
<a name="l01961"></a>01961             }
<a name="l01962"></a>01962 
<a name="l01963"></a>01963 
<a name="l01964"></a>01964             if ($arr[$i][&#39;type&#39;] == &#39;quote_backtick&#39; || $arr[$i][&#39;type&#39;] == &#39;alpha_identifier&#39;) {
<a name="l01965"></a>01965 
<a name="l01966"></a>01966                 if ($arr[$i][&#39;type&#39;] == &#39;quote_backtick&#39;) {
<a name="l01967"></a>01967                     // remove backquotes
<a name="l01968"></a>01968                     $identifier = PMA_unQuote($arr[$i][&#39;data&#39;]);
<a name="l01969"></a>01969                 } else {
<a name="l01970"></a>01970                     $identifier = $arr[$i][&#39;data&#39;];
<a name="l01971"></a>01971                 }
<a name="l01972"></a>01972 
<a name="l01973"></a>01973                 if ($seen_create_table &amp;&amp; $in_create_table_fields) {
<a name="l01974"></a>01974                     $current_identifier = $identifier;
<a name="l01975"></a>01975                     // we set this one even for non TIMESTAMP type
<a name="l01976"></a>01976                     $create_table_fields[$current_identifier][&#39;timestamp_not_null&#39;] = false;
<a name="l01977"></a>01977                 }
<a name="l01978"></a>01978 
<a name="l01979"></a>01979                 if ($seen_constraint) {
<a name="l01980"></a>01980                     $foreign[$foreign_key_number][&#39;constraint&#39;] = $identifier;
<a name="l01981"></a>01981                 }
<a name="l01982"></a>01982 
<a name="l01983"></a>01983                 if ($seen_foreign &amp;&amp; $brackets_level &gt; 0) {
<a name="l01984"></a>01984                     $foreign[$foreign_key_number][&#39;index_list&#39;][] = $identifier;
<a name="l01985"></a>01985                 }
<a name="l01986"></a>01986 
<a name="l01987"></a>01987                 if ($seen_references) {
<a name="l01988"></a>01988                     if ($seen_alter &amp;&amp; $brackets_level &gt; 0) {
<a name="l01989"></a>01989                         $foreign[$foreign_key_number][&#39;ref_index_list&#39;][] = $identifier;
<a name="l01990"></a>01990                         // here, the first bracket level corresponds to the
<a name="l01991"></a>01991                         // bracket of CREATE TABLE
<a name="l01992"></a>01992                         // so if we are on level 2, it must be the index list
<a name="l01993"></a>01993                         // of the foreign key REFERENCES
<a name="l01994"></a>01994                     } elseif ($brackets_level &gt; 1) {
<a name="l01995"></a>01995                         $foreign[$foreign_key_number][&#39;ref_index_list&#39;][] = $identifier;
<a name="l01996"></a>01996                     } elseif ($arr[$i+1][&#39;type&#39;] == &#39;punct_qualifier&#39;) {
<a name="l01997"></a>01997                         // identifier is `db`.`table`
<a name="l01998"></a>01998                         // the first pass will pick the db name
<a name="l01999"></a>01999                         // the next pass will pick the table name
<a name="l02000"></a>02000                         $foreign[$foreign_key_number][&#39;ref_db_name&#39;] = $identifier;
<a name="l02001"></a>02001                     } else {
<a name="l02002"></a>02002                         // identifier is `table`
<a name="l02003"></a>02003                         $foreign[$foreign_key_number][&#39;ref_table_name&#39;] = $identifier;
<a name="l02004"></a>02004                     }
<a name="l02005"></a>02005                 }
<a name="l02006"></a>02006             }
<a name="l02007"></a>02007         } // end for $i (loop #3)
<a name="l02008"></a>02008 
<a name="l02009"></a>02009 
<a name="l02010"></a>02010         // Fill the $subresult array
<a name="l02011"></a>02011 
<a name="l02012"></a>02012         if (isset($create_table_fields)) {
<a name="l02013"></a>02013             $subresult[&#39;create_table_fields&#39;] = $create_table_fields;
<a name="l02014"></a>02014         }
<a name="l02015"></a>02015 
<a name="l02016"></a>02016         if (isset($foreign)) {
<a name="l02017"></a>02017             $subresult[&#39;foreign_keys&#39;] = $foreign;
<a name="l02018"></a>02018         }
<a name="l02019"></a>02019 
<a name="l02020"></a>02020         if (isset($select_expr_clause)) {
<a name="l02021"></a>02021             $subresult[&#39;select_expr_clause&#39;] = $select_expr_clause;
<a name="l02022"></a>02022         }
<a name="l02023"></a>02023         if (isset($from_clause)) {
<a name="l02024"></a>02024             $subresult[&#39;from_clause&#39;] = $from_clause;
<a name="l02025"></a>02025         }
<a name="l02026"></a>02026         if (isset($group_by_clause)) {
<a name="l02027"></a>02027             $subresult[&#39;group_by_clause&#39;] = $group_by_clause;
<a name="l02028"></a>02028         }
<a name="l02029"></a>02029         if (isset($order_by_clause)) {
<a name="l02030"></a>02030             $subresult[&#39;order_by_clause&#39;] = $order_by_clause;
<a name="l02031"></a>02031         }
<a name="l02032"></a>02032         if (isset($having_clause)) {
<a name="l02033"></a>02033             $subresult[&#39;having_clause&#39;] = $having_clause;
<a name="l02034"></a>02034         }
<a name="l02035"></a>02035         if (isset($limit_clause)) {
<a name="l02036"></a>02036             $subresult[&#39;limit_clause&#39;] = $limit_clause;
<a name="l02037"></a>02037         }
<a name="l02038"></a>02038         if (isset($where_clause)) {
<a name="l02039"></a>02039             $subresult[&#39;where_clause&#39;] = $where_clause;
<a name="l02040"></a>02040         }
<a name="l02041"></a>02041         if (isset($unsorted_query) &amp;&amp; !empty($unsorted_query)) {
<a name="l02042"></a>02042             $subresult[&#39;unsorted_query&#39;] = $unsorted_query;
<a name="l02043"></a>02043         }
<a name="l02044"></a>02044         if (isset($where_clause_identifiers)) {
<a name="l02045"></a>02045             $subresult[&#39;where_clause_identifiers&#39;] = $where_clause_identifiers;
<a name="l02046"></a>02046         }
<a name="l02047"></a>02047 
<a name="l02048"></a>02048         if (isset($position_of_first_select)) {
<a name="l02049"></a>02049             $subresult[&#39;position_of_first_select&#39;] = $position_of_first_select;
<a name="l02050"></a>02050             $subresult[&#39;section_before_limit&#39;] = $section_before_limit;
<a name="l02051"></a>02051             $subresult[&#39;section_after_limit&#39;] = $section_after_limit;
<a name="l02052"></a>02052         }
<a name="l02053"></a>02053 
<a name="l02054"></a>02054         // They are naughty and didn&#39;t have a trailing semi-colon,
<a name="l02055"></a>02055         // then still handle it properly
<a name="l02056"></a>02056         if ($subresult[&#39;querytype&#39;] != &#39;&#39;) {
<a name="l02057"></a>02057             $result[] = $subresult;
<a name="l02058"></a>02058         }
<a name="l02059"></a>02059         return $result;
<a name="l02060"></a>02060     } // end of the &quot;PMA_SQP_analyze()&quot; function
<a name="l02061"></a>02061 
<a name="l02062"></a>02062 <span class="comment"></span>
<a name="l02063"></a>02063 <span class="comment">    /**</span>
<a name="l02064"></a>02064 <span class="comment">     * Colorizes SQL queries html formatted</span>
<a name="l02065"></a>02065 <span class="comment">     *</span>
<a name="l02066"></a>02066 <span class="comment">     * @todo check why adding a &quot;\n&quot; after the &lt;/span&gt; would cause extra blanks</span>
<a name="l02067"></a>02067 <span class="comment">     * to be displayed: SELECT p . person_name</span>
<a name="l02068"></a>02068 <span class="comment">     * @param array   The SQL queries html formatted</span>
<a name="l02069"></a>02069 <span class="comment">     *</span>
<a name="l02070"></a>02070 <span class="comment">     * @return array   The colorized SQL queries</span>
<a name="l02071"></a>02071 <span class="comment">     *</span>
<a name="l02072"></a>02072 <span class="comment">     * @access public</span>
<a name="l02073"></a>02073 <span class="comment">     */</span>
<a name="l02074"></a>02074     function PMA_SQP_formatHtml_colorize($arr)
<a name="l02075"></a>02075     {
<a name="l02076"></a>02076         $i         = PMA_strpos($arr[&#39;type&#39;], &#39;_&#39;);
<a name="l02077"></a>02077         $class     = &#39;&#39;;
<a name="l02078"></a>02078         if ($i &gt; 0) {
<a name="l02079"></a>02079             $class = &#39;syntax_&#39; . PMA_substr($arr[&#39;type&#39;], 0, $i) . &#39; &#39;;
<a name="l02080"></a>02080         }
<a name="l02081"></a>02081 
<a name="l02082"></a>02082         $class     .= &#39;syntax_&#39; . $arr[&#39;type&#39;];
<a name="l02083"></a>02083 
<a name="l02084"></a>02084         return &#39;&lt;span class=&quot;&#39; . $class . &#39;&quot;&gt;&#39; . htmlspecialchars($arr[&#39;data&#39;]) . &#39;&lt;/span&gt;&#39;;
<a name="l02085"></a>02085     } // end of the &quot;PMA_SQP_formatHtml_colorize()&quot; function
<a name="l02086"></a>02086 
<a name="l02087"></a>02087 <span class="comment"></span>
<a name="l02088"></a>02088 <span class="comment">    /**</span>
<a name="l02089"></a>02089 <span class="comment">     * Formats SQL queries to html</span>
<a name="l02090"></a>02090 <span class="comment">     *</span>
<a name="l02091"></a>02091 <span class="comment">     * @param array   The SQL queries</span>
<a name="l02092"></a>02092 <span class="comment">     * @param string  mode</span>
<a name="l02093"></a>02093 <span class="comment">     * @param integer starting token</span>
<a name="l02094"></a>02094 <span class="comment">     * @param integer number of tokens to format, -1 = all</span>
<a name="l02095"></a>02095 <span class="comment">     *</span>
<a name="l02096"></a>02096 <span class="comment">     * @return string  The formatted SQL queries</span>
<a name="l02097"></a>02097 <span class="comment">     *</span>
<a name="l02098"></a>02098 <span class="comment">     * @access public</span>
<a name="l02099"></a>02099 <span class="comment">     */</span>
<a name="l02100"></a>02100     function PMA_SQP_formatHtml($arr, $mode=&#39;color&#39;, $start_token=0,
<a name="l02101"></a>02101         $number_of_tokens=-1)
<a name="l02102"></a>02102     {
<a name="l02103"></a>02103         global $PMA_SQPdata_operators_docs, $PMA_SQPdata_functions_docs;
<a name="l02104"></a>02104         //DEBUG echo &#39;in Format&lt;pre&gt;&#39;; print_r($arr); echo &#39;&lt;/pre&gt;&#39;;
<a name="l02105"></a>02105         // then check for an array
<a name="l02106"></a>02106         if (! is_array($arr)) {
<a name="l02107"></a>02107             return htmlspecialchars($arr);
<a name="l02108"></a>02108         }
<a name="l02109"></a>02109         // first check for the SQL parser having hit an error
<a name="l02110"></a>02110         if (PMA_SQP_isError()) {
<a name="l02111"></a>02111             return htmlspecialchars($arr[&#39;raw&#39;]);
<a name="l02112"></a>02112         }
<a name="l02113"></a>02113         // else do it properly
<a name="l02114"></a>02114         switch ($mode) {
<a name="l02115"></a>02115         case &#39;color&#39;:
<a name="l02116"></a>02116             $str                                = &#39;&lt;span class=&quot;syntax&quot;&gt;&#39;;
<a name="l02117"></a>02117             $html_line_break                    = &#39;&lt;br /&gt;&#39;;
<a name="l02118"></a>02118             $docu                               = true;
<a name="l02119"></a>02119             break;
<a name="l02120"></a>02120         case &#39;query_only&#39;:
<a name="l02121"></a>02121             $str                                = &#39;&#39;;
<a name="l02122"></a>02122             $html_line_break                    = &quot;\n&quot;;
<a name="l02123"></a>02123             $docu                               = false;
<a name="l02124"></a>02124             break;
<a name="l02125"></a>02125         case &#39;text&#39;:
<a name="l02126"></a>02126             $str                                = &#39;&#39;;
<a name="l02127"></a>02127             $html_line_break                    = &#39;&lt;br /&gt;&#39;;
<a name="l02128"></a>02128             $docu                               = true;
<a name="l02129"></a>02129             break;
<a name="l02130"></a>02130         } // end switch
<a name="l02131"></a>02131         // inner_sql is a span that exists for all cases, except query_only
<a name="l02132"></a>02132         // of $cfg[&#39;SQP&#39;][&#39;fmtType&#39;] to make possible a replacement
<a name="l02133"></a>02133         // for inline editing
<a name="l02134"></a>02134         if ($mode!=&#39;query_only&#39;) {
<a name="l02135"></a>02135             $str .= &#39;&lt;span class=&quot;inner_sql&quot;&gt;&#39;;
<a name="l02136"></a>02136         }
<a name="l02137"></a>02137         $close_docu_link = false;
<a name="l02138"></a>02138         $indent                                     = 0;
<a name="l02139"></a>02139         $bracketlevel                               = 0;
<a name="l02140"></a>02140         $functionlevel                              = 0;
<a name="l02141"></a>02141         $infunction                                 = false;
<a name="l02142"></a>02142         $space_punct_listsep                        = &#39; &#39;;
<a name="l02143"></a>02143         $space_punct_listsep_function_name          = &#39; &#39;;
<a name="l02144"></a>02144         // $space_alpha_reserved_word = &#39;&lt;br /&gt;&#39;.&quot;\n&quot;;
<a name="l02145"></a>02145         $space_alpha_reserved_word                  = &#39; &#39;;
<a name="l02146"></a>02146 
<a name="l02147"></a>02147         $keywords_with_brackets_1before            = array(
<a name="l02148"></a>02148             &#39;INDEX&#39; =&gt; 1,
<a name="l02149"></a>02149             &#39;KEY&#39; =&gt; 1,
<a name="l02150"></a>02150             &#39;ON&#39; =&gt; 1,
<a name="l02151"></a>02151             &#39;USING&#39; =&gt; 1
<a name="l02152"></a>02152         );
<a name="l02153"></a>02153 
<a name="l02154"></a>02154         $keywords_with_brackets_2before            = array(
<a name="l02155"></a>02155             &#39;IGNORE&#39; =&gt; 1,
<a name="l02156"></a>02156             &#39;INDEX&#39; =&gt; 1,
<a name="l02157"></a>02157             &#39;INTO&#39; =&gt; 1,
<a name="l02158"></a>02158             &#39;KEY&#39; =&gt; 1,
<a name="l02159"></a>02159             &#39;PRIMARY&#39; =&gt; 1,
<a name="l02160"></a>02160             &#39;PROCEDURE&#39; =&gt; 1,
<a name="l02161"></a>02161             &#39;REFERENCES&#39; =&gt; 1,
<a name="l02162"></a>02162             &#39;UNIQUE&#39; =&gt; 1,
<a name="l02163"></a>02163             &#39;USE&#39; =&gt; 1
<a name="l02164"></a>02164         );
<a name="l02165"></a>02165 
<a name="l02166"></a>02166         // These reserved words do NOT get a newline placed near them.
<a name="l02167"></a>02167         $keywords_no_newline               = array(
<a name="l02168"></a>02168             &#39;AS&#39; =&gt; 1,
<a name="l02169"></a>02169             &#39;ASC&#39; =&gt; 1,
<a name="l02170"></a>02170             &#39;DESC&#39; =&gt; 1,
<a name="l02171"></a>02171             &#39;DISTINCT&#39; =&gt; 1,
<a name="l02172"></a>02172             &#39;DUPLICATE&#39; =&gt; 1,
<a name="l02173"></a>02173             &#39;HOUR&#39; =&gt; 1,
<a name="l02174"></a>02174             &#39;INTERVAL&#39; =&gt; 1,
<a name="l02175"></a>02175             &#39;IS&#39; =&gt; 1,
<a name="l02176"></a>02176             &#39;LIKE&#39; =&gt; 1,
<a name="l02177"></a>02177             &#39;NOT&#39; =&gt; 1,
<a name="l02178"></a>02178             &#39;NULL&#39; =&gt; 1,
<a name="l02179"></a>02179             &#39;ON&#39; =&gt; 1,
<a name="l02180"></a>02180             &#39;REGEXP&#39; =&gt; 1
<a name="l02181"></a>02181         );
<a name="l02182"></a>02182 
<a name="l02183"></a>02183         // These reserved words introduce a privilege list
<a name="l02184"></a>02184         $keywords_priv_list                = array(
<a name="l02185"></a>02185             &#39;GRANT&#39; =&gt; 1,
<a name="l02186"></a>02186             &#39;REVOKE&#39; =&gt; 1
<a name="l02187"></a>02187         );
<a name="l02188"></a>02188 
<a name="l02189"></a>02189         if ($number_of_tokens == -1) {
<a name="l02190"></a>02190             $number_of_tokens = $arr[&#39;len&#39;];
<a name="l02191"></a>02191         }
<a name="l02192"></a>02192         $typearr   = array();
<a name="l02193"></a>02193         if ($number_of_tokens &gt;= 0) {
<a name="l02194"></a>02194             $typearr[0] = &#39;&#39;;
<a name="l02195"></a>02195             $typearr[1] = &#39;&#39;;
<a name="l02196"></a>02196             $typearr[2] = &#39;&#39;;
<a name="l02197"></a>02197             $typearr[3] = $arr[$start_token][&#39;type&#39;];
<a name="l02198"></a>02198         }
<a name="l02199"></a>02199 
<a name="l02200"></a>02200         $in_priv_list = false;
<a name="l02201"></a>02201         for ($i = $start_token; $i &lt; $number_of_tokens; $i++) {
<a name="l02202"></a>02202             // DEBUG echo &quot;Loop format &lt;strong&gt;&quot; . $arr[$i][&#39;data&#39;] . &quot;&lt;/strong&gt; &quot; . $arr[$i][&#39;type&#39;] . &quot;&lt;br /&gt;&quot;;
<a name="l02203"></a>02203             $before = &#39;&#39;;
<a name="l02204"></a>02204             $after  = &#39;&#39;;
<a name="l02205"></a>02205             // array_shift($typearr);
<a name="l02206"></a>02206             /*
<a name="l02207"></a>02207             0 prev2
<a name="l02208"></a>02208             1 prev
<a name="l02209"></a>02209             2 current
<a name="l02210"></a>02210             3 next
<a name="l02211"></a>02211             */
<a name="l02212"></a>02212             if (($i + 1) &lt; $number_of_tokens) {
<a name="l02213"></a>02213                 $typearr[4] = $arr[$i + 1][&#39;type&#39;];
<a name="l02214"></a>02214             } else {
<a name="l02215"></a>02215                 $typearr[4] = &#39;&#39;;
<a name="l02216"></a>02216             }
<a name="l02217"></a>02217 
<a name="l02218"></a>02218             for ($j=0; $j&lt;4; $j++) {
<a name="l02219"></a>02219                 $typearr[$j] = $typearr[$j + 1];
<a name="l02220"></a>02220             }
<a name="l02221"></a>02221 
<a name="l02222"></a>02222             switch ($typearr[2]) {
<a name="l02223"></a>02223             case &#39;alpha_bitfield_constant_introducer&#39;:
<a name="l02224"></a>02224                 $before     = &#39; &#39;;
<a name="l02225"></a>02225                 $after      = &#39;&#39;;
<a name="l02226"></a>02226                 break;
<a name="l02227"></a>02227             case &#39;white_newline&#39;:
<a name="l02228"></a>02228                 $before     = &#39;&#39;;
<a name="l02229"></a>02229                 break;
<a name="l02230"></a>02230             case &#39;punct_bracket_open_round&#39;:
<a name="l02231"></a>02231                 $bracketlevel++;
<a name="l02232"></a>02232                 $infunction = false;
<a name="l02233"></a>02233                 // Make sure this array is sorted!
<a name="l02234"></a>02234                 if (($typearr[1] == &#39;alpha_functionName&#39;) || ($typearr[1] == &#39;alpha_columnType&#39;) || ($typearr[1] == &#39;punct&#39;)
<a name="l02235"></a>02235                     || ($typearr[3] == &#39;digit_integer&#39;) || ($typearr[3] == &#39;digit_hex&#39;) || ($typearr[3] == &#39;digit_float&#39;)
<a name="l02236"></a>02236                     || (($typearr[0] == &#39;alpha_reservedWord&#39;)
<a name="l02237"></a>02237                         &amp;&amp; isset($keywords_with_brackets_2before[strtoupper($arr[$i - 2][&#39;data&#39;])]))
<a name="l02238"></a>02238                     || (($typearr[1] == &#39;alpha_reservedWord&#39;)
<a name="l02239"></a>02239                         &amp;&amp; isset($keywords_with_brackets_1before[strtoupper($arr[$i - 1][&#39;data&#39;])]))
<a name="l02240"></a>02240                     ) {
<a name="l02241"></a>02241                     $functionlevel++;
<a name="l02242"></a>02242                     $infunction = true;
<a name="l02243"></a>02243                     $after      .= &#39; &#39;;
<a name="l02244"></a>02244                 } else {
<a name="l02245"></a>02245                     $indent++;
<a name="l02246"></a>02246                     $after      .= ($mode != &#39;query_only&#39; ? &#39;&lt;div class=&quot;syntax_indent&#39; . $indent . &#39;&quot;&gt;&#39; : &#39; &#39;);
<a name="l02247"></a>02247                 }
<a name="l02248"></a>02248                 break;
<a name="l02249"></a>02249             case &#39;alpha_identifier&#39;:
<a name="l02250"></a>02250                 if (($typearr[1] == &#39;punct_qualifier&#39;) || ($typearr[3] == &#39;punct_qualifier&#39;)) {
<a name="l02251"></a>02251                     $after      = &#39;&#39;;
<a name="l02252"></a>02252                     $before     = &#39;&#39;;
<a name="l02253"></a>02253                 }
<a name="l02254"></a>02254                 // for example SELECT 1 somealias
<a name="l02255"></a>02255                 if ($typearr[1] == &#39;digit_integer&#39;) {
<a name="l02256"></a>02256                     $before     = &#39; &#39;;
<a name="l02257"></a>02257                 }
<a name="l02258"></a>02258                 if (($typearr[3] == &#39;alpha_columnType&#39;) || ($typearr[3] == &#39;alpha_identifier&#39;)) {
<a name="l02259"></a>02259                     $after      .= &#39; &#39;;
<a name="l02260"></a>02260                 }
<a name="l02261"></a>02261                 break;
<a name="l02262"></a>02262             case &#39;punct_user&#39;:
<a name="l02263"></a>02263             case &#39;punct_qualifier&#39;:
<a name="l02264"></a>02264                 $before         = &#39;&#39;;
<a name="l02265"></a>02265                 $after          = &#39;&#39;;
<a name="l02266"></a>02266                 break;
<a name="l02267"></a>02267             case &#39;punct_listsep&#39;:
<a name="l02268"></a>02268                 if ($infunction == true) {
<a name="l02269"></a>02269                     $after      .= $space_punct_listsep_function_name;
<a name="l02270"></a>02270                 } else {
<a name="l02271"></a>02271                     $after      .= $space_punct_listsep;
<a name="l02272"></a>02272                 }
<a name="l02273"></a>02273                 break;
<a name="l02274"></a>02274             case &#39;punct_queryend&#39;:
<a name="l02275"></a>02275                 if (($typearr[3] != &#39;comment_mysql&#39;) &amp;&amp; ($typearr[3] != &#39;comment_ansi&#39;) &amp;&amp; $typearr[3] != &#39;comment_c&#39;) {
<a name="l02276"></a>02276                     $after     .= $html_line_break;
<a name="l02277"></a>02277                     $after     .= $html_line_break;
<a name="l02278"></a>02278                 }
<a name="l02279"></a>02279                 $space_punct_listsep               = &#39; &#39;;
<a name="l02280"></a>02280                 $space_punct_listsep_function_name = &#39; &#39;;
<a name="l02281"></a>02281                 $space_alpha_reserved_word         = &#39; &#39;;
<a name="l02282"></a>02282                 $in_priv_list                      = false;
<a name="l02283"></a>02283                 break;
<a name="l02284"></a>02284             case &#39;comment_mysql&#39;:
<a name="l02285"></a>02285             case &#39;comment_ansi&#39;:
<a name="l02286"></a>02286                 $after         .= $html_line_break;
<a name="l02287"></a>02287                 break;
<a name="l02288"></a>02288             case &#39;punct&#39;:
<a name="l02289"></a>02289                 $before         .= &#39; &#39;;
<a name="l02290"></a>02290                 if ($docu &amp;&amp; isset($PMA_SQPdata_operators_docs[$arr[$i][&#39;data&#39;]]) &amp;&amp;
<a name="l02291"></a>02291                         ($arr[$i][&#39;data&#39;] != &#39;*&#39; || in_array($arr[$i][&#39;type&#39;], array(&#39;digit_integer&#39;,&#39;digit_float&#39;,&#39;digit_hex&#39;)))) {
<a name="l02292"></a>02292                     $before .= PMA_showMySQLDocu(
<a name="l02293"></a>02293                         &#39;functions&#39;,
<a name="l02294"></a>02294                         $PMA_SQPdata_operators_docs[$arr[$i][&#39;data&#39;]][&#39;link&#39;],
<a name="l02295"></a>02295                         false,
<a name="l02296"></a>02296                         $PMA_SQPdata_operators_docs[$arr[$i][&#39;data&#39;]][&#39;anchor&#39;],
<a name="l02297"></a>02297                         true);
<a name="l02298"></a>02298                     $after .= &#39;&lt;/a&gt;&#39;;
<a name="l02299"></a>02299                 }
<a name="l02300"></a>02300 
<a name="l02301"></a>02301                 // workaround for
<a name="l02302"></a>02302                 // select * from mytable limit 0,-1
<a name="l02303"></a>02303                 // (a side effect of this workaround is that
<a name="l02304"></a>02304                 // select 20 - 9
<a name="l02305"></a>02305                 // becomes
<a name="l02306"></a>02306                 // select 20 -9
<a name="l02307"></a>02307                 // )
<a name="l02308"></a>02308                 if ($typearr[3] != &#39;digit_integer&#39;) {
<a name="l02309"></a>02309                     $after        .= &#39; &#39;;
<a name="l02310"></a>02310                 }
<a name="l02311"></a>02311                 break;
<a name="l02312"></a>02312             case &#39;punct_bracket_close_round&#39;:
<a name="l02313"></a>02313                 // only close bracket level when it was opened before
<a name="l02314"></a>02314                 if ($bracketlevel &gt; 0) {
<a name="l02315"></a>02315                     $bracketlevel--;
<a name="l02316"></a>02316                     if ($infunction == true) {
<a name="l02317"></a>02317                         $functionlevel--;
<a name="l02318"></a>02318                         $after     .= &#39; &#39;;
<a name="l02319"></a>02319                         $before    .= &#39; &#39;;
<a name="l02320"></a>02320                     } else {
<a name="l02321"></a>02321                         $indent--;
<a name="l02322"></a>02322                         $before    .= ($mode != &#39;query_only&#39; ? &#39;&lt;/div&gt;&#39; : &#39; &#39;);
<a name="l02323"></a>02323                     }
<a name="l02324"></a>02324                     $infunction    = ($functionlevel &gt; 0) ? true : false;
<a name="l02325"></a>02325                 }
<a name="l02326"></a>02326                 break;
<a name="l02327"></a>02327             case &#39;alpha_columnType&#39;:
<a name="l02328"></a>02328                 if ($docu) {
<a name="l02329"></a>02329                     switch ($arr[$i][&#39;data&#39;]) {
<a name="l02330"></a>02330                     case &#39;tinyint&#39;:
<a name="l02331"></a>02331                     case &#39;smallint&#39;:
<a name="l02332"></a>02332                     case &#39;mediumint&#39;:
<a name="l02333"></a>02333                     case &#39;int&#39;:
<a name="l02334"></a>02334                     case &#39;bigint&#39;:
<a name="l02335"></a>02335                     case &#39;decimal&#39;:
<a name="l02336"></a>02336                     case &#39;float&#39;:
<a name="l02337"></a>02337                     case &#39;double&#39;:
<a name="l02338"></a>02338                     case &#39;real&#39;:
<a name="l02339"></a>02339                     case &#39;bit&#39;:
<a name="l02340"></a>02340                     case &#39;boolean&#39;:
<a name="l02341"></a>02341                     case &#39;serial&#39;:
<a name="l02342"></a>02342                         $before .= PMA_showMySQLDocu(&#39;data-types&#39;, &#39;numeric-types&#39;, false, &#39;&#39;, true);
<a name="l02343"></a>02343                         $after = &#39;&lt;/a&gt;&#39; . $after;
<a name="l02344"></a>02344                         break;
<a name="l02345"></a>02345                     case &#39;date&#39;:
<a name="l02346"></a>02346                     case &#39;datetime&#39;:
<a name="l02347"></a>02347                     case &#39;timestamp&#39;:
<a name="l02348"></a>02348                     case &#39;time&#39;:
<a name="l02349"></a>02349                     case &#39;year&#39;:
<a name="l02350"></a>02350                         $before .= PMA_showMySQLDocu(&#39;data-types&#39;, &#39;date-and-time-types&#39;, false, &#39;&#39;, true);
<a name="l02351"></a>02351                         $after = &#39;&lt;/a&gt;&#39; . $after;
<a name="l02352"></a>02352                         break;
<a name="l02353"></a>02353                     case &#39;char&#39;:
<a name="l02354"></a>02354                     case &#39;varchar&#39;:
<a name="l02355"></a>02355                     case &#39;tinytext&#39;:
<a name="l02356"></a>02356                     case &#39;text&#39;:
<a name="l02357"></a>02357                     case &#39;mediumtext&#39;:
<a name="l02358"></a>02358                     case &#39;longtext&#39;:
<a name="l02359"></a>02359                     case &#39;binary&#39;:
<a name="l02360"></a>02360                     case &#39;varbinary&#39;:
<a name="l02361"></a>02361                     case &#39;tinyblob&#39;:
<a name="l02362"></a>02362                     case &#39;mediumblob&#39;:
<a name="l02363"></a>02363                     case &#39;blob&#39;:
<a name="l02364"></a>02364                     case &#39;longblob&#39;:
<a name="l02365"></a>02365                     case &#39;enum&#39;:
<a name="l02366"></a>02366                     case &#39;set&#39;:
<a name="l02367"></a>02367                         $before .= PMA_showMySQLDocu(&#39;data-types&#39;, &#39;string-types&#39;, false, &#39;&#39;, true);
<a name="l02368"></a>02368                         $after = &#39;&lt;/a&gt;&#39; . $after;
<a name="l02369"></a>02369                         break;
<a name="l02370"></a>02370                     }
<a name="l02371"></a>02371                 }
<a name="l02372"></a>02372                 if ($typearr[3] == &#39;alpha_columnAttrib&#39;) {
<a name="l02373"></a>02373                     $after     .= &#39; &#39;;
<a name="l02374"></a>02374                 }
<a name="l02375"></a>02375                 if ($typearr[1] == &#39;alpha_columnType&#39;) {
<a name="l02376"></a>02376                     $before    .= &#39; &#39;;
<a name="l02377"></a>02377                 }
<a name="l02378"></a>02378                 break;
<a name="l02379"></a>02379             case &#39;alpha_columnAttrib&#39;:
<a name="l02380"></a>02380 
<a name="l02381"></a>02381                 // ALTER TABLE tbl_name AUTO_INCREMENT = 1
<a name="l02382"></a>02382                 // COLLATE LATIN1_GENERAL_CI DEFAULT
<a name="l02383"></a>02383                 if ($typearr[1] == &#39;alpha_identifier&#39; || $typearr[1] == &#39;alpha_charset&#39;) {
<a name="l02384"></a>02384                     $before .= &#39; &#39;;
<a name="l02385"></a>02385                 }
<a name="l02386"></a>02386                 if (($typearr[3] == &#39;alpha_columnAttrib&#39;) || ($typearr[3] == &#39;quote_single&#39;) || ($typearr[3] == &#39;digit_integer&#39;)) {
<a name="l02387"></a>02387                     $after     .= &#39; &#39;;
<a name="l02388"></a>02388                 }
<a name="l02389"></a>02389                 // workaround for
<a name="l02390"></a>02390                 // AUTO_INCREMENT = 31DEFAULT_CHARSET = utf-8
<a name="l02391"></a>02391 
<a name="l02392"></a>02392                 if ($typearr[2] == &#39;alpha_columnAttrib&#39; &amp;&amp; $typearr[3] == &#39;alpha_reservedWord&#39;) {
<a name="l02393"></a>02393                     $before .= &#39; &#39;;
<a name="l02394"></a>02394                 }
<a name="l02395"></a>02395                 // workaround for
<a name="l02396"></a>02396                 // select * from mysql.user where binary user=&quot;root&quot;
<a name="l02397"></a>02397                 // binary is marked as alpha_columnAttrib
<a name="l02398"></a>02398                 // but should be marked as a reserved word
<a name="l02399"></a>02399                 if (strtoupper($arr[$i][&#39;data&#39;]) == &#39;BINARY&#39;
<a name="l02400"></a>02400                   &amp;&amp; $typearr[3] == &#39;alpha_identifier&#39;) {
<a name="l02401"></a>02401                     $after     .= &#39; &#39;;
<a name="l02402"></a>02402                 }
<a name="l02403"></a>02403                 break;
<a name="l02404"></a>02404             case &#39;alpha_functionName&#39;:
<a name="l02405"></a>02405                 $funcname = strtoupper($arr[$i][&#39;data&#39;]);
<a name="l02406"></a>02406                 if ($docu &amp;&amp; isset($PMA_SQPdata_functions_docs[$funcname])) {
<a name="l02407"></a>02407                     $before .= PMA_showMySQLDocu(
<a name="l02408"></a>02408                         &#39;functions&#39;,
<a name="l02409"></a>02409                         $PMA_SQPdata_functions_docs[$funcname][&#39;link&#39;],
<a name="l02410"></a>02410                         false,
<a name="l02411"></a>02411                         $PMA_SQPdata_functions_docs[$funcname][&#39;anchor&#39;],
<a name="l02412"></a>02412                         true);
<a name="l02413"></a>02413                     $after .= &#39;&lt;/a&gt;&#39;;
<a name="l02414"></a>02414                 }
<a name="l02415"></a>02415                 break;
<a name="l02416"></a>02416             case &#39;alpha_reservedWord&#39;:
<a name="l02417"></a>02417                 // do not uppercase the reserved word if we are calling
<a name="l02418"></a>02418                 // this function in query_only mode, because we need
<a name="l02419"></a>02419                 // the original query (otherwise we get problems with
<a name="l02420"></a>02420                 // semi-reserved words like &quot;storage&quot; which is legal
<a name="l02421"></a>02421                 // as an identifier name)
<a name="l02422"></a>02422 
<a name="l02423"></a>02423                 if ($mode != &#39;query_only&#39;) {
<a name="l02424"></a>02424                     $arr[$i][&#39;data&#39;] = strtoupper($arr[$i][&#39;data&#39;]);
<a name="l02425"></a>02425                 }
<a name="l02426"></a>02426 
<a name="l02427"></a>02427                 if ((($typearr[1] != &#39;alpha_reservedWord&#39;)
<a name="l02428"></a>02428                     || (($typearr[1] == &#39;alpha_reservedWord&#39;)
<a name="l02429"></a>02429                         &amp;&amp; isset($keywords_no_newline[strtoupper($arr[$i - 1][&#39;data&#39;])])))
<a name="l02430"></a>02430                     &amp;&amp; ($typearr[1] != &#39;punct_level_plus&#39;)
<a name="l02431"></a>02431                     &amp;&amp; (!isset($keywords_no_newline[$arr[$i][&#39;data&#39;]]))) {
<a name="l02432"></a>02432                     // do not put a space before the first token, because
<a name="l02433"></a>02433                     // we use a lot of pattern matching checking for the
<a name="l02434"></a>02434                     // first reserved word at beginning of query
<a name="l02435"></a>02435                     // so do not put a newline before
<a name="l02436"></a>02436                     //
<a name="l02437"></a>02437                     // also we must not be inside a privilege list
<a name="l02438"></a>02438                     if ($i &gt; 0) {
<a name="l02439"></a>02439                         // the alpha_identifier exception is there to
<a name="l02440"></a>02440                         // catch cases like
<a name="l02441"></a>02441                         // GRANT SELECT ON mydb.mytable TO myuser@localhost
<a name="l02442"></a>02442                         // (else, we get mydb.mytableTO)
<a name="l02443"></a>02443                         //
<a name="l02444"></a>02444                         // the quote_single exception is there to
<a name="l02445"></a>02445                         // catch cases like
<a name="l02446"></a>02446                         // GRANT ... TO &#39;marc&#39;@&#39;domain.com&#39; IDENTIFIED...<span class="comment"></span>
<a name="l02447"></a>02447 <span class="comment">                        /**</span>
<a name="l02448"></a>02448 <span class="comment">                         * @todo fix all cases and find why this happens</span>
<a name="l02449"></a>02449 <span class="comment">                         */</span>
<a name="l02450"></a>02450 
<a name="l02451"></a>02451                         if (!$in_priv_list || $typearr[1] == &#39;alpha_identifier&#39; || $typearr[1] == &#39;quote_single&#39; || $typearr[1] == &#39;white_newline&#39;) {
<a name="l02452"></a>02452                             $before    .= $space_alpha_reserved_word;
<a name="l02453"></a>02453                         }
<a name="l02454"></a>02454                     } else {
<a name="l02455"></a>02455                         // on first keyword, check if it introduces a
<a name="l02456"></a>02456                         // privilege list
<a name="l02457"></a>02457                         if (isset($keywords_priv_list[$arr[$i][&#39;data&#39;]])) {
<a name="l02458"></a>02458                             $in_priv_list = true;
<a name="l02459"></a>02459                         }
<a name="l02460"></a>02460                     }
<a name="l02461"></a>02461                 } else {
<a name="l02462"></a>02462                     $before    .= &#39; &#39;;
<a name="l02463"></a>02463                 }
<a name="l02464"></a>02464 
<a name="l02465"></a>02465                 switch ($arr[$i][&#39;data&#39;]) {
<a name="l02466"></a>02466                 case &#39;CREATE&#39;:
<a name="l02467"></a>02467                 case &#39;ALTER&#39;:
<a name="l02468"></a>02468                 case &#39;DROP&#39;:
<a name="l02469"></a>02469                 case &#39;RENAME&#39;;
<a name="l02470"></a>02470                 case &#39;TRUNCATE&#39;:
<a name="l02471"></a>02471                 case &#39;ANALYZE&#39;:
<a name="l02472"></a>02472                 case &#39;ANALYSE&#39;:
<a name="l02473"></a>02473                 case &#39;OPTIMIZE&#39;:
<a name="l02474"></a>02474                     if ($docu) {
<a name="l02475"></a>02475                         switch ($arr[$i + 1][&#39;data&#39;]) {
<a name="l02476"></a>02476                         case &#39;EVENT&#39;:
<a name="l02477"></a>02477                         case &#39;TABLE&#39;:
<a name="l02478"></a>02478                         case &#39;TABLESPACE&#39;:
<a name="l02479"></a>02479                         case &#39;FUNCTION&#39;:
<a name="l02480"></a>02480                         case &#39;INDEX&#39;:
<a name="l02481"></a>02481                         case &#39;PROCEDURE&#39;:
<a name="l02482"></a>02482                         case &#39;TRIGGER&#39;:
<a name="l02483"></a>02483                         case &#39;SERVER&#39;:
<a name="l02484"></a>02484                         case &#39;DATABASE&#39;:
<a name="l02485"></a>02485                         case &#39;VIEW&#39;:
<a name="l02486"></a>02486                             $before .= PMA_showMySQLDocu(&#39;SQL-Syntax&#39;, $arr[$i][&#39;data&#39;] . &#39;_&#39; . $arr[$i + 1][&#39;data&#39;], false, &#39;&#39;, true);
<a name="l02487"></a>02487                             $close_docu_link = true;
<a name="l02488"></a>02488                             break;
<a name="l02489"></a>02489                         }
<a name="l02490"></a>02490                         if ($arr[$i + 1][&#39;data&#39;] == &#39;LOGFILE&#39; &amp;&amp; $arr[$i + 2][&#39;data&#39;] == &#39;GROUP&#39;) {
<a name="l02491"></a>02491                             $before .= PMA_showMySQLDocu(&#39;SQL-Syntax&#39;, $arr[$i][&#39;data&#39;] . &#39;_LOGFILE_GROUP&#39;, false, &#39;&#39;, true);
<a name="l02492"></a>02492                             $close_docu_link = true;
<a name="l02493"></a>02493                         }
<a name="l02494"></a>02494                     }
<a name="l02495"></a>02495                     if (!$in_priv_list) {
<a name="l02496"></a>02496                         $space_punct_listsep       = $html_line_break;
<a name="l02497"></a>02497                         $space_alpha_reserved_word = &#39; &#39;;
<a name="l02498"></a>02498                     }
<a name="l02499"></a>02499                     break;
<a name="l02500"></a>02500                 case &#39;EVENT&#39;:
<a name="l02501"></a>02501                 case &#39;TABLESPACE&#39;:
<a name="l02502"></a>02502                 case &#39;TABLE&#39;:
<a name="l02503"></a>02503                 case &#39;FUNCTION&#39;:
<a name="l02504"></a>02504                 case &#39;INDEX&#39;:
<a name="l02505"></a>02505                 case &#39;PROCEDURE&#39;:
<a name="l02506"></a>02506                 case &#39;SERVER&#39;:
<a name="l02507"></a>02507                 case &#39;TRIGGER&#39;:
<a name="l02508"></a>02508                 case &#39;DATABASE&#39;:
<a name="l02509"></a>02509                 case &#39;VIEW&#39;:
<a name="l02510"></a>02510                 case &#39;GROUP&#39;:
<a name="l02511"></a>02511                     if ($close_docu_link) {
<a name="l02512"></a>02512                         $after = &#39;&lt;/a&gt;&#39; . $after;
<a name="l02513"></a>02513                         $close_docu_link = false;
<a name="l02514"></a>02514                     }
<a name="l02515"></a>02515                     break;
<a name="l02516"></a>02516                 case &#39;SET&#39;:
<a name="l02517"></a>02517                     if ($docu &amp;&amp; ($i == 0 || $arr[$i - 1][&#39;data&#39;] != &#39;CHARACTER&#39;)) {
<a name="l02518"></a>02518                         $before .= PMA_showMySQLDocu(&#39;SQL-Syntax&#39;, $arr[$i][&#39;data&#39;], false, &#39;&#39;, true);
<a name="l02519"></a>02519                         $after = &#39;&lt;/a&gt;&#39; . $after;
<a name="l02520"></a>02520                     }
<a name="l02521"></a>02521                     if (!$in_priv_list) {
<a name="l02522"></a>02522                         $space_punct_listsep       = $html_line_break;
<a name="l02523"></a>02523                         $space_alpha_reserved_word = &#39; &#39;;
<a name="l02524"></a>02524                     }
<a name="l02525"></a>02525                     break;
<a name="l02526"></a>02526                 case &#39;EXPLAIN&#39;:
<a name="l02527"></a>02527                 case &#39;DESCRIBE&#39;:
<a name="l02528"></a>02528                 case &#39;DELETE&#39;:
<a name="l02529"></a>02529                 case &#39;SHOW&#39;:
<a name="l02530"></a>02530                 case &#39;UPDATE&#39;:
<a name="l02531"></a>02531                     if ($docu) {
<a name="l02532"></a>02532                         $before .= PMA_showMySQLDocu(&#39;SQL-Syntax&#39;, $arr[$i][&#39;data&#39;], false, &#39;&#39;, true);
<a name="l02533"></a>02533                         $after = &#39;&lt;/a&gt;&#39; . $after;
<a name="l02534"></a>02534                     }
<a name="l02535"></a>02535                     if (!$in_priv_list) {
<a name="l02536"></a>02536                         $space_punct_listsep       = $html_line_break;
<a name="l02537"></a>02537                         $space_alpha_reserved_word = &#39; &#39;;
<a name="l02538"></a>02538                     }
<a name="l02539"></a>02539                     break;
<a name="l02540"></a>02540                 case &#39;INSERT&#39;:
<a name="l02541"></a>02541                 case &#39;REPLACE&#39;:
<a name="l02542"></a>02542                     if ($docu) {
<a name="l02543"></a>02543                         $before .= PMA_showMySQLDocu(&#39;SQL-Syntax&#39;, $arr[$i][&#39;data&#39;], false, &#39;&#39;, true);
<a name="l02544"></a>02544                         $after = &#39;&lt;/a&gt;&#39; . $after;
<a name="l02545"></a>02545                     }
<a name="l02546"></a>02546                     if (!$in_priv_list) {
<a name="l02547"></a>02547                         $space_punct_listsep       = $html_line_break;
<a name="l02548"></a>02548                         $space_alpha_reserved_word = $html_line_break;
<a name="l02549"></a>02549                     }
<a name="l02550"></a>02550                     break;
<a name="l02551"></a>02551                 case &#39;VALUES&#39;:
<a name="l02552"></a>02552                     $space_punct_listsep       = &#39; &#39;;
<a name="l02553"></a>02553                     $space_alpha_reserved_word = $html_line_break;
<a name="l02554"></a>02554                     break;
<a name="l02555"></a>02555                 case &#39;SELECT&#39;:
<a name="l02556"></a>02556                     if ($docu) {
<a name="l02557"></a>02557                         $before .= PMA_showMySQLDocu(&#39;SQL-Syntax&#39;, &#39;SELECT&#39;, false, &#39;&#39;, true);
<a name="l02558"></a>02558                         $after = &#39;&lt;/a&gt;&#39; . $after;
<a name="l02559"></a>02559                     }
<a name="l02560"></a>02560                     $space_punct_listsep       = &#39; &#39;;
<a name="l02561"></a>02561                     $space_alpha_reserved_word = $html_line_break;
<a name="l02562"></a>02562                     break;
<a name="l02563"></a>02563                 case &#39;CALL&#39;:
<a name="l02564"></a>02564                 case &#39;DO&#39;:
<a name="l02565"></a>02565                 case &#39;HANDLER&#39;:
<a name="l02566"></a>02566                     if ($docu) {
<a name="l02567"></a>02567                         $before .= PMA_showMySQLDocu(&#39;SQL-Syntax&#39;, $arr[$i][&#39;data&#39;], false, &#39;&#39;, true);
<a name="l02568"></a>02568                         $after = &#39;&lt;/a&gt;&#39; . $after;
<a name="l02569"></a>02569                     }
<a name="l02570"></a>02570                     break;
<a name="l02571"></a>02571                 default:
<a name="l02572"></a>02572                     if ($close_docu_link &amp;&amp; in_array($arr[$i][&#39;data&#39;], array(&#39;LIKE&#39;, &#39;NOT&#39;, &#39;IN&#39;, &#39;REGEXP&#39;, &#39;NULL&#39;))) {
<a name="l02573"></a>02573                         $after .= &#39;&lt;/a&gt;&#39;;
<a name="l02574"></a>02574                         $close_docu_link = false;
<a name="l02575"></a>02575                     } else if ($docu &amp;&amp; isset($PMA_SQPdata_functions_docs[$arr[$i][&#39;data&#39;]])) {
<a name="l02576"></a>02576                         /* Handle multi word statements first */
<a name="l02577"></a>02577                         if (isset($typearr[4]) &amp;&amp; $typearr[4] == &#39;alpha_reservedWord&#39; &amp;&amp; $typearr[3] == &#39;alpha_reservedWord&#39; &amp;&amp; isset($PMA_SQPdata_functions_docs[strtoupper($arr[$i][&#39;data&#39;] . &#39;_&#39; . $arr[$i + 1][&#39;data&#39;] . &#39;_&#39; . $arr[$i + 2][&#39;data&#39;])])) {
<a name="l02578"></a>02578                             $tempname = strtoupper($arr[$i][&#39;data&#39;] . &#39;_&#39; . $arr[$i + 1][&#39;data&#39;] . &#39;_&#39; . $arr[$i + 2][&#39;data&#39;]);
<a name="l02579"></a>02579                             $before .= PMA_showMySQLDocu(&#39;functions&#39;, $PMA_SQPdata_functions_docs[$tempname][&#39;link&#39;], false, $PMA_SQPdata_functions_docs[$tempname][&#39;anchor&#39;], true);
<a name="l02580"></a>02580                             $close_docu_link = true;
<a name="l02581"></a>02581                         } else if (isset($typearr[3]) &amp;&amp; $typearr[3] == &#39;alpha_reservedWord&#39; &amp;&amp; isset($PMA_SQPdata_functions_docs[strtoupper($arr[$i][&#39;data&#39;] . &#39;_&#39; . $arr[$i + 1][&#39;data&#39;])])) {
<a name="l02582"></a>02582                             $tempname = strtoupper($arr[$i][&#39;data&#39;] . &#39;_&#39; . $arr[$i + 1][&#39;data&#39;]);
<a name="l02583"></a>02583                             $before .= PMA_showMySQLDocu(&#39;functions&#39;, $PMA_SQPdata_functions_docs[$tempname][&#39;link&#39;], false, $PMA_SQPdata_functions_docs[$tempname][&#39;anchor&#39;], true);
<a name="l02584"></a>02584                             $close_docu_link = true;
<a name="l02585"></a>02585                         } else {
<a name="l02586"></a>02586                             $before .= PMA_showMySQLDocu(&#39;functions&#39;, $PMA_SQPdata_functions_docs[$arr[$i][&#39;data&#39;]][&#39;link&#39;], false, $PMA_SQPdata_functions_docs[$arr[$i][&#39;data&#39;]][&#39;anchor&#39;], true);
<a name="l02587"></a>02587                             $after .= &#39;&lt;/a&gt;&#39;;
<a name="l02588"></a>02588                         }
<a name="l02589"></a>02589                     }
<a name="l02590"></a>02590                     break;
<a name="l02591"></a>02591                 } // end switch ($arr[$i][&#39;data&#39;])
<a name="l02592"></a>02592 
<a name="l02593"></a>02593                 $after         .= &#39; &#39;;
<a name="l02594"></a>02594                 break;
<a name="l02595"></a>02595             case &#39;digit_integer&#39;:
<a name="l02596"></a>02596             case &#39;digit_float&#39;:
<a name="l02597"></a>02597             case &#39;digit_hex&#39;:<span class="comment"></span>
<a name="l02598"></a>02598 <span class="comment">                /**</span>
<a name="l02599"></a>02599 <span class="comment">                 * @todo could there be other types preceding a digit?</span>
<a name="l02600"></a>02600 <span class="comment">                 */</span>
<a name="l02601"></a>02601                 if ($typearr[1] == &#39;alpha_reservedWord&#39;) {
<a name="l02602"></a>02602                     $after .= &#39; &#39;;
<a name="l02603"></a>02603                 }
<a name="l02604"></a>02604                 if ($infunction &amp;&amp; $typearr[3] == &#39;punct_bracket_close_round&#39;) {
<a name="l02605"></a>02605                     $after     .= &#39; &#39;;
<a name="l02606"></a>02606                 }
<a name="l02607"></a>02607                 if ($typearr[1] == &#39;alpha_columnAttrib&#39;) {
<a name="l02608"></a>02608                     $before .= &#39; &#39;;
<a name="l02609"></a>02609                 }
<a name="l02610"></a>02610                 break;
<a name="l02611"></a>02611             case &#39;alpha_variable&#39;:
<a name="l02612"></a>02612                 $after      = &#39; &#39;;
<a name="l02613"></a>02613                 break;
<a name="l02614"></a>02614             case &#39;quote_double&#39;:
<a name="l02615"></a>02615             case &#39;quote_single&#39;:
<a name="l02616"></a>02616                 // workaround: for the query
<a name="l02617"></a>02617                 // REVOKE SELECT ON `base2\_db`.* FROM &#39;user&#39;@&#39;%&#39;
<a name="l02618"></a>02618                 // the @ is incorrectly marked as alpha_variable
<a name="l02619"></a>02619                 // in the parser, and here, the &#39;%&#39; gets a blank before,
<a name="l02620"></a>02620                 // which is a syntax error
<a name="l02621"></a>02621                 if ($typearr[1] != &#39;punct_user&#39; &amp;&amp; $typearr[1] != &#39;alpha_bitfield_constant_introducer&#39;) {
<a name="l02622"></a>02622                     $before        .= &#39; &#39;;
<a name="l02623"></a>02623                 }
<a name="l02624"></a>02624                 if ($infunction &amp;&amp; $typearr[3] == &#39;punct_bracket_close_round&#39;) {
<a name="l02625"></a>02625                     $after     .= &#39; &#39;;
<a name="l02626"></a>02626                 }
<a name="l02627"></a>02627                 break;
<a name="l02628"></a>02628             case &#39;quote_backtick&#39;:
<a name="l02629"></a>02629                 // here we check for punct_user to handle correctly
<a name="l02630"></a>02630                 // DEFINER = `username`@`%`
<a name="l02631"></a>02631                 // where @ is the punct_user and `%` is the quote_backtick
<a name="l02632"></a>02632                 if ($typearr[3] != &#39;punct_qualifier&#39; &amp;&amp; $typearr[3] != &#39;alpha_variable&#39; &amp;&amp; $typearr[3] != &#39;punct_user&#39;) {
<a name="l02633"></a>02633                     $after     .= &#39; &#39;;
<a name="l02634"></a>02634                 }
<a name="l02635"></a>02635                 if ($typearr[1] != &#39;punct_qualifier&#39; &amp;&amp; $typearr[1] != &#39;alpha_variable&#39; &amp;&amp; $typearr[1] != &#39;punct_user&#39;) {
<a name="l02636"></a>02636                     $before    .= &#39; &#39;;
<a name="l02637"></a>02637                 }
<a name="l02638"></a>02638                 break;
<a name="l02639"></a>02639             default:
<a name="l02640"></a>02640                 break;
<a name="l02641"></a>02641             } // end switch ($typearr[2])
<a name="l02642"></a>02642 
<a name="l02643"></a>02643             /*
<a name="l02644"></a>02644             if ($typearr[3] != &#39;punct_qualifier&#39;) {
<a name="l02645"></a>02645                 $after             .= &#39; &#39;;
<a name="l02646"></a>02646             }
<a name="l02647"></a>02647             $after                 .= &quot;\n&quot;;
<a name="l02648"></a>02648             */
<a name="l02649"></a>02649             $str .= $before;
<a name="l02650"></a>02650             if ($mode==&#39;color&#39;) {
<a name="l02651"></a>02651                 $str .= PMA_SQP_formatHTML_colorize($arr[$i]);
<a name="l02652"></a>02652             } elseif ($mode == &#39;text&#39;) {
<a name="l02653"></a>02653                 $str .= htmlspecialchars($arr[$i][&#39;data&#39;]);
<a name="l02654"></a>02654             } else {
<a name="l02655"></a>02655                 $str .= $arr[$i][&#39;data&#39;];
<a name="l02656"></a>02656             }
<a name="l02657"></a>02657             $str .= $after;
<a name="l02658"></a>02658         } // end for
<a name="l02659"></a>02659         // close unclosed indent levels
<a name="l02660"></a>02660         while ($indent &gt; 0) {
<a name="l02661"></a>02661             $indent--;
<a name="l02662"></a>02662             $str .= ($mode != &#39;query_only&#39; ? &#39;&lt;/div&gt;&#39; : &#39; &#39;);
<a name="l02663"></a>02663         }
<a name="l02664"></a>02664         /* End possibly unclosed documentation link */
<a name="l02665"></a>02665         if ($close_docu_link) {
<a name="l02666"></a>02666             $str .= &#39;&lt;/a&gt;&#39;;
<a name="l02667"></a>02667             $close_docu_link = false;
<a name="l02668"></a>02668         }
<a name="l02669"></a>02669         if ($mode!=&#39;query_only&#39;) {
<a name="l02670"></a>02670             // close inner_sql span
<a name="l02671"></a>02671                 $str .= &#39;&lt;/span&gt;&#39;;
<a name="l02672"></a>02672         }
<a name="l02673"></a>02673         if ($mode==&#39;color&#39;) {
<a name="l02674"></a>02674             // close syntax span
<a name="l02675"></a>02675             $str .= &#39;&lt;/span&gt;&#39;;
<a name="l02676"></a>02676         }
<a name="l02677"></a>02677 
<a name="l02678"></a>02678         return $str;
<a name="l02679"></a>02679     } // end of the &quot;PMA_SQP_formatHtml()&quot; function
<a name="l02680"></a>02680 }
<a name="l02681"></a>02681 <span class="comment"></span>
<a name="l02682"></a>02682 <span class="comment">/**</span>
<a name="l02683"></a>02683 <span class="comment"> * Builds a CSS rule used for html formatted SQL queries</span>
<a name="l02684"></a>02684 <span class="comment"> *</span>
<a name="l02685"></a>02685 <span class="comment"> * @param string  The class name</span>
<a name="l02686"></a>02686 <span class="comment"> * @param string  The property name</span>
<a name="l02687"></a>02687 <span class="comment"> * @param string  The property value</span>
<a name="l02688"></a>02688 <span class="comment"> *</span>
<a name="l02689"></a>02689 <span class="comment"> * @return string  The CSS rule</span>
<a name="l02690"></a>02690 <span class="comment"> *</span>
<a name="l02691"></a>02691 <span class="comment"> * @access public</span>
<a name="l02692"></a>02692 <span class="comment"> *</span>
<a name="l02693"></a>02693 <span class="comment"> * @see    PMA_SQP_buildCssData()</span>
<a name="l02694"></a>02694 <span class="comment"> */</span>
<a name="l02695"></a><a class="code" href="sqlparser_8lib_8php.html#ae9a3c9ae523645aecb01d2cda61ec6ed">02695</a> function PMA_SQP_buildCssRule($classname, $property, $value)
<a name="l02696"></a>02696 {
<a name="l02697"></a>02697     $str     = &#39;.&#39; . $classname . &#39; {&#39;;
<a name="l02698"></a>02698     if ($value != &#39;&#39;) {
<a name="l02699"></a>02699         $str .= $property . &#39;: &#39; . $value . &#39;;&#39;;
<a name="l02700"></a>02700     }
<a name="l02701"></a>02701     $str     .= &#39;}&#39; . &quot;\n&quot;;
<a name="l02702"></a>02702 
<a name="l02703"></a>02703     return $str;
<a name="l02704"></a>02704 } // end of the &quot;PMA_SQP_buildCssRule()&quot; function
<a name="l02705"></a>02705 
<a name="l02706"></a>02706 <span class="comment"></span>
<a name="l02707"></a>02707 <span class="comment">/**</span>
<a name="l02708"></a>02708 <span class="comment"> * Builds CSS rules used for html formatted SQL queries</span>
<a name="l02709"></a>02709 <span class="comment"> *</span>
<a name="l02710"></a>02710 <span class="comment"> * @return string  The CSS rules set</span>
<a name="l02711"></a>02711 <span class="comment"> *</span>
<a name="l02712"></a>02712 <span class="comment"> * @access public</span>
<a name="l02713"></a>02713 <span class="comment"> *</span>
<a name="l02714"></a>02714 <span class="comment"> * @global array   The current PMA configuration</span>
<a name="l02715"></a>02715 <span class="comment"> *</span>
<a name="l02716"></a>02716 <span class="comment"> * @see    PMA_SQP_buildCssRule()</span>
<a name="l02717"></a>02717 <span class="comment"> */</span>
<a name="l02718"></a><a class="code" href="sqlparser_8lib_8php.html#ae5d685b675a3060642c25c73834ff4c9">02718</a> function PMA_SQP_buildCssData()
<a name="l02719"></a>02719 {
<a name="l02720"></a>02720     global $cfg;
<a name="l02721"></a>02721 
<a name="l02722"></a>02722     $css_string     = &#39;&#39;;
<a name="l02723"></a>02723     foreach ($cfg[&#39;SQP&#39;][&#39;fmtColor&#39;] AS $key =&gt; $col) {
<a name="l02724"></a>02724         $css_string .= PMA_SQP_buildCssRule(&#39;syntax_&#39; . $key, &#39;color&#39;, $col);
<a name="l02725"></a>02725     }
<a name="l02726"></a>02726 
<a name="l02727"></a>02727     for ($i = 0; $i &lt; 8; $i++) {
<a name="l02728"></a>02728         $css_string .= PMA_SQP_buildCssRule(
<a name="l02729"></a>02729             &#39;syntax_indent&#39; . $i, &#39;margin-left&#39;,
<a name="l02730"></a>02730             ($i * $cfg[&#39;SQP&#39;][&#39;fmtInd&#39;]) . $cfg[&#39;SQP&#39;][&#39;fmtIndUnit&#39;]);
<a name="l02731"></a>02731     }
<a name="l02732"></a>02732 
<a name="l02733"></a>02733     return $css_string;
<a name="l02734"></a>02734 } // end of the &quot;PMA_SQP_buildCssData()&quot; function
<a name="l02735"></a>02735 
<a name="l02736"></a>02736 if (! defined(&#39;PMA_MINIMUM_COMMON&#39;)) {<span class="comment"></span>
<a name="l02737"></a>02737 <span class="comment">    /**</span>
<a name="l02738"></a>02738 <span class="comment">     * Gets SQL queries with no format</span>
<a name="l02739"></a>02739 <span class="comment">     *</span>
<a name="l02740"></a>02740 <span class="comment">     * @param array   The SQL queries list</span>
<a name="l02741"></a>02741 <span class="comment">     *</span>
<a name="l02742"></a>02742 <span class="comment">     * @return string  The SQL queries with no format</span>
<a name="l02743"></a>02743 <span class="comment">     *</span>
<a name="l02744"></a>02744 <span class="comment">     * @access public</span>
<a name="l02745"></a>02745 <span class="comment">     */</span>
<a name="l02746"></a>02746     function PMA_SQP_formatNone($arr)
<a name="l02747"></a>02747     {
<a name="l02748"></a>02748         $formatted_sql = htmlspecialchars($arr[&#39;raw&#39;]);
<a name="l02749"></a>02749         $formatted_sql = preg_replace(
<a name="l02750"></a>02750             &quot;@((\015\012)|(\015)|(\012)){3,}@&quot;,
<a name="l02751"></a>02751             &quot;\n\n&quot;,
<a name="l02752"></a>02752             $formatted_sql);
<a name="l02753"></a>02753 
<a name="l02754"></a>02754         return $formatted_sql;
<a name="l02755"></a>02755     } // end of the &quot;PMA_SQP_formatNone()&quot; function
<a name="l02756"></a>02756 
<a name="l02757"></a>02757 } // end if: minimal common.lib needed?
<a name="l02758"></a>02758 
<a name="l02759"></a>02759 ?&gt;
</pre></div></div><!-- contents -->
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="sqlparser_8lib_8php.html">sqlparser.lib.php</a>      </li>

    <li class="footer">Generated on Fri Mar 14 2014 04:14:50 for RFSCMSAPIDocumentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
